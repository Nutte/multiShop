This file is a merged representation of a subset of the codebase, containing specifically included files, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: app/Models/**/*, app/Http/Controllers/**/*
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
app/
  Http/
    Controllers/
      Admin/
        AttributeController.php
        AuthController.php
        CategoryController.php
        ClothingLineController.php
        ContactMessageController.php
        DashboardController.php
        InventoryController.php
        ManagerController.php
        OrderController.php
        ProductController.php
        PromoCodeController.php
        ReportController.php
        SettingsController.php
        TelegramSettingsController.php
        UserController.php
      Api/
        ProductController.php
      Client/
        AuthController.php
        ContactController.php
        ProfileController.php
      CartController.php
      Controller.php
      ShopController.php
  Models/
    AttributeOption.php
    Category.php
    ClothingLine.php
    ContactMessage.php
    Order.php
    OrderItem.php
    Product.php
    ProductImage.php
    ProductVariant.php
    PromoCode.php
    TelegramConfig.php
    TenantSetting.php
    User.php
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="app/Http/Controllers/Admin/AuthController.php">
<?php
// FILE: app/Http/Controllers/Admin/AuthController.php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;

class AuthController extends Controller
{
    public function showLoginForm()
    {
        if (Auth::check()) {
            return redirect()->route('admin.dashboard');
        }
        return view('admin.auth.login');
    }

    public function login(Request $request)
    {
        $credentials = $request->validate([
            'email' => ['required', 'email'],
            'password' => ['required'],
        ]);

        // –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞ –≤ –¢–ï–ö–£–©–ï–ô —Å—Ö–µ–º–µ
        // –¢–∞–∫ –∫–∞–∫ –ê–¥–º–∏–Ω —Ç–µ–ø–µ—Ä—å –µ—Å—Ç—å –≤–µ–∑–¥–µ, —ç—Ç–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è –∞–¥–º–∏–Ω–∞, –∏ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞
        if (Auth::attempt($credentials)) {
            $request->session()->regenerate();

            $user = Auth::user();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–ª–∞–≥ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞ –≤ —Å–µ—Å—Å–∏—é –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –≤ Blade
            if ($user->role === 'super_admin') {
                $request->session()->put('is_super_admin', true);
            } else {
                $request->session()->put('is_super_admin', false);
            }

            return redirect()->route('admin.dashboard');
        }

        return back()->withErrors([
            'email' => 'The provided credentials do not match our records.',
        ]);
    }

    public function logout(Request $request)
    {
        Auth::logout();
        $request->session()->invalidate();
        $request->session()->regenerateToken();
        return redirect()->route('admin.login');
    }
}
</file>

<file path="app/Http/Controllers/Admin/ClothingLineController.php">
<?php
// FILE: app/Http/Controllers/Admin/ClothingLineController.php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\ClothingLine;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Support\Str;

class ClothingLineController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    // –•–µ–ª–ø–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥—Ä—É–≥–∏–º –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞–º)
    private function resolveContext(Request $request)
    {
        if (auth()->user()->role !== 'super_admin') {
            return $this->tenantService->getCurrentTenantId();
        }

        // –î–µ—Ñ–æ–ª—Ç –∏–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω
        $tenantId = $request->tenant_id ?? array_key_first(config('tenants.tenants'));
        
        if ($tenantId) {
            $this->tenantService->switchTenant($tenantId);
        }
        
        return $tenantId;
    }

    public function index(Request $request)
    {
        $currentTenantId = $this->resolveContext($request);
        
        $query = ClothingLine::withCount('products');
        
        if ($request->filled('search')) {
            $query->where('name', 'ilike', "%{$request->search}%");
        }

        $lines = $query->orderBy('name')->get();

        return view('admin.clothing_lines.index', compact('lines', 'currentTenantId'));
    }

    public function store(Request $request)
    {
        $this->resolveContext($request);
        
        $validated = $request->validate(['name' => 'required|string|max:255']);
        $slug = Str::slug($validated['name']);

        ClothingLine::firstOrCreate(
            ['slug' => $slug],
            ['name' => $validated['name']]
        );

        return back()->with('success', 'Collection created/found.');
    }

    public function update(Request $request, $id)
    {
        $this->resolveContext($request);
        $line = ClothingLine::findOrFail($id);
        
        $validated = $request->validate(['name' => 'required|string|max:255']);
        
        try {
            $line->update([
                'name' => $validated['name'],
                'slug' => Str::slug($validated['name'])
            ]);
        } catch (\Exception $e) {
            return back()->with('error', 'Collection with this name already exists.');
        }
        
        return back()->with('success', 'Collection updated.');
    }

    public function destroy(Request $request, $id)
    {
        $this->resolveContext($request);
        ClothingLine::destroy($id);
        return back()->with('success', 'Collection deleted.');
    }
}
</file>

<file path="app/Http/Controllers/Admin/ContactMessageController.php">
<?php

// FILE: app/Http/Controllers/Admin/ContactMessageController.php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\ContactMessage;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Pagination\LengthAwarePaginator;

class ContactMessageController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    public function index(Request $request)
    {
        $user = auth()->user();
        $isSuperAdmin = $user->role === 'super_admin';
        
        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
        $currentTenantId = null;
        if ($isSuperAdmin) {
            $currentTenantId = $request->get('tenant_id');
        } else {
            $currentTenantId = $this->tenantService->getCurrentTenantId();
        }

        $messages = collect();
        $paginatedMessages = null;

        if ($currentTenantId) {
            // 1. –ö–û–ù–ö–†–ï–¢–ù–´–ô –ú–ê–ì–ê–ó–ò–ù
            $this->tenantService->switchTenant($currentTenantId);
            $paginatedMessages = ContactMessage::latest()->paginate(20);
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ—É –æ –º–∞–≥–∞–∑–∏–Ω–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            $paginatedMessages->getCollection()->transform(function ($msg) use ($currentTenantId) {
                $msg->tenant_id = $currentTenantId;
                $msg->tenant_name = config("tenants.tenants.{$currentTenantId}.name");
                return $msg;
            });
        } else {
            // 2. –í–°–ï –ú–ê–ì–ê–ó–ò–ù–´ (–¢–æ–ª—å–∫–æ –°—É–ø–µ—Ä-–ê–¥–º–∏–Ω)
            // –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ –≤—Å–µ—Ö —Å—Ö–µ–º
            $allMessages = collect();
            
            foreach (config('tenants.tenants') as $id => $config) {
                try {
                    $this->tenantService->switchTenant($id);
                    // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 20 –∏–∑ –∫–∞–∂–¥–æ–≥–æ, —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å –ø–∞–º—è—Ç—å
                    $tenantMessages = ContactMessage::latest()->limit(20)->get();
                    
                    foreach ($tenantMessages as $msg) {
                        $msg->tenant_id = $id;
                        $msg->tenant_name = $config['name'];
                        $allMessages->push($msg);
                    }
                } catch (\Exception $e) {
                    continue;
                }
            }

            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ —Å–æ–±—Ä–∞–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ –¥–∞—Ç–µ
            $sorted = $allMessages->sortByDesc('created_at')->values();
            
            // –†—É—á–Ω–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏
            $perPage = 20;
            $page = $request->get('page', 1);
            $paginatedMessages = new LengthAwarePaginator(
                $sorted->forPage($page, $perPage),
                $sorted->count(),
                $perPage,
                $page,
                ['path' => $request->url(), 'query' => $request->query()]
            );
        }

        return view('admin.messages.index', [
            'messages' => $paginatedMessages,
            'currentTenantId' => $currentTenantId
        ]);
    }

    // –ü–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ / –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å
    public function show(Request $request, $id)
    {
        // –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –Ω—É–∂–Ω–æ –∑–Ω–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–∞–≥–∞–∑–∏–Ω–∞
        $tenantId = $request->get('tenant_id');
        if (!$tenantId) {
            // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –ø—ã—Ç–∞–µ–º—Å—è –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞
            if (auth()->user()->role !== 'super_admin') {
                $tenantId = $this->tenantService->getCurrentTenantId();
            } else {
                return back()->with('error', 'Tenant ID required to view message.');
            }
        }

        $this->tenantService->switchTenant($tenantId);
        $message = ContactMessage::findOrFail($id);
        
        // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
        if (!$message->is_read) {
            $message->update(['is_read' => true]);
        }

        return view('admin.messages.show', compact('message', 'tenantId'));
    }

    public function destroy(Request $request, $id)
    {
        $tenantId = $request->get('tenant_id');
        if (auth()->user()->role !== 'super_admin' && !$tenantId) {
             $tenantId = $this->tenantService->getCurrentTenantId();
        }

        $this->tenantService->switchTenant($tenantId);
        ContactMessage::destroy($id);

        return redirect()->route('admin.messages.index', ['tenant_id' => $tenantId])
            ->with('success', 'Message deleted.');
    }
}
</file>

<file path="app/Http/Controllers/Admin/InventoryController.php">
<?php
// FILE: app/Http/Controllers/Admin/InventoryController.php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Product;
use App\Models\Category;
use App\Models\ClothingLine;
use App\Models\TelegramConfig; // –ò–º–ø–æ—Ä—Ç –º–æ–¥–µ–ª–∏ Telegram
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Support\Collection;
use Illuminate\Support\Facades\Http;
use Illuminate\Pagination\LengthAwarePaginator;
use Symfony\Component\HttpFoundation\StreamedResponse;

class InventoryController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    private function resolveContext(Request $request)
    {
        $user = auth()->user();
        if ($user->role !== 'super_admin') {
            return $this->tenantService->getCurrentTenantId();
        }
        $tenantId = $request->get('tenant_id');
        if ($tenantId) {
            $this->tenantService->switchTenant($tenantId);
            return $tenantId;
        }
        
        // –ï—Å–ª–∏ –°—É–ø–µ—Ä-–ê–¥–º–∏–Ω –Ω–µ –≤—ã–±—Ä–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null (–∑–Ω–∞—á–∏—Ç "–í—Å–µ –º–∞–≥–∞–∑–∏–Ω—ã")
        // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç —É–∂–µ –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω middleware, —Å–±—Ä–∞—Å—ã–≤–∞–µ–º –µ–≥–æ –¥–ª—è –ª–æ–≥–∏–∫–∏ "–í—Å–µ—Ö"
        if ($request->has('tenant_id') && empty($request->tenant_id)) {
            return null;
        }

        return $this->tenantService->getCurrentTenantId();
    }

    public function index(Request $request)
    {
        $currentTenantId = $this->resolveContext($request);
        $isSuperAdmin = auth()->user()->role === 'super_admin';
        
        // –ü–æ–ª—É—á–∞–µ–º –±–æ—Ç–æ–≤ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
        $telegramBots = $isSuperAdmin 
            ? TelegramConfig::where('is_active', true)->get() 
            : TelegramConfig::where('tenant_id', $currentTenantId)->orWhereNull('tenant_id')->where('is_active', true)->get();

        // –õ–æ–≥–∏–∫–∞ —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö
        $products = new Collection();
        $isGlobalView = $isSuperAdmin && empty($currentTenantId);

        if ($isGlobalView) {
            // –°–æ–±–∏—Ä–∞–µ–º —Å–æ –≤—Å–µ—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤
            foreach (config('tenants.tenants') as $id => $config) {
                try {
                    $this->tenantService->switchTenant($id);
                    $storeProducts = $this->getFilteredQuery($request)->latest()->take(50)->get();
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫—É –º–∞–≥–∞–∑–∏–Ω–∞
                    $storeProducts->each(function($p) use ($config) {
                        $p->tenant_name = $config['name'];
                    });
                    
                    $products = $products->merge($storeProducts);
                } catch (\Exception $e) { continue; }
            }
            // –†—É—á–Ω–∞—è –ø–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏ (–¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã)
            $page = $request->get('page', 1);
            $perPage = 50;
            $products = new LengthAwarePaginator(
                $products->forPage($page, $perPage), 
                $products->count(), 
                $perPage, 
                $page, 
                ['path' => $request->url(), 'query' => $request->query()]
            );
        } else {
            // –û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º –æ–¥–Ω–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞
            $products = $this->getFilteredQuery($request)->latest()->paginate(50)->withQueryString();
        }

        // --- EXPORT LOGIC ---
        if ($request->get('action') === 'export_csv') {
            // –î–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –±–µ—Ä–µ–º –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –±–µ–∑ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
            $exportData = $isGlobalView ? $this->getAllTenantsData($request) : $this->getFilteredQuery($request)->get();
            return $this->exportCsv($exportData, $currentTenantId ?? 'All_Stores');
        }

        // Load filters (—Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω, –∏–Ω–∞—á–µ —Å–ø–∏—Å–∫–∏ –ø—É—Å—Ç—ã–µ)
        $categories = $currentTenantId ? Category::orderBy('name')->get() : collect();
        $lines = $currentTenantId ? ClothingLine::orderBy('name')->get() : collect();

        return view('admin.inventory.index', compact('products', 'categories', 'lines', 'currentTenantId', 'telegramBots'));
    }

    /**
     * –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á–µ—Ç–∞ –≤ Telegram
     */
    public function sendToTelegram(Request $request)
    {
        $request->validate([
            'telegram_config_id' => 'required|exists:public.telegram_configs,id',
        ]);

        $config = TelegramConfig::findOrFail($request->telegram_config_id);
        $currentTenantId = $this->resolveContext($request);
        $isGlobalView = auth()->user()->role === 'super_admin' && empty($currentTenantId);

        // 1. –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        $data = $isGlobalView ? $this->getAllTenantsData($request) : $this->getFilteredQuery($request)->get();
        
        // 2. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º CSV –∫–æ–Ω—Ç–µ–Ω—Ç (—Å—Ç—Ä–æ–∫–∞)
        $csvContent = $this->generateCsvString($data);
        $fileName = 'inventory_report_' . date('Y-m-d_H-i') . '.csv';

        // 3. –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        $totalItems = $data->sum('stock_quantity');
        $totalValue = $data->sum(fn($p) => $p->stock_quantity * ($p->sale_price ?? $p->price));
        
        $message = "üìä *Inventory Report*\n" .
                   "Store: " . ($currentTenantId ?? 'ALL STORES') . "\n" .
                   "Date: " . date('Y-m-d H:i') . "\n" .
                   "Total Items: *{$totalItems}*\n" .
                   "Total Value: *$" . number_format($totalValue, 2) . "*";

        // 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ Telegram API (multipart/form-data)
        try {
            // –°–Ω–∞—á–∞–ª–∞ —Ç–µ–∫—Å—Ç
            Http::post("https://api.telegram.org/bot{$config->bot_token}/sendMessage", [
                'chat_id' => $config->chat_id,
                'text' => $message,
                'parse_mode' => 'Markdown',
            ]);

            // –ü–æ—Ç–æ–º —Ñ–∞–π–ª
            $response = Http::attach(
                'document', $csvContent, $fileName
            )->post("https://api.telegram.org/bot{$config->bot_token}/sendDocument", [
                'chat_id' => $config->chat_id,
                'caption' => 'üìÇ Full report attached (Excel compatible)',
            ]);

            if ($response->successful()) {
                return back()->with('success', 'Report sent to Telegram successfully.');
            } else {
                return back()->with('error', 'Telegram Error: ' . $response->body());
            }

        } catch (\Exception $e) {
            return back()->with('error', 'Failed to send: ' . $e->getMessage());
        }
    }

    // --- HELPERS ---

    private function getFilteredQuery(Request $request)
    {
        $query = Product::with(['categories', 'variants', 'clothingLine']);

        if ($request->filled('search')) {
            $query->where(fn($q) => $q->where('name', 'ilike', "%{$request->search}%")
                                      ->orWhere('sku', 'ilike', "%{$request->search}%"));
        }
        if ($request->filled('category_id')) {
            $query->whereHas('categories', fn($q) => $q->where('categories.id', $request->category_id));
        }
        if ($request->filled('clothing_line_id')) {
            $query->where('clothing_line_id', $request->clothing_line_id);
        }
        if ($request->filled('stock_status')) {
            if ($request->stock_status === 'out_of_stock') {
                $query->where('stock_quantity', '<=', 0);
            } elseif ($request->stock_status === 'low_stock') {
                $query->where('stock_quantity', '>', 0)->where('stock_quantity', '<', 5);
            } elseif ($request->stock_status === 'in_stock') {
                $query->where('stock_quantity', '>=', 5);
            }
        }
        return $query;
    }

    private function getAllTenantsData(Request $request)
    {
        $allData = new Collection();
        foreach (config('tenants.tenants') as $id => $config) {
            try {
                $this->tenantService->switchTenant($id);
                $products = $this->getFilteredQuery($request)->get();
                $products->each(function($p) use ($config) {
                    $p->tenant_name = $config['name'];
                });
                $allData = $allData->merge($products);
            } catch (\Exception $e) { continue; }
        }
        return $allData;
    }

    private function generateCsvString(Collection $products)
    {
        $output = fopen('php://temp', 'r+');
        fputs($output, "\xEF\xBB\xBF"); // BOM
        fputcsv($output, ['Store', 'SKU', 'Product Name', 'Category', 'Collection', 'Size Variants', 'Price', 'Stock', 'Value']);

        foreach ($products as $product) {
            $variantsStr = $product->variants->map(fn($v) => "{$v->size}: {$v->stock}")->join(' | ');
            $categoriesStr = $product->categories->pluck('name')->join(', ');
            $totalValue = $product->stock_quantity * ($product->sale_price ?? $product->price);
            
            fputcsv($output, [
                $product->tenant_name ?? 'Current',
                $product->sku,
                $product->name,
                $categoriesStr,
                $product->clothingLine->name ?? '-',
                $variantsStr ?: 'One Size',
                $product->price,
                $product->stock_quantity,
                number_format($totalValue, 2, '.', '')
            ]);
        }
        rewind($output);
        $content = stream_get_contents($output);
        fclose($output);
        return $content;
    }

    private function exportCsv(Collection $products, string $name)
    {
        $content = $this->generateCsvString($products);
        return response($content)
            ->header('Content-Type', 'text/csv')
            ->header('Content-Disposition', 'attachment; filename="inventory_' . $name . '.csv"');
    }
}
</file>

<file path="app/Http/Controllers/Admin/ManagerController.php">
<?php

//  File (app/Http/Controllers/Admin/ManagerController.php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\User;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Hash;
use Illuminate\Validation\Rule;

class ManagerController extends Controller
{
    public function index()
    {
        $managers = User::where('role', 'manager')->latest()->get();
        return view('admin.managers.index', compact('managers'));
    }

    public function create()
    {
        $tenants = config('tenants.tenants');
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –µ–¥–∏–Ω—É—é —Ñ–æ—Ä–º—É. –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è $manager –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è, —à–∞–±–ª–æ–Ω –ø–æ–π–º–µ—Ç, —á—Ç–æ —ç—Ç–æ —Å–æ–∑–¥–∞–Ω–∏–µ.
        return view('admin.managers.form', compact('tenants'));
    }

    public function store(Request $request)
    {
        $validated = $request->validate([
            'name' => 'required|string|max:255',
            'email' => 'required|email|unique:users,email',
            'phone' => 'required|string|max:20',
            'password' => 'required|string|min:8',
            'tenant_id' => 'required|string',
        ]);

        User::create([
            'name' => $validated['name'],
            'email' => $validated['email'],
            'phone' => $validated['phone'],
            'password' => Hash::make($validated['password']),
            'role' => 'manager',
            'tenant_id' => $validated['tenant_id'],
        ]);

        return redirect()->route('admin.managers.index')->with('success', 'Manager created successfully.');
    }

    public function edit($id)
    {
        $manager = User::where('role', 'manager')->findOrFail($id);
        $tenants = config('tenants.tenants');
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ —Ñ–æ—Ä–º—É, –Ω–æ –ø–µ—Ä–µ–¥–∞–µ–º $manager –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        return view('admin.managers.form', compact('manager', 'tenants'));
    }

    public function update(Request $request, $id)
    {
        $manager = User::where('role', 'manager')->findOrFail($id);

        $validated = $request->validate([
            'name' => 'required|string|max:255',
            'email' => ['required', 'email', Rule::unique('users')->ignore($manager->id)],
            'phone' => 'required|string|max:20',
            'password' => 'nullable|string|min:8',
            'tenant_id' => 'required|string',
        ]);

        $data = [
            'name' => $validated['name'],
            'email' => $validated['email'],
            'phone' => $validated['phone'],
            'tenant_id' => $validated['tenant_id'],
        ];

        if ($request->filled('password')) {
            $data['password'] = Hash::make($validated['password']);
        }

        $manager->update($data);

        return redirect()->route('admin.managers.index')->with('success', 'Manager updated successfully.');
    }

    public function destroy($id)
    {
        $manager = User::where('role', 'manager')->findOrFail($id);
        $manager->delete();

        return back()->with('success', 'Manager deleted.');
    }
}
</file>

<file path="app/Http/Controllers/Admin/PromoCodeController.php">
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\PromoCode;
use App\Models\Product;
use App\Models\Category;
use App\Models\ClothingLine;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str; // –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ç—Ä–æ–∫–∞–º–∏
use Illuminate\Validation\Rule;

class PromoCodeController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    private function checkSuperAdmin()
    {
        if (auth()->user()->role !== 'super_admin') {
            abort(403, 'Access denied. Only Super Admin can manage promo codes.');
        }
    }

    public function index()
    {
        $this->checkSuperAdmin();
        $promocodes = PromoCode::latest()->get();
        return view('admin.promocodes.index', compact('promocodes'));
    }

    public function create()
    {
        $this->checkSuperAdmin();

        $catalogData = [];
        $tenants = config('tenants.tenants');

        foreach ($tenants as $id => $config) {
            try {
                $this->tenantService->switchTenant($id);
                
                $catalogData[$id] = [
                    'name' => $config['name'],
                    'products' => Product::select('id', 'name', 'sku')->orderBy('name')->get()->toArray(),
                    'categories' => Category::select('id', 'name', 'slug')->orderBy('name')->get()->toArray(),
                    'lines' => ClothingLine::select('id', 'name', 'slug')->orderBy('name')->get()->toArray(),
                ];
            } catch (\Exception $e) {
                continue;
            }
        }

        return view('admin.promocodes.create', compact('catalogData'));
    }

    /**
     * Store a newly created promo code.
     */
    public function store(Request $request)
    {
        $this->checkSuperAdmin();

        // –ù–û–†–ú–ê–õ–ò–ó–ê–¶–ò–Ø: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–≤–æ–¥–∏–º –∫–æ–¥ –≤ –≤–µ—Ä—Ö–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä –¥–æ –≤–∞–ª–∏–¥–∞—Ü–∏–∏.
        // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ Rule::unique —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ 
        // –∏ –≤ –±–∞–∑—É –ø–æ–ø–∞–¥—É—Ç –¥–∞–Ω–Ω—ã–µ –≤ –Ω—É–∂–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.
        if ($request->has('code')) {
            $request->merge([
                'code' => Str::upper($request->code)
            ]);
        }

        $validated = $request->validate([
            'code' => [
                'required', 
                'string', 
                'alpha_dash', 
                Rule::unique(PromoCode::class, 'code')
            ],
            'type' => 'required|in:percent,fixed',
            'value' => 'required|numeric|min:0',
            'starts_at' => 'nullable|date',
            'expires_at' => 'nullable|date|after_or_equal:starts_at',
            'scope_type' => 'required|in:global,specific,category,line',
            'scope_data' => 'nullable|array',
        ]);

        $validated['is_active'] = $request->has('is_active');

        // –û—á–∏—Å—Ç–∫–∞ –ø—É—Å—Ç—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ç–µ–Ω–∞–Ω—Ç–∞–º
        if (!empty($validated['scope_data'])) {
            $cleanedData = [];
            foreach ($validated['scope_data'] as $tenant => $ids) {
                if (!empty($ids)) {
                    $cleanedData[$tenant] = $ids;
                }
            }
            $validated['scope_data'] = $cleanedData;
        }

        PromoCode::create($validated);

        return redirect()->route('admin.promocodes.index')->with('success', 'Promo Code created successfully.');
    }

    public function destroy($id)
    {
        $this->checkSuperAdmin();
        PromoCode::destroy($id);
        return back()->with('success', 'Promo Code deleted.');
    }
}
</file>

<file path="app/Http/Controllers/Admin/ReportController.php">
<?php
// FILE: app/Http/Controllers/Admin/ReportController.php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Order;
use App\Services\TenantService;
use Illuminate\Support\Facades\DB;

class ReportController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    public function index()
    {
        $user = auth()->user();
        $reportData = [];
        $grandTotal = 0;

        // –õ–û–ì–ò–ö–ê –°–£–ü–ï–†-–ê–î–ú–ò–ù–ê: –ü—Ä–æ–±–µ–≥–∞–µ–º –ø–æ –≤—Å–µ–º —Å—Ö–µ–º–∞–º
        if ($user->role === 'super_admin') {
            $tenants = config('tenants.tenants');
            
            foreach ($tenants as $id => $config) {
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –ë–î
                // –í–∞–∂–Ω–æ: try-catch, —á—Ç–æ–±—ã –æ—à–∏–±–∫–∞ –≤ –æ–¥–Ω–æ–π —Å—Ö–µ–º–µ –Ω–µ –ø–æ–ª–æ–∂–∏–ª–∞ –≤–µ—Å—å –æ—Ç—á–µ—Ç
                try {
                    $this->tenantService->switchTenant($id);
                    
                    $total = Order::sum('total_amount');
                    $count = Order::count();
                    $avg = $count > 0 ? $total / $count : 0;

                    $reportData[] = [
                        'tenant' => $config['name'],
                        'orders_count' => $count,
                        'total_revenue' => $total,
                        'average_check' => $avg,
                    ];
                    $grandTotal += $total;

                } catch (\Exception $e) {
                    $reportData[] = [
                        'tenant' => $config['name'] . ' (Error)',
                        'orders_count' => 0,
                        'total_revenue' => 0,
                        'average_check' => 0,
                    ];
                }
            }
            
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –≤ Public (–∏–ª–∏ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∞–¥–º–∏–Ω–∫–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
            DB::statement("SET search_path TO public");

        } else {
            // –õ–û–ì–ò–ö–ê –ú–ï–ù–ï–î–ñ–ï–†–ê: –î–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ —Ç–µ–∫—É—â–µ–π —Å—Ö–µ–º—ã
            // Middleware —É–∂–µ –ø–µ—Ä–µ–∫–ª—é—á–∏–ª –Ω–∞—Å –≤ –Ω—É–∂–Ω—É—é —Å—Ö–µ–º—É –ø—Ä–∏ –≤—Ö–æ–¥–µ (–µ—Å–ª–∏ –º—ã –≤ —Ä–µ–∂–∏–º–µ –º–∞–≥–∞–∑–∏–Ω–∞)
            // –ù–æ —Ç–∞–∫ –∫–∞–∫ –º—ã –≤ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –∞–¥–º–∏–Ω–∫–µ, –Ω–∞–º –Ω—É–∂–Ω–æ —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤–µ—Ä–µ–Ω.
            
            if ($user->tenant_id) {
                $this->tenantService->switchTenant($user->tenant_id);
                
                $total = Order::sum('total_amount');
                $count = Order::count();
                $avg = $count > 0 ? $total / $count : 0;

                $reportData[] = [
                    'tenant' => ucfirst($user->tenant_id),
                    'orders_count' => $count,
                    'total_revenue' => $total,
                    'average_check' => $avg,
                ];
                $grandTotal = $total;
            }
        }

        return view('admin.reports.index', compact('reportData', 'grandTotal'));
    }
}
</file>

<file path="app/Http/Controllers/Admin/TelegramSettingsController.php">
<?php
    // FILE: app/Http/Controllers/Admin/TelegramSettingsController.php

    namespace App\Http\Controllers\Admin;

    use App\Http\Controllers\Controller;
    use App\Models\TelegramConfig;
    use Illuminate\Http\Request;
    use Illuminate\Validation\Rule;
    use Illuminate\Support\Facades\Http;

    class TelegramSettingsController extends Controller
    {
        private function checkSuperAdmin()
        {
            if (auth()->user()->role !== 'super_admin') {
                abort(403, 'Access denied.');
            }
        }

        // Index –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –º—ã –∏–¥–µ–º –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É (–Ω–æ —Å–µ–π—á–∞—Å —É –Ω–∞—Å –æ–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏)
        // –û—Å—Ç–∞–≤–ª—è–µ–º –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –∏–ª–∏ –¥–ª—è API –≤—ã–∑–æ–≤–æ–≤
        public function index()
        {
            $this->checkSuperAdmin();
            $configs = TelegramConfig::all();
            $tenants = config('tenants.tenants');
            return view('admin.settings.telegram', compact('configs', 'tenants'));
        }

        public function store(Request $request)
        {
            $this->checkSuperAdmin();

            $validated = $request->validate([
                'name' => 'required|string|max:255',
                'bot_token' => 'required|string',
                'chat_id' => 'required|string',
                'tenant_id' => 'nullable|string|unique:public.telegram_configs,tenant_id',
            ]);

            $validated['is_active'] = $request->has('is_active');

            TelegramConfig::create($validated);

            return back()->with('success', 'Telegram Bot configuration added.');
        }

        public function update(Request $request, $id)
        {
            $this->checkSuperAdmin();
            $config = TelegramConfig::findOrFail($id);

            $validated = $request->validate([
                'name' => 'required|string|max:255',
                'bot_token' => 'required|string',
                'chat_id' => 'required|string',
                'tenant_id' => ['nullable', 'string', Rule::unique('public.telegram_configs', 'tenant_id')->ignore($config->id)],
            ]);

            $validated['is_active'] = $request->has('is_active');
            $config->update($validated);

            return back()->with('success', 'Configuration updated.');
        }

        public function destroy($id)
        {
            $this->checkSuperAdmin();
            TelegramConfig::destroy($id);
            return back()->with('success', 'Configuration deleted.');
        }

        public function test($id)
        {
            $this->checkSuperAdmin();
            $config = TelegramConfig::findOrFail($id);

            return $this->performSend($config, "‚ö° *TEST*\nConnection successful for bot: _{$config->name}_");
        }

        // –ù–û–í–´–ô –ú–ï–¢–û–î: –†—É—á–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
        public function sendMessage(Request $request)
        {
            $this->checkSuperAdmin();
            
            $validated = $request->validate([
                'config_id' => 'required|exists:public.telegram_configs,id',
                'message' => 'required|string|min:2',
            ]);

            $config = TelegramConfig::findOrFail($validated['config_id']);
            
            return $this->performSend($config, $validated['message']);
        }

        // –ü—Ä–∏–≤–∞—Ç–Ω—ã–π —Ö–µ–ª–ø–µ—Ä –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏, —á—Ç–æ–±—ã –Ω–µ –¥—É–±–ª–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥
        private function performSend($config, $text)
        {
            try {
                $response = Http::post("https://api.telegram.org/bot{$config->bot_token}/sendMessage", [
                    'chat_id' => $config->chat_id,
                    'text' => $text,
                    'parse_mode' => 'Markdown',
                ]);

                if ($response->successful()) {
                    return back()->with('success', 'Message sent successfully via Telegram!');
                } else {
                    return back()->with('error', 'Telegram API Error: ' . $response->body());
                }
            } catch (\Exception $e) {
                return back()->with('error', 'Connection failed: ' . $e->getMessage());
            }
        }
    }
</file>

<file path="app/Http/Controllers/Api/ProductController.php">
<?php
// FILE: app/Http/Controllers/Api/ProductController.php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use App\Models\Product;
use App\Services\ProductService;
use Illuminate\Http\Request;

class ProductController extends Controller
{
    protected ProductService $productService;

    public function __construct(ProductService $productService)
    {
        $this->productService = $productService;
    }

    // GET /api/products
    public function index()
    {
        return response()->json(Product::latest()->paginate(12));
    }

    // GET /api/products/{id}
    public function show($id)
    {
        $product = Product::findOrFail($id);
        return response()->json($product);
    }

    // GET /api/products/search?q=hoodie
    public function search(Request $request)
    {
        $query = $request->get('q');
        
        if (!$query) {
            return $this->index();
        }

        $products = $this->productService->search($query);
        return response()->json($products);
    }
}
</file>

<file path="app/Http/Controllers/Client/ContactController.php">
<?php

// FILE: app/Http/Controllers/Client/ContactController.php

namespace App\Http\Controllers\Client;

use App\Http\Controllers\Controller;
use App\Models\ContactMessage;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;

class ContactController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    private function resolveTenant()
    {
        $host = request()->getHost();
        $map = $this->tenantService->getDomainMap();
        $tenantId = $map[$host] ?? 'default';
        $this->tenantService->switchTenant($tenantId);
        return $tenantId;
    }

    public function index()
    {
        $tenantId = $this->resolveTenant();
        $view = "tenants.{$tenantId}.contact";
        if (!view()->exists($view)) {
            $view = 'shop.contact';
        }
        return view($view);
    }

    public function store(Request $request)
    {
        $this->resolveTenant();

        $validated = $request->validate([
            'email' => 'required|email',
            'phone' => 'nullable|string|max:20',
            'message' => 'required|string|min:10|max:2000',
        ]);

        // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –¥–æ–±–∞–≤–ª—è–µ–º –µ–≥–æ ID
        if (Auth::check()) {
            $validated['user_id'] = Auth::id();
            // –ï—Å–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω –Ω–µ –≤–≤–µ–¥–µ–Ω –≤ —Ñ–æ—Ä–º–µ, –Ω–æ –µ—Å—Ç—å –≤ –ø—Ä–æ—Ñ–∏–ª–µ - –º–æ–∂–Ω–æ –¥–æ–ø–æ–ª–Ω–∏—Ç—å (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
            if (empty($validated['phone'])) {
                $validated['phone'] = Auth::user()->phone;
            }
        }

        ContactMessage::create($validated);

        return back()->with('success', 'Message sent successfully. Support team will contact you.');
    }
}
</file>

<file path="app/Http/Controllers/Client/ProfileController.php">
<?php
// FILE: app/Http/Controllers/Client/ProfileController.php

namespace App\Http\Controllers\Client;

use App\Http\Controllers\Controller;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use App\Models\Order;

class ProfileController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    private function resolveTenant()
    {
        $host = request()->getHost();
        $map = $this->tenantService->getDomainMap();
        $tenantId = $map[$host] ?? 'default';
        $this->tenantService->switchTenant($tenantId);
        return $tenantId;
    }

    public function index()
    {
        $tenantId = $this->resolveTenant();
        $user = Auth::user();
        
        $orders = $user->orders()->with('items')->get();

        $view = "tenants.{$tenantId}.profile.index";
        if (!view()->exists($view)) $view = 'client.profile.index';

        return view($view, compact('orders', 'user'));
    }

    public function showOrder($id)
    {
        $tenantId = $this->resolveTenant();
        
        $order = Order::with('items')->where('user_id', Auth::id())->findOrFail($id);
        
        // –ü–æ–ª—É—á–∞–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å –∏–∑ —Å–µ—Å—Å–∏–∏ (–µ—Å–ª–∏ —ç—Ç–æ —Ç–æ–ª—å–∫–æ —á—Ç–æ —Å–æ–∑–¥–∞–Ω–Ω—ã–π –∑–∞–∫–∞–∑)
        $generatedPassword = session('generated_password');

        $view = "tenants.{$tenantId}.profile.order";
        if (!view()->exists($view)) $view = 'client.profile.order';

        return view($view, compact('order', 'generatedPassword'));
    }
}
</file>

<file path="app/Http/Controllers/Controller.php">
<?php

namespace App\Http\Controllers;

abstract class Controller
{
    //
}
</file>

<file path="app/Models/AttributeOption.php">
<?php
// FILE: app/Models/AttributeOption.php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class AttributeOption extends Model
{
    protected $fillable = ['type', 'value', 'slug'];
}
</file>

<file path="app/Models/Category.php">
<?php
// FILE: app/Models/Category.php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Category extends Model
{
    use HasFactory;

    protected $fillable = ['name', 'slug'];

    public function products()
    {
        return $this->belongsToMany(Product::class);
    }
}
</file>

<file path="app/Models/ClothingLine.php">
<?php
// FILE: app/Models/ClothingLine.php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class ClothingLine extends Model
{
    protected $fillable = ['name', 'slug'];

    public function products()
    {
        return $this->hasMany(Product::class);
    }
}
</file>

<file path="app/Models/ContactMessage.php">
<?php

// FILE: app/Models/ContactMessage.php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class ContactMessage extends Model
{
    use HasFactory;

    protected $fillable = [
        'user_id', // <--- –î–æ–±–∞–≤–ª–µ–Ω–æ
        'email',
        'phone',
        'message',
        'is_read',
    ];

    protected $casts = [
        'is_read' => 'boolean',
    ];

    // –°–≤—è–∑—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
    public function user()
    {
        return $this->belongsTo(User::class);
    }
}
</file>

<file path="app/Models/OrderItem.php">
<?php
// FILE: app/Models/OrderItem.php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class OrderItem extends Model
{
    protected $fillable = [
        'order_id', 'product_id', 'product_name', 'sku', 'size', 'quantity', 'price', 'total'
    ];

    public function product()
    {
        return $this->belongsTo(Product::class)->withTrashed(); // –î–∞–∂–µ –µ—Å–ª–∏ —Ç–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω, —Å–≤—è–∑—å –Ω—É–∂–Ω–∞
    }
}
</file>

<file path="app/Models/ProductImage.php">
<?php
// FILE: app/Models/ProductImage.php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Str;

class ProductImage extends Model
{
    protected $fillable = ['product_id', 'path', 'sort_order'];

    // –ê–∫—Å–µ—Å—Å–æ—Ä –¥–ª—è URL
    public function getUrlAttribute()
    {
        // –ï—Å–ª–∏ —ç—Ç–æ –≤–Ω–µ—à–Ω—è—è —Å—Å—ã–ª–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –∑–∞–≥–ª—É—à–µ–∫), –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å
        if (Str::startsWith($this->path, ['http://', 'https://'])) {
            return $this->path;
        }

        // –ò–Ω–∞—á–µ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Å—ã–ª–∫—É —á–µ—Ä–µ–∑ –¥–∏—Å–∫ —Ç–µ–Ω–∞–Ω—Ç–∞
        return Storage::disk('tenant')->url($this->path);
    }
}
</file>

<file path="app/Models/ProductVariant.php">
<?php
// FILE: app/Models/ProductVariant.php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class ProductVariant extends Model
{
    protected $fillable = ['product_id', 'size', 'stock'];

    public function product()
    {
        return $this->belongsTo(Product::class);
    }
}
</file>

<file path="app/Models/PromoCode.php">
<?php
// FILE: app/Models/PromoCode.php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class PromoCode extends Model
{
    // –í–∞–∂–Ω–æ: —Ç–∞–±–ª–∏—Ü–∞ –≤—Å–µ–≥–¥–∞ –≤ public —Å—Ö–µ–º–µ
    protected $table = 'public.promo_codes';

    protected $fillable = [
        'code', 
        'type', 
        'value', 
        'is_active', 
        'starts_at',
        'expires_at',
        'scope_type',
        'scope_data'
    ];

    protected $casts = [
        'is_active' => 'boolean',
        'starts_at' => 'datetime',
        'expires_at' => 'datetime',
        'scope_data' => 'array', // –ê–≤—Ç–æ-–∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è JSON
    ];

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ –ø–æ –≤—Ä–µ–º–µ–Ω–∏
    public function isValid()
    {
        if (!$this->is_active) return false;
        $now = now();
        if ($this->starts_at && $now->lt($this->starts_at)) return false;
        if ($this->expires_at && $now->gt($this->expires_at)) return false;
        
        return true;
    }
}
</file>

<file path="app/Models/TelegramConfig.php">
<?php
// FILE: app/Models/TelegramConfig.php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class TelegramConfig extends Model
{
    protected $fillable = [
        'name',
        'bot_token',
        'chat_id',
        'tenant_id',
        'is_active',
    ];

    // –Ø–≤–Ω–æ —É–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ —Ç–∞–±–ª–∏—Ü–∞ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å—Ö–µ–º–µ public (–µ—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ PostgreSQL —Å—Ö–µ–º—ã)
    // –≠—Ç–æ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –º–æ–¥–µ–ª—å –≤—Å–µ–≥–¥–∞ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º, 
    // –¥–∞–∂–µ –µ—Å–ª–∏ –º—ã –ø–µ—Ä–µ–∫–ª—é—á–∏–ª–∏ search_path –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –º–∞–≥–∞–∑–∏–Ω.
    protected $table = 'public.telegram_configs';
}
</file>

<file path="app/Models/TenantSetting.php">
<?php
// FILE: app/Models/TenantSetting.php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class TenantSetting extends Model
{
    protected $fillable = ['key', 'value', 'group'];

    // –•–µ–ª–ø–µ—Ä –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    public static function get(string $key, $default = null)
    {
        return self::where('key', $key)->value('value') ?? $default;
    }

    // –•–µ–ª–ø–µ—Ä –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    public static function set(string $key, $value, string $group = 'general')
    {
        return self::updateOrCreate(
            ['key' => $key],
            ['value' => $value, 'group' => $group]
        );
    }
}
</file>

<file path="app/Http/Controllers/Admin/AttributeController.php">
<?php
// FILE: app/Http/Controllers/Admin/AttributeController.php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\AttributeOption;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Support\Str;

class AttributeController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    private function resolveContext(Request $request)
    {
        if (auth()->user()->role !== 'super_admin') {
            return $this->tenantService->getCurrentTenantId();
        }
        // –î–µ—Ñ–æ–ª—Ç –¥–ª—è –∞–¥–º–∏–Ω–∞
        $tenantId = $request->tenant_id ?? array_key_first(config('tenants.tenants'));
        if ($tenantId) $this->tenantService->switchTenant($tenantId);
        return $tenantId;
    }

    public function index(Request $request)
    {
        $currentTenantId = $this->resolveContext($request);
        
        $query = AttributeOption::query();
        if ($request->filled('search')) {
            $query->where('value', 'ilike', "%{$request->search}%");
        }

        $attributes = $query->get()->groupBy('type');
        
        return view('admin.attributes.index', compact('attributes', 'currentTenantId'));
    }

    public function store(Request $request)
    {
        $this->resolveContext($request);
        
        $validated = $request->validate([
            'type' => 'required|string|in:size,product_type,material',
            'value' => 'required|string|max:255',
        ]);

        AttributeOption::firstOrCreate(
            ['type' => $validated['type'], 'value' => $validated['value']],
            ['slug' => Str::slug($validated['value'])]
        );

        return back()->with('success', 'Attribute added.');
    }

    // –í–ê–ñ–ù–û: –ü–∞—Ä–∞–º–µ—Ç—Ä –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è $id, –∏ –º–∞—Ä—à—Ä—É—Ç –¥–æ–ª–∂–µ–Ω –∂–¥–∞—Ç—å {id}
    public function destroy(Request $request, $id)
    {
        $this->resolveContext($request);
        AttributeOption::destroy($id);
        return back()->with('success', 'Attribute deleted.');
    }
}
</file>

<file path="app/Http/Controllers/Admin/DashboardController.php">
<?php
// FILE: app/Http/Controllers/Admin/DashboardController.php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Order;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Support\Collection;

class DashboardController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    public function index(Request $request)
    {
        $user = auth()->user();
        $isSuperAdmin = $user->role === 'super_admin';
        
        $currentTenantId = null;

        if ($isSuperAdmin) {
            if ($request->has('tenant_id')) {
                $currentTenantId = $request->tenant_id;
            } elseif (session()->has('admin_current_tenant_id')) {
                $currentTenantId = session('admin_current_tenant_id');
            }
            if ($currentTenantId === 'root') $currentTenantId = null;
        } else {
            $currentTenantId = $this->tenantService->getCurrentTenantId();
        }

        $stats = [
            'total_orders' => 0,
            'total_revenue' => 0,
            'recent_orders' => new Collection(),
            'tenant_name' => $currentTenantId ? config("tenants.tenants.$currentTenantId.name") : 'All Shops (Global Overview)'
        ];

        if ($currentTenantId) {
            // --- –†–ï–ñ–ò–ú –û–î–ù–û–ì–û –ú–ê–ì–ê–ó–ò–ù–ê ---
            $this->tenantService->switchTenant($currentTenantId);
            
            $stats['total_orders'] = Order::count();
            $stats['total_revenue'] = Order::sum('total_amount');
            
            $recent = Order::latest()->take(5)->get();
            $storeName = config("tenants.tenants.$currentTenantId.name");
            $recent->each(fn($o) => $o->store_name = $storeName);
            
            $stats['recent_orders'] = $recent;

        } elseif ($isSuperAdmin) {
            // --- –ì–õ–û–ë–ê–õ–¨–ù–´–ô –†–ï–ñ–ò–ú ---
            $allOrders = []; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π –º–∞—Å—Å–∏–≤, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ ID

            foreach (config('tenants.tenants') as $id => $config) {
                try {
                    $this->tenantService->switchTenant($id);
                    
                    $stats['total_orders'] += Order::count();
                    $stats['total_revenue'] += Order::sum('total_amount');
                    
                    // –ë–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 —Å –∫–∞–∂–¥–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞
                    $orders = Order::latest()->take(5)->get();
                    
                    foreach ($orders as $order) {
                        $order->store_name = $config['name'];
                        $order->tenant_id = $id;
                        $allOrders[] = $order; // –ü—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤
                    }
                } catch (\Exception $e) {
                    continue;
                }
            }
            
            // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é, —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ –∏ –±–µ—Ä–µ–º —Ç–æ–ø-5
            $stats['recent_orders'] = collect($allOrders)->sortByDesc('created_at')->take(5);
        }

        return view('admin.dashboard', compact('stats', 'currentTenantId'));
    }
}
</file>

<file path="app/Http/Controllers/Admin/SettingsController.php">
<?php
// FILE: app/Http/Controllers/Admin/SettingsController.php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use App\Models\TelegramConfig; // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –º–æ–¥–µ–ª—å —Ç–µ–ª–µ–≥—Ä–∞–º–∞

class SettingsController extends Controller
{
    private function checkSuperAdmin()
    {
        if (auth()->user()->role !== 'super_admin') {
            abort(403, 'Access denied.');
        }
    }

    public function index()
    {
        $this->checkSuperAdmin();

        // –î–∞–Ω–Ω—ã–µ –¥–ª—è Telegram –≤–∫–ª–∞–¥–∫–∏
        $telegramConfigs = TelegramConfig::all();
        $tenants = config('tenants.tenants');

        return view('admin.settings.index', compact('telegramConfigs', 'tenants'));
    }

    // –ú–µ—Ç–æ–¥ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –û–ë–©–ò–• –Ω–∞—Å—Ç—Ä–æ–µ–∫ (–∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞)
    public function update(Request $request)
    {
        $this->checkSuperAdmin();
        // –ó–¥–µ—Å—å –ª–æ–≥–∏–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞–∑–≤–∞–Ω–∏—è —Å–∞–π—Ç–∞, –ª–æ–≥–æ—Ç–∏–ø–∞ –∏ —Ç.–¥.
        // ...
        return back()->with('success', 'General settings updated.');
    }
}
</file>

<file path="app/Http/Controllers/Client/AuthController.php">
<?php
// FILE: app/Http/Controllers/Client/AuthController.php

namespace App\Http\Controllers\Client;

use App\Http\Controllers\Controller;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Hash;
use App\Models\User;

class AuthController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    private function resolveTenant()
    {
        $host = request()->getHost();
        $map = $this->tenantService->getDomainMap();
        $tenantId = $map[$host] ?? 'default';
        $this->tenantService->switchTenant($tenantId);
        return $tenantId;
    }

    public function showLogin()
    {
        $tenantId = $this->resolveTenant();
        // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞ –∏–ª–∏ –æ–±—â–∏–π
        $view = "tenants.{$tenantId}.auth.login";
        if (!view()->exists($view)) {
            $view = 'client.auth.login'; // –§–æ–ª–±—ç–∫ –Ω–∞ –æ–±—â–∏–π
        }
        
        return view($view);
    }

    public function login(Request $request)
    {
        $this->resolveTenant();

        $credentials = $request->validate([
            'phone' => 'required|string',
            'password' => 'required|string',
        ]);

        // 1. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞ (–ü–∞—Ä–æ–ª—å)
        if (Auth::attempt(['phone' => $credentials['phone'], 'password' => $credentials['password']])) {
            $request->session()->regenerate();
            return redirect()->route('client.profile');
        }

        // 2. –ü–æ–ø—ã—Ç–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Access Key (–†–µ–∑–µ—Ä–≤–Ω—ã–π –≤—Ö–æ–¥)
        $user = User::where('phone', $credentials['phone'])->first();
        
        if ($user && $user->access_key) {
            // –°—Ä–∞–≤–Ω–∏–≤–∞–µ–º –≤–≤–µ–¥–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å —Å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–º –∫–ª—é—á–æ–º
            if ($credentials['password'] === $user->access_key) {
                Auth::login($user);
                $request->session()->regenerate();
                return redirect()->route('client.profile')->with('success', 'Logged in via Access Key');
            }
        }

        return back()->withErrors([
            'phone' => 'The provided credentials do not match our records.',
        ]);
    }

    public function logout(Request $request)
    {
        Auth::logout();
        $request->session()->invalidate();
        $request->session()->regenerateToken();
        return redirect()->route('home');
    }

    public function updatePassword(Request $request)
    {
        $this->resolveTenant();

        $request->validate([
            'current_password' => 'required',
            'new_password' => 'required|min:6|confirmed',
        ]);

        $user = Auth::user();

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å (–∏–ª–∏ access_key)
        $isPasswordCorrect = Hash::check($request->current_password, $user->password);
        $isAccessKeyCorrect = ($user->access_key && $request->current_password === $user->access_key);

        if (!$isPasswordCorrect && !$isAccessKeyCorrect) {
            return back()->withErrors(['current_password' => 'Current password is incorrect']);
        }

        /** @var \App\Models\User $user */
        $user->update([
            'password' => Hash::make($request->new_password),
            // –í–ê–ñ–ù–û: –û–±–Ω–æ–≤–ª—è–µ–º Access Key —Ç–æ–∂–µ, —á—Ç–æ–±—ã –Ω–∞ —á–µ–∫–µ –≤—Å–µ–≥–¥–∞ –±—ã–ª –ê–ö–¢–£–ê–õ–¨–ù–´–ô –ø–∞—Ä–æ–ª—å
            // Laravel –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞—à–∏—Ñ—Ä—É–µ—Ç —ç—Ç–æ –ø–æ–ª–µ –±–ª–∞–≥–æ–¥–∞—Ä—è $casts –≤ –º–æ–¥–µ–ª–∏
            'access_key' => $request->new_password 
        ]);

        return back()->with('success', 'Password updated successfully! Your receipt credentials are also updated.');
    }
}
</file>

<file path="app/Http/Controllers/Admin/CategoryController.php">
<?php
// FILE: app/Http/Controllers/Admin/CategoryController.php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Category;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Support\Str;

class CategoryController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    private function resolveContext(Request $request)
    {
        if (auth()->user()->role !== 'super_admin') {
            return $this->tenantService->getCurrentTenantId();
        }
        $tenantId = $request->tenant_id ?? array_key_first(config('tenants.tenants'));
        if ($tenantId) {
            $this->tenantService->switchTenant($tenantId);
        }
        return $tenantId;
    }

    public function index(Request $request)
    {
        $currentTenantId = $this->resolveContext($request);
        $query = Category::withCount('products');
        if ($request->filled('search')) {
            $query->where('name', 'ilike', "%{$request->search}%");
        }
        $categories = $query->orderBy('name')->get();
        return view('admin.categories.index', compact('categories', 'currentTenantId'));
    }

    public function store(Request $request)
    {
        $this->resolveContext($request);
        
        $validated = $request->validate(['name' => 'required|string|max:255']);

        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–æ–∏—Å–∫ –ø–æ —Å–ª–∞–≥—É
        $slug = Str::slug($validated['name']);
        
        Category::firstOrCreate(
            ['slug' => $slug],
            ['name' => $validated['name']]
        );

        return back()->with('success', 'Category created/found.');
    }

    public function update(Request $request, $id)
    {
        $this->resolveContext($request);
        $category = Category::findOrFail($id);
        
        $validated = $request->validate(['name' => 'required|string|max:255']);
        // –ü—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø—Ä–æ—Å—Ç–æ –º–µ–Ω—è–µ–º –∏–º—è –∏ —Å–ª–∞–≥, —Ç—É—Ç firstOrCreate –Ω–µ –Ω—É–∂–µ–Ω, –Ω–æ –Ω—É–∂–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å unique exception
        try {
            $category->update([
                'name' => $validated['name'],
                'slug' => Str::slug($validated['name'])
            ]);
        } catch (\Exception $e) {
            return back()->with('error', 'Category with this name already exists.');
        }
        
        return back()->with('success', 'Category updated.');
    }

    public function destroy(Request $request, $id)
    {
        $this->resolveContext($request);
        Category::destroy($id);
        return back()->with('success', 'Category deleted.');
    }
}
</file>

<file path="app/Models/User.php">
<?php
// FILE: app/Models/User.php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Foundation\Auth\User as Authenticatable;
use Illuminate\Notifications\Notifiable;

class User extends Authenticatable
{
    use HasFactory, Notifiable;

    protected $fillable = [
        'name',
        'email',
        'password',
        'phone',      
        'role',       
        'tenant_id',
        'access_key', // <--- –î–æ–±–∞–≤–ª–µ–Ω–æ
    ];

    protected $hidden = [
        'password',
        'remember_token',
        'access_key', // –°–∫—Ä—ã–≤–∞–µ–º –ø—Ä–∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ –≤ –º–∞—Å—Å–∏–≤ (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)
    ];

    protected $casts = [
        'email_verified_at' => 'datetime',
        'password' => 'hashed',
        'access_key' => 'encrypted', // <--- –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –®–ò–§–†–û–í–ê–ù–ò–ï/–î–ï–®–ò–§–†–û–í–ö–ê
    ];

    public function orders()
    {
        return $this->hasMany(Order::class)->latest();
    }
}
</file>

<file path="app/Http/Controllers/Admin/OrderController.php">
<?php
// FILE: app/Http/Controllers/Admin/OrderController.php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Order;
use App\Models\OrderItem;
use App\Models\Product;
use App\Models\User;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\DB;
use Illuminate\Pagination\LengthAwarePaginator;

class OrderController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    private function resolveContext(Request $request)
    {
        if (auth()->user()->role === 'super_admin') {
            $tenantId = $request->get('tenant_id');
            if ($tenantId) {
                $this->tenantService->switchTenant($tenantId);
                return $tenantId;
            }
            return null;
        }
        return $this->tenantService->getCurrentTenantId();
    }

    public function index(Request $request)
    {
        $currentTenantId = $this->resolveContext($request);
        
        if ($currentTenantId) {
            $orders = Order::latest()->paginate(20);
            $tenantName = config("tenants.tenants.{$currentTenantId}.name");
            $orders->getCollection()->transform(function ($order) use ($currentTenantId, $tenantName) {
                $order->tenant_id = $currentTenantId;
                $order->tenant_name = $tenantName;
                return $order;
            });
            return view('admin.orders.index', compact('orders', 'currentTenantId'));
        }

        // –ê–≥—Ä–µ–≥–∞—Ü–∏—è –¥–ª—è –°—É–ø–µ—Ä-–ê–¥–º–∏–Ω–∞
        $allOrders = collect();
        foreach (config('tenants.tenants') as $tenantId => $config) {
            try {
                $this->tenantService->switchTenant($tenantId);
                $tenantOrders = Order::latest()->limit(50)->get();
                foreach ($tenantOrders as $order) {
                    $order->tenant_id = $tenantId;
                    $order->tenant_name = $config['name'];
                    $allOrders->push($order);
                }
            } catch (\Exception $e) { continue; }
        }

        $sortedOrders = $allOrders->sortByDesc('created_at')->values();
        $paginatedOrders = new LengthAwarePaginator(
            $sortedOrders->forPage($request->get('page', 1), 20),
            $sortedOrders->count(),
            20,
            $request->get('page', 1),
            ['path' => $request->url(), 'query' => $request->query()]
        );

        return view('admin.orders.index', ['orders' => $paginatedOrders, 'currentTenantId' => null]);
    }

    public function show(Request $request, $id)
    {
        $tenantId = $request->get('tenant_id') ?? $this->tenantService->getCurrentTenantId();
        if (!$tenantId) return back()->with('error', 'Tenant context required.');

        $this->tenantService->switchTenant($tenantId);
        $order = Order::with('items')->findOrFail($id);
        
        return view('admin.orders.show', ['order' => $order, 'currentTenantId' => $tenantId]);
    }

    public function create(Request $request)
    {
        $user = auth()->user();
        $isSuperAdmin = $user->role === 'super_admin';
        $currentTenantId = $request->get('tenant_id');

        if (!$isSuperAdmin) {
            $currentTenantId = $this->tenantService->getCurrentTenantId();
        }

        $productsCatalog = [];
        $customers = []; 

        if ($currentTenantId) {
            try {
                // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–æ–≤–∞—Ä—ã
                $this->tenantService->switchTenant($currentTenantId);
                $products = Product::with('variants')->where('stock_quantity', '>', 0)->get();
                
                foreach ($products as $prod) {
                    $prodData = $prod->toArray();
                    $prodData['tenant_id'] = $currentTenantId;
                    $prodData['tenant_name'] = config("tenants.tenants.{$currentTenantId}.name");
                    $prodData['variants'] = $prod->variants->toArray();
                    $productsCatalog[] = $prodData;
                }

                // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–ª–∏–µ–Ω—Ç–æ–≤
                $customers = User::where('role', 'client')
                    ->select('id', 'name', 'phone', 'email')
                    ->orderBy('name')
                    ->get();

            } catch (\Exception $e) {}
        }

        return view('admin.orders.form', [
            'order' => null,
            'productsJson' => $productsCatalog,
            'customersJson' => $customers,
            'isSuperAdmin' => $isSuperAdmin,
            'currentTenantId' => $currentTenantId
        ]);
    }

    public function store(Request $request)
    {
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–Ω–∞—á–∞–ª–∞ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º –º–∞–≥–∞–∑–∏–Ω, –ø–æ—Ç–æ–º –≤–∞–ª–∏–¥–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
        // –ò–Ω–∞—á–µ exists:users,id –∏—â–µ—Ç –≤ public —Å—Ö–µ–º–µ, –∞ –∫–ª–∏–µ–Ω—Ç –≤ —Å—Ö–µ–º–µ –º–∞–≥–∞–∑–∏–Ω–∞.
        $tenantId = $request->input('tenant_id');
        if ($tenantId) {
            $this->tenantService->switchTenant($tenantId);
        }

        $validated = $request->validate([
            'tenant_id' => 'required|string',
            'user_id' => 'nullable|exists:users,id', // –¢–µ–ø–µ—Ä—å –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–π–¥–µ—Ç –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ö–µ–º–µ
            'customer_name' => 'required|string',
            'customer_phone' => 'required|string',
            'customer_email' => 'nullable|email',
            'shipping_method' => 'required|string',
            'shipping_address' => 'required|string',
            'is_instagram' => 'boolean',
            'items' => 'required|array|min:1',
            'items.*.product_id' => 'required',
            'items.*.quantity' => 'required|integer|min:1',
            'items.*.price' => 'required|numeric',
            'items.*.size' => 'nullable',
        ]);

        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
        if (!empty($validated['user_id'])) {
            $user = User::find($validated['user_id']);
            if ($user) {
                $validated['customer_name'] = $user->name;
                $validated['customer_phone'] = $user->phone;
                $validated['customer_email'] = $user->email;
            }
        }

        DB::transaction(function () use ($validated) {
            $total = 0;
            foreach ($validated['items'] as $item) $total += $item['price'] * $item['quantity'];

            $email = !empty($validated['customer_email']) ? $validated['customer_email'] : null;

            $order = Order::create([
                'order_number' => 'ORD-' . date('Ymd') . '-' . strtoupper(Str::random(5)),
                'user_id' => $validated['user_id'] ?? null,
                'customer_name' => $validated['customer_name'],
                'customer_phone' => $validated['customer_phone'],
                'customer_email' => $email,
                'shipping_method' => $validated['shipping_method'],
                'shipping_address' => $validated['shipping_address'],
                'status' => 'new',
                'subtotal' => $total,
                'total_amount' => $total,
                'is_instagram' => $validated['is_instagram'] ?? false,
            ]);

            $this->saveOrderItems($order, $validated['items']);
        });

        return redirect()->route('admin.orders.index', ['tenant_id' => $validated['tenant_id']])->with('success', 'Order created.');
    }

    public function edit(Request $request, $id)
    {
        $tenantId = $request->get('tenant_id');
        if (!$tenantId) $tenantId = $this->tenantService->getCurrentTenantId();

        $this->tenantService->switchTenant($tenantId);
        $order = Order::with('items')->findOrFail($id);
        
        $products = Product::with('variants')->get();
        $productsCatalog = [];
        foreach ($products as $prod) {
            $prodData = $prod->toArray();
            $prodData['tenant_id'] = $tenantId;
            $productsCatalog[] = $prodData;
        }

        $customers = User::where('role', 'client')
            ->select('id', 'name', 'phone', 'email')
            ->orderBy('name')
            ->get();

        return view('admin.orders.form', [
            'order' => $order,
            'productsJson' => $productsCatalog,
            'customersJson' => $customers,
            'isSuperAdmin' => auth()->user()->role === 'super_admin',
            'currentTenantId' => $tenantId
        ]);
    }

    public function update(Request $request, $id)
    {
        $tenantId = $request->get('tenant_id');
        $this->tenantService->switchTenant($tenantId);
        $order = Order::with('items')->findOrFail($id);

        if ($request->input('update_mode') === 'status_only') {
            $validated = $request->validate([
                'status' => 'required|string',
                'is_instagram' => 'boolean',
            ]);
            $this->handleStatusChangeStock($order, $validated['status']);
            $order->update([
                'status' => $validated['status'],
                'is_instagram' => $request->has('is_instagram') ? 1 : 0
            ]);
            return back()->with('success', 'Status updated successfully.');
        }

        $validated = $request->validate([
            'user_id' => 'nullable|exists:users,id',
            'customer_name' => 'required|string',
            'customer_phone' => 'required|string',
            'customer_email' => 'nullable|email',
            'shipping_method' => 'required|string',
            'shipping_address' => 'required|string',
            'status' => 'required|string',
            'is_instagram' => 'boolean',
            'items' => 'nullable|array', 
        ]);

        if (!empty($validated['user_id'])) {
            $user = User::find($validated['user_id']);
            if ($user) {
                $validated['customer_name'] = $user->name;
                $validated['customer_phone'] = $user->phone;
                $validated['customer_email'] = $user->email;
            }
        }

        DB::transaction(function () use ($order, $validated, $request) {
            if ($request->has('items') && count($request->input('items')) > 0) {
                foreach ($order->items as $oldItem) {
                    $this->adjustStock($oldItem->product_id, $oldItem->size, $oldItem->quantity, 'increment');
                }
                $order->items()->delete();
                $total = $this->saveOrderItems($order, $request->input('items'));
                $order->update(['subtotal' => $total, 'total_amount' => $total]);
            }

            $this->handleStatusChangeStock($order, $validated['status']);

            $email = !empty($validated['customer_email']) ? $validated['customer_email'] : $order->customer_email;

            $order->update([
                'user_id' => $validated['user_id'] ?? $order->user_id,
                'customer_name' => $validated['customer_name'],
                'customer_phone' => $validated['customer_phone'],
                'customer_email' => $email,
                'shipping_method' => $validated['shipping_method'],
                'shipping_address' => $validated['shipping_address'],
                'status' => $validated['status'],
                'is_instagram' => $request->has('is_instagram') ? 1 : 0,
            ]);
        });

        return redirect()->route('admin.orders.index', ['tenant_id' => $tenantId])->with('success', 'Order updated.');
    }

    private function handleStatusChangeStock($order, $newStatus)
    {
        if ($newStatus === 'cancelled' && $order->status !== 'cancelled') {
             foreach ($order->items as $item) $this->adjustStock($item->product_id, $item->size, $item->quantity, 'increment');
        }
        if ($order->status === 'cancelled' && $newStatus !== 'cancelled') {
             foreach ($order->items as $item) $this->adjustStock($item->product_id, $item->size, $item->quantity, 'decrement');
        }
    }

    private function saveOrderItems($order, $itemsData) {
        $total = 0;
        foreach ($itemsData as $data) {
            $product = Product::with('variants')->find($data['product_id']);
            if (!$product) continue;

            $lineTotal = $data['price'] * $data['quantity'];
            $total += $lineTotal;

            $hasVariants = $product->variants->isNotEmpty();
            
            if ($hasVariants) {
                $size = !empty($data['size']) ? $data['size'] : null;
                if (!$size) $size = $product->variants->first()->size;
            } else {
                $size = 'One Size';
            }

            OrderItem::create([
                'order_id' => $order->id,
                'product_id' => $product->id,
                'product_name' => $product->name,
                'sku' => $product->sku,
                'size' => $size,
                'quantity' => $data['quantity'],
                'price' => $data['price'],
                'total' => $lineTotal,
            ]);
            
            $this->adjustStock($product, $size, $data['quantity'], 'decrement');
        }
        return $total;
    }

    private function adjustStock($productOrId, $size, $qty, $action) {
        $product = ($productOrId instanceof Product) ? $productOrId : Product::find($productOrId);
        if (!$product) return;
        $method = $action === 'increment' ? 'increment' : 'decrement';
        $product->$method('stock_quantity', $qty);
        if ($size && $size !== 'One Size') {
            $v = $product->variants()->where('size', $size)->first();
            if ($v) $v->$method('stock', $qty);
        }
    }
}
</file>

<file path="app/Http/Controllers/CartController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Product;
use App\Models\Order;
use App\Models\OrderItem;
use App\Models\PromoCode;
use App\Models\TelegramConfig;
use App\Models\User;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Hash;

class CartController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    // --- HELPER: –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞ ---
    // –ü—Ä–∏–≤–æ–¥–∏—Ç –Ω–æ–º–µ—Ä–∞ (097..., 38097...) –∫ –µ–¥–∏–Ω–æ–º—É —Ñ–æ—Ä–º–∞—Ç—É +380...
    private function normalizePhone($phone)
    {
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã
        $clean = preg_replace('/[^0-9+]/', '', $phone);
        
        // –ï—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 0 (097...), –¥–æ–±–∞–≤–ª—è–µ–º +38
        if (str_starts_with($clean, '0')) {
            return '+38' . $clean;
        }
        
        // –ï—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 380 (–±–µ–∑ –ø–ª—é—Å–∞), –¥–æ–±–∞–≤–ª—è–µ–º –ø–ª—é—Å
        if (str_starts_with($clean, '380')) {
            return '+' . $clean;
        }

        return $clean;
    }

    // --- HELPER: –ò–∑–æ–ª—è—Ü–∏—è –°–µ—Å—Å–∏–∏ ---
    private function getCartKey()
    {
        return 'cart_' . $this->tenantService->getCurrentTenantId();
    }

    private function getPromoKey()
    {
        return 'promo_code_' . $this->tenantService->getCurrentTenantId();
    }

    // --- HELPER: –ò–∑–æ–ª—è—Ü–∏—è –ë–î ---
    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Å—Ö–µ–º—É –ë–î –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –¥–æ–º–µ–Ω–∞
    private function resolveTenant()
    {
        $host = request()->getHost();
        $map = $this->tenantService->getDomainMap();
        $tenantId = $map[$host] ?? 'default';
        $this->tenantService->switchTenant($tenantId);
        return $tenantId;
    }

    // --- –ü–†–û–°–ú–û–¢–† –ö–û–†–ó–ò–ù–´ ---
    public function index()
    {
        $tenantId = $this->resolveTenant();
        $cartKey = $this->getCartKey();
        $promoKey = $this->getPromoKey();
        
        // –ü–æ–ª—É—á–∞–µ–º –∫–æ—Ä–∑–∏–Ω—É —Ç–µ–∫—É—â–µ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞
        $cart = session()->get($cartKey, []);
        $promoCode = session()->get($promoKey, null);
        
        $cartItems = [];
        $subtotal = 0;
        $discount = 0;

        foreach ($cart as $key => $item) {
            // –ò—â–µ–º —Ç–æ–≤–∞—Ä –≤ –ë–î —Ç–µ–∫—É—â–µ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞
            $product = Product::find($item['product_id']);
            
            // –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä —É–¥–∞–ª–µ–Ω - —É–±–∏—Ä–∞–µ–º –∏–∑ —Å–µ—Å—Å–∏–∏
            if (!$product) {
                unset($cart[$key]);
                continue;
            }
            
            $price = $product->current_price;
            $lineTotal = $price * $item['quantity'];
            $subtotal += $lineTotal;

            $cartItems[] = [
                'product' => $product,
                'size' => $item['size'],
                'quantity' => $item['quantity'],
                'price' => $price,
                'total' => $lineTotal,
                'row_id' => $key
            ];
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–µ—Å—Å–∏—é (–µ—Å–ª–∏ —É–¥–∞–ª—è–ª–∏ —Ç–æ–≤–∞—Ä—ã)
        session()->put($cartKey, $cart);

        // –õ–æ–≥–∏–∫–∞ –ø—Ä–æ–º–æ–∫–æ–¥–∞
        if ($promoCode) {
            $promo = PromoCode::where('code', $promoCode)->first();
            
            if ($promo && $promo->isValid()) {
                $scopeData = $promo->scope_data ?? [];
                
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏–≤—è–∑–∫–∏ –ø—Ä–æ–º–æ–∫–æ–¥–∞ –∫ –º–∞–≥–∞–∑–∏–Ω—É
                if ($promo->scope_type === 'global' || isset($scopeData[$tenantId])) {
                    if ($promo->type === 'fixed') {
                        $discount = $promo->value;
                    } else {
                        $discount = ($subtotal * $promo->value) / 100;
                    }
                } else {
                    session()->forget($promoKey);
                }
            } else {
                session()->forget($promoKey);
            }
        }

        $total = max(0, $subtotal - $discount);

        // –ò—â–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω –∫–æ—Ä–∑–∏–Ω—ã, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –±–µ—Ä–µ–º –æ–±—â–∏–π
        $view = "tenants.{$tenantId}.cart";
        if (!view()->exists($view)) {
            $view = 'cart.index';
        }

        return view($view, compact('cartItems', 'subtotal', 'discount', 'total', 'promoCode'));
    }

    // --- –î–û–ë–ê–í–õ–ï–ù–ò–ï –¢–û–í–ê–†–ê ---
    public function addToCart(Request $request)
    {
        $this->resolveTenant();
        
        $product = Product::findOrFail($request->product_id);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã —Ä–∞–∑–º–µ—Ä–æ–≤ —É —Ç–æ–≤–∞—Ä–∞
        $hasVariants = $product->variants()->count() > 0;

        $request->validate([
            'product_id' => 'required|exists:products,id',
            // –ï—Å–ª–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –µ—Å—Ç—å, —Ä–∞–∑–º–µ—Ä –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
            'size' => $hasVariants ? 'required|string' : 'nullable|string',
        ]);

        $size = $request->size ?? 'One Size';
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –≤–∞—Ä–∏–∞–Ω—Ç–∞
        if ($hasVariants) {
            $variant = $product->variants()->where('size', $size)->first();
            if (!$variant) {
                return back()->with('error', 'Selected size is invalid.');
            }
            if ($variant->stock <= 0) {
                return back()->with('error', 'Selected size is out of stock.');
            }
        } else {
             if ($product->stock_quantity <= 0) {
                 return back()->with('error', 'Product is out of stock.');
             }
        }
        
        $rowId = $product->id . '_' . $size;
        $cartKey = $this->getCartKey();

        $cart = session()->get($cartKey, []);

        if (isset($cart[$rowId])) {
            $cart[$rowId]['quantity']++;
        } else {
            $cart[$rowId] = [
                'product_id' => $product->id,
                'size' => $size,
                'quantity' => 1
            ];
        }

        session()->put($cartKey, $cart);

        return redirect()->route('cart.index')->with('success', 'Product added to cart!');
    }

    // --- –£–î–ê–õ–ï–ù–ò–ï –ò–ó –ö–û–†–ó–ò–ù–´ ---
    public function removeFromCart($rowId)
    {
        $this->resolveTenant();
        $cartKey = $this->getCartKey();
        
        $cart = session()->get($cartKey, []);
        if (isset($cart[$rowId])) {
            unset($cart[$rowId]);
            session()->put($cartKey, $cart);
        }
        return back()->with('success', 'Item removed.');
    }

    // --- –ü–†–û–ú–û–ö–û–î ---
    public function applyPromo(Request $request)
    {
        $this->resolveTenant();
        
        $request->validate(['code' => 'required|string']);
        $code = Str::upper($request->code);

        $promo = PromoCode::where('code', $code)->first();

        if (!$promo || !$promo->isValid()) {
            return back()->with('error', 'Invalid or expired promo code.');
        }

        session()->put($this->getPromoKey(), $code);

        return back()->with('success', 'Promo code applied!');
    }

    // --- –û–§–û–†–ú–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê (CHECKOUT) ---
    public function checkout(Request $request)
    {
        $this->resolveTenant();
        
        // 1. –í–∞–ª–∏–¥–∞—Ü–∏—è
        $validated = $request->validate([
            'customer_name' => 'required|string|max:255',
            'customer_email' => 'required|email',
            // Regex –¥–ª—è —É–∫—Ä–∞–∏–Ω—Å–∫–∏—Ö –Ω–æ–º–µ—Ä–æ–≤ (+380... –∏–ª–∏ 0...)
            'customer_phone' => ['required', 'string', 'regex:/^(\+380|0)[0-9]{9}$/'],
            'shipping_method' => 'required|in:nova_poshta,courier,pickup',
            'shipping_address' => 'required|string|min:5',
        ], [
            'customer_phone.regex' => 'Please enter a valid Ukrainian phone number (e.g., 0971234567 or +380...)'
        ]);

        // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º —Ç–µ–ª–µ—Ñ–æ–Ω –ø–µ—Ä–µ–¥ –ø–æ–∏—Å–∫–æ–º/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º
        $normalizedPhone = $this->normalizePhone($validated['customer_phone']);

        $cartKey = $this->getCartKey();
        $promoKey = $this->getPromoKey();
        $cart = session()->get($cartKey, []);

        if (empty($cart)) {
            return back()->with('error', 'Your cart is empty.');
        }

        // 2. –†–∞—Å—á–µ—Ç –∏ —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–∫–æ–≤
        $subtotal = 0;
        $orderItemsData = [];
        
        foreach ($cart as $item) {
            $product = Product::find($item['product_id']);
            if (!$product) continue;

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–∫–∞
            $variant = $product->variants()->where('size', $item['size'])->first();
            
            if ($variant && $variant->stock < $item['quantity']) {
                return back()->with('error', "Sorry, size {$item['size']} for {$product->name} is out of stock.");
            }
            if (!$variant && $product->stock_quantity < $item['quantity']) {
                return back()->with('error', "Sorry, {$product->name} is out of stock.");
            }

            $price = $product->current_price;
            $lineTotal = $price * $item['quantity'];
            $subtotal += $lineTotal;

            $orderItemsData[] = [
                'product' => $product,
                'size' => $item['size'],
                'quantity' => $item['quantity'],
                'price' => $price,
                'total' => $lineTotal,
            ];
        }

        $discount = 0;
        $promoCode = session()->get($promoKey);
        
        if ($promoCode) {
            $promo = PromoCode::where('code', $promoCode)->first();
            if ($promo && $promo->isValid()) {
                 $discount = ($promo->type === 'fixed') ? $promo->value : ($subtotal * $promo->value / 100);
            }
        }
        $total = max(0, $subtotal - $discount);

        // 3. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ (–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è)
        try {
            $generatedPassword = null;
            $user = null;

            DB::transaction(function () use ($validated, $normalizedPhone, $subtotal, $discount, $total, $promoCode, $orderItemsData, &$generatedPassword, &$user) {
                
                $user = User::where('phone', $normalizedPhone)->first();

                if (!$user) {
                    $generatedPassword = Str::random(8); 
                    
                    $user = User::create([
                        'name' => $validated['customer_name'],
                        'email' => $validated['customer_email'],
                        'phone' => $normalizedPhone,
                        'password' => Hash::make($generatedPassword),
                        'role' => 'client',
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ—Ç –∂–µ –ø–∞—Ä–æ–ª—å –∫–∞–∫ "–í–µ—á–Ω—ã–π –∫–ª—é—á –¥–æ—Å—Ç—É–ø–∞"
                        // Laravel –∑–∞—à–∏—Ñ—Ä—É–µ—Ç –µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–ª–∞–≥–æ–¥–∞—Ä—è $casts
                        'access_key' => $generatedPassword, 
                    ]);
                } else {
                    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –µ—Å—Ç—å, –Ω–æ —É –Ω–µ–≥–æ –Ω–µ—Ç –∫–ª—é—á–∞ (—Å—Ç–∞—Ä—ã–π —é–∑–µ—Ä),
                    // –º–æ–∂–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –µ–º—É –∫–ª—é—á —Å–µ–π—á–∞—Å.
                    if (!$user->access_key) {
                         // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–π –∫–ª—é—á, –Ω–æ –ù–ï –º–µ–Ω—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø–∞—Ä–æ–ª—å
                         $newKey = Str::random(8);
                         $user->update(['access_key' => $newKey]);
                         // –ü–µ—Ä–µ–¥–∞–¥–∏–º –µ–≥–æ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è, –Ω–æ –ø–æ–º–µ—Ç–∏–º –∫–∞–∫ Key, –∞ –Ω–µ Password
                         $generatedPassword = $newKey; 
                    }
                }

                // –ë) –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ —Å –ø—Ä–∏–≤—è–∑–∫–æ–π (user_id)
                $order = Order::create([
                    'order_number' => 'ORD-' . date('Ymd') . '-' . strtoupper(Str::random(5)),
                    'user_id' => $user->id,
                    'customer_name' => $validated['customer_name'],
                    'customer_email' => $validated['customer_email'],
                    'customer_phone' => $normalizedPhone,
                    'shipping_method' => $validated['shipping_method'],
                    'shipping_address' => $validated['shipping_address'],
                    'subtotal' => $subtotal,
                    'discount_amount' => $discount,
                    'total_amount' => $total,
                    'promo_code' => $promoCode,
                    'status' => 'new',
                    'payment_method' => 'cod',
                ]);

                // –í) –¢–æ–≤–∞—Ä—ã –∏ —Å–ø–∏—Å–∞–Ω–∏–µ —Å—Ç–æ–∫–∞
                foreach ($orderItemsData as $data) {
                    OrderItem::create([
                        'order_id' => $order->id,
                        'product_id' => $data['product']->id,
                        'product_name' => $data['product']->name,
                        'sku' => $data['product']->sku,
                        'size' => $data['size'],
                        'quantity' => $data['quantity'],
                        'price' => $data['price'],
                        'total' => $data['total'],
                    ]);

                    $variant = $data['product']->variants()->where('size', $data['size'])->first();
                    if ($variant) {
                        $variant->decrement('stock', $data['quantity']);
                    }
                    $data['product']->decrement('stock_quantity', $data['quantity']);
                }

                // –ì) –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
                $this->sendTelegramNotification($order);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –∑–∞–∫–∞–∑–∞ (–º–æ–∂–µ—Ç –ø–æ–Ω–∞–¥–æ–±–∏—Ç—å—Å—è)
                session()->flash('last_order_id', $order->id);
            });

            // 4. –û—á–∏—Å—Ç–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã –≠–¢–û–ì–û –º–∞–≥–∞–∑–∏–Ω–∞
            session()->forget([$cartKey, $promoKey]);

            // 5. –õ–æ–≥–∏–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
            
            // –ï—Å–ª–∏ –º—ã –ê–¥–º–∏–Ω –∏–ª–∏ –ú–µ–Ω–µ–¥–∂–µ—Ä ‚Äî –ù–ï –ª–æ–≥–∏–Ω–∏–º—Å—è –∫–∞–∫ –∫–ª–∏–µ–Ω—Ç, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –∞–¥–º–∏–Ω–∫—É
            if (Auth::check() && in_array(Auth::user()->role, ['super_admin', 'manager'])) {
                return redirect()->route('home')->with('success', "Order placed successfully. Admin session preserved. Order linked to User ID: {$user->id}");
            }

            // –ï—Å–ª–∏ –º—ã –≥–æ—Å—Ç—å ‚Äî –∞–≤—Ç–æ—Ä–∏–∑—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            Auth::login($user);

            // –ü–µ—Ä–µ–¥–∞–µ–º –ø–∞—Ä–æ–ª—å –≤–æ flash, –µ—Å–ª–∏ –æ–Ω –±—ã–ª —Å–æ–∑–¥–∞–Ω
            if ($generatedPassword) {
                session()->flash('generated_password', $generatedPassword);
                session()->flash('new_account_created', true);
            }

            // 6. –†–µ–¥–∏—Ä–µ–∫—Ç –≤ –∫–∞–±–∏–Ω–µ—Ç
            return redirect()->route('client.profile')->with('success', 'Order placed successfully! Welcome to your profile.');

        } catch (\Exception $e) {
            Log::error("Checkout Error: " . $e->getMessage());
            return back()->with('error', 'Checkout failed: ' . $e->getMessage());
        }
    }

    // --- TELEGRAM ---
    private function sendTelegramNotification($order)
    {
        $tenantId = $this->tenantService->getCurrentTenantId();
        
        $config = TelegramConfig::where('tenant_id', $tenantId)->where('is_active', true)->first();
        if (!$config) {
            $config = TelegramConfig::whereNull('tenant_id')->where('is_active', true)->first();
        }

        if ($config) {
            $itemsList = "";
            foreach ($order->items as $item) {
                $itemsList .= "- {$item->product_name} ({$item->size}) x{$item->quantity}\n";
            }

            $message = "üÜï *New Order #{$order->order_number}*\n" .
                       "Store: " . strtoupper($tenantId) . "\n" .
                       "Customer: {$order->customer_name}\n" .
                       "Phone: {$order->customer_phone}\n" .
                       "Total: *$" . $order->total_amount . "*\n" .
                       "----------------\n" .
                       $itemsList . 
                       "\nDelivery: {$order->shipping_method}\n" .
                       "Address: {$order->shipping_address}";

            try {
                Http::post("https://api.telegram.org/bot{$config->bot_token}/sendMessage", [
                    'chat_id' => $config->chat_id,
                    'text' => $message,
                    'parse_mode' => 'Markdown',
                ]);
            } catch (\Exception $e) {
                Log::error("Telegram Send Error: " . $e->getMessage());
            }
        }
    }
}
</file>

<file path="app/Models/Order.php">
<?php
// FILE: app/Models/Order.php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Order extends Model
{
    use HasFactory;

    protected $fillable = [
        'order_number',
        'user_id',
        'customer_name',
        'customer_email',
        'customer_phone',
        'shipping_method',
        'shipping_address',
        'payment_method',
        'payment_status',
        'subtotal',
        'discount_amount',
        'total_amount',
        'promo_code',
        'status',
        'is_instagram',
    ];

    protected $casts = [
        'is_instagram' => 'boolean',
        'subtotal' => 'decimal:2',
        'total_amount' => 'decimal:2',
        'discount_amount' => 'decimal:2',
    ];

    // –•–ï–õ–ü–ï–† –î–õ–Ø –¶–í–ï–¢–û–í –°–¢–ê–¢–£–°–ê (–í–æ–∑–≤—Ä–∞—â–µ–Ω –ø–æ –∑–∞–ø—Ä–æ—Å—É)
    // –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ Blade: {{ $order->status_color }}
    public function getStatusColorAttribute()
    {
        return match ($this->status) {
            'new' => 'bg-blue-100 text-blue-800',
            'processing' => 'bg-yellow-100 text-yellow-800',
            'shipped' => 'bg-purple-100 text-purple-800',
            'completed' => 'bg-green-100 text-green-800',
            'cancelled' => 'bg-red-100 text-red-800',
            default => 'bg-gray-100 text-gray-800',
        };
    }

    public function items()
    {
        return $this->hasMany(OrderItem::class);
    }

    public function user()
    {
        return $this->belongsTo(User::class);
    }
}
</file>

<file path="app/Http/Controllers/ShopController.php">
<?php
// FILE: app/Http/Controllers/ShopController.php

namespace App\Http\Controllers;

use App\Models\Product;
use App\Models\Category;
use App\Services\TenantService;
use Illuminate\Http\Request;

class ShopController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    private function resolveTenant()
    {
        $host = request()->getHost();
        $map = $this->tenantService->getDomainMap();
        $tenantId = $map[$host] ?? 'default';
        $this->tenantService->switchTenant($tenantId);
        return $tenantId;
    }

    public function index()
    {
        $tenantId = $this->resolveTenant();

        // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–≤–∞—Ä—ã –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞
        $products = Product::with('clothingLine')
            ->where('stock_quantity', '>', 0)
            ->latest()
            ->paginate(12);
            
        $categories = Category::all();

        // –õ–û–ì–ò–ö–ê –í–´–ë–û–†–ê –®–ê–ë–õ–û–ù–ê
        // 1. –ò—â–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π —à–∞–±–ª–æ–Ω: resources/views/tenants/{id}/home.blade.php
        $view = "tenants.{$tenantId}.home";
        
        // 2. –ï—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç (–º—ã –∏—Ö —É–¥–∞–ª–∏–ª–∏ –¥–ª—è —É–Ω–∏—Ñ–∏–∫–∞—Ü–∏–∏), –±–µ—Ä–µ–º –û–ë–©–ò–ô: resources/views/shop/home.blade.php
        if (!view()->exists($view)) {
            $view = 'shop.home'; // –ë–´–õ–û: shop.fallback_home (–û–®–ò–ë–ö–ê) -> –°–¢–ê–õ–û: shop.home
        }

        return view($view, compact('products', 'categories'));
    }

    public function show($slug)
    {
        $tenantId = $this->resolveTenant();

        $product = Product::where('slug', $slug)
            ->with(['variants', 'clothingLine', 'images'])
            ->firstOrFail();

        // –õ–û–ì–ò–ö–ê –í–´–ë–û–†–ê –®–ê–ë–õ–û–ù–ê –¢–û–í–ê–†–ê
        $view = "tenants.{$tenantId}.product";
        
        if (!view()->exists($view)) {
            $view = 'shop.product'; // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Ç–æ–≤–∞—Ä–∞
        }

        return view($view, compact('product'));
    }
}
</file>

<file path="app/Http/Controllers/Admin/UserController.php">
<?php
// FILE: app/Http/Controllers/Admin/UserController.php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\User;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Hash;
use Illuminate\Validation\Rule;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\DB;

class UserController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    // –•–µ–ª–ø–µ—Ä –¥–ª—è –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (–£–∫—Ä–∞–∏–Ω–∞)
    private function normalizePhone($phone)
    {
        // –£–¥–∞–ª—è–µ–º –≤—Å–µ –∫—Ä–æ–º–µ —Ü–∏—Ñ—Ä
        $phone = preg_replace('/[^0-9]/', '', $phone);
        
        // –ï—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 380... -> +380...
        if (str_starts_with($phone, '380')) {
            return '+' . $phone;
        }
        // –ï—Å–ª–∏ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å 0... (097...) -> +380...
        if (str_starts_with($phone, '0')) {
            return '+38' . $phone;
        }
        
        // –í –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å–ª—É—á–∞—è—Ö –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –µ—Å—Ç—å (–∏–ª–∏ –¥–æ–±–∞–≤–ª—è–µ–º +)
        return '+' . $phone;
    }

    private function switchToPublic()
    {
        DB::statement('SET search_path TO public');
    }

    public function index(Request $request)
    {
        // 1. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∏—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ PUBLIC —Å—Ö–µ–º–µ
        $this->switchToPublic();

        $query = User::where('role', 'client')->latest();

        // 2. –õ–æ–≥–∏–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        if (auth()->user()->role !== 'super_admin') {
            // –ú–µ–Ω–µ–¥–∂–µ—Ä –≤–∏–¥–∏—Ç —Å–≤–æ–∏—Ö + –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö
            $currentTenant = $this->tenantService->getCurrentTenantId();
            $query->where(function($q) use ($currentTenant) {
                $q->where('tenant_id', $currentTenant)
                  ->orWhereNull('tenant_id');
            });
        } elseif ($request->has('tenant_id') && $request->tenant_id) {
            // –°—É–ø–µ—Ä-–∞–¥–º–∏–Ω —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ –º–∞–≥–∞–∑–∏–Ω—É
            $query->where('tenant_id', $request->tenant_id);
        }

        if ($request->has('search') && $request->search) {
            $search = $request->search;
            $query->where(function($q) use ($search) {
                $q->where('name', 'like', "%{$search}%")
                  ->orWhere('email', 'like', "%{$search}%")
                  ->orWhere('phone', 'like', "%{$search}%");
            });
        }

        $users = $query->paginate(20);
        
        // –ü–µ—Ä–µ–¥–∞–µ–º —Ç–µ–∫—É—â–∏–π tenant_id –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ —Å—Å—ã–ª–∫–∞—Ö (—Ö–æ—Ç—è –¥–ª—è users —ç—Ç–æ –º–µ–Ω–µ–µ –∫—Ä–∏—Ç–∏—á–Ω–æ)
        $currentTenantId = auth()->user()->role === 'super_admin' ? $request->get('tenant_id') : $this->tenantService->getCurrentTenantId();

        return view('admin.users.index', compact('users', 'currentTenantId'));
    }

    public function create()
    {
        $user = new User();
        $tenants = config('tenants.tenants');
        return view('admin.users.form', compact('user', 'tenants'));
    }

    public function store(Request $request)
    {
        $this->switchToPublic(); // –ü–∏—à–µ–º –≤ public

        $isSuperAdmin = auth()->user()->role === 'super_admin';

        $validated = $request->validate([
            'name' => 'required|string|max:255',
            'email' => 'nullable|email|unique:users,email',
            'phone' => 'required|string|unique:users,phone',
            'password' => 'required|string|min:6',
            'tenant_id' => $isSuperAdmin ? 'nullable|string' : 'nullable',
        ]);

        // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞
        $phone = $this->normalizePhone($validated['phone']);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ü–û–°–õ–ï –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏–∏
        if (User::where('phone', $phone)->exists()) {
             return back()->withErrors(['phone' => 'This phone number is already registered.'])->withInput();
        }

        // –û–ü–†–ï–î–ï–õ–ï–ù–ò–ï –ú–ê–ì–ê–ó–ò–ù–ê
        $tenantId = null;
        if ($isSuperAdmin) {
            $tenantId = $request->input('tenant_id');
        } else {
            // –ï—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä —Å–æ–∑–¥–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - –æ–Ω –ü–†–ò–í–Ø–ó–´–í–ê–ï–¢–°–Ø –∫ –º–∞–≥–∞–∑–∏–Ω—É –º–µ–Ω–µ–¥–∂–µ—Ä–∞
            $tenantId = $this->tenantService->getCurrentTenantId();
        }

        $accessKey = $validated['password']; 

        User::create([
            'name' => $validated['name'],
            'email' => $validated['email'],
            'phone' => $phone,
            'password' => Hash::make($validated['password']),
            'role' => 'client',
            'tenant_id' => $tenantId, // –¢–µ–ø–µ—Ä—å –º–µ–Ω–µ–¥–∂–µ—Ä –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Å–≤–æ–π ID
            'access_key' => $accessKey,
        ]);

        return redirect()->route('admin.users.index')->with('success', 'Customer created successfully.');
    }

    // –ò–°–ü–û–õ–¨–ó–£–ï–ú $id –í–ú–ï–°–¢–û Model Binding, –ß–¢–û–ë–´ –ò–ó–ë–ï–ñ–ê–¢–¨ 404 –í –ß–£–ñ–û–ô –°–•–ï–ú–ï
    public function show($id)
    {
        $this->switchToPublic();
        $user = User::findOrFail($id);
        return view('admin.users.show', compact('user'));
    }

    public function edit($id)
    {
        $this->switchToPublic();
        $user = User::findOrFail($id);
        $tenants = config('tenants.tenants');
        return view('admin.users.form', compact('user', 'tenants'));
    }

    public function update(Request $request, $id)
    {
        $this->switchToPublic();
        $user = User::findOrFail($id);

        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–∞—Ä–æ–ª—è (–∫–Ω–æ–ø–∫–∞ Reset)
        if ($request->has('generate_password')) {
            $newPassword = Str::random(8);
            $user->update([
                'password' => Hash::make($newPassword),
                'access_key' => $newPassword
            ]);
            return back()->with('success', "New Key Generated: $newPassword");
        }

        $validated = $request->validate([
            'name' => 'required|string|max:255',
            'email' => ['nullable', 'email', Rule::unique('users')->ignore($user->id)],
            'phone' => ['required', 'string'], // –£–±—Ä–∞–ª–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å –∑–¥–µ—Å—å, –ø—Ä–æ–≤–µ—Ä–∏–º –≤—Ä—É—á–Ω—É—é
            'password' => 'nullable|string|min:6',
        ]);

        $phone = $this->normalizePhone($validated['phone']);

        // –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏
        if (User::where('phone', $phone)->where('id', '!=', $user->id)->exists()) {
            return back()->withErrors(['phone' => 'This phone number is taken by another user.'])->withInput();
        }

        $data = [
            'name' => $validated['name'],
            'email' => $validated['email'],
            'phone' => $phone,
        ];

        if ($request->filled('password')) {
            $data['password'] = Hash::make($validated['password']);
            $data['access_key'] = $validated['password'];
        }

        $user->update($data);

        return redirect()->route('admin.users.index')->with('success', 'Customer profile updated.');
    }
    
    public function destroy($id)
    {
        if (auth()->user()->role !== 'super_admin') {
            abort(403);
        }
        $this->switchToPublic();
        User::destroy($id);
        return back()->with('success', 'User deleted.');
    }
}
</file>

<file path="app/Models/Product.php">
<?php
// FILE: app/Models/Product.php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;
use App\Models\PromoCode;
use App\Services\TenantService;

class Product extends Model
{
    use HasFactory, SoftDeletes;

    protected $fillable = [
        'name', 'slug', 'description', 'price', 'sale_price',
        'sku', 'stock_quantity', 'attributes', 'clothing_line_id',
    ];

    protected $casts = [
        'attributes' => 'array',
        'price' => 'decimal:2',
        'sale_price' => 'decimal:2',
    ];

    public function categories()
    {
        return $this->belongsToMany(Category::class);
    }

    public function images()
    {
        return $this->hasMany(ProductImage::class)->orderBy('sort_order', 'asc');
    }

    public function variants()
    {
        return $this->hasMany(ProductVariant::class);
    }
    
    public function clothingLine()
    {
        return $this->belongsTo(ClothingLine::class);
    }

    // –°–∫–∏–¥–∫–∏
    public function getHasDiscountAttribute()
    {
        return $this->sale_price && $this->sale_price < $this->price;
    }

    public function getDiscountPercentageAttribute()
    {
        if (!$this->has_discount) return 0;
        return round((($this->price - $this->sale_price) / $this->price) * 100);
    }

    public function getCurrentPriceAttribute()
    {
        return $this->has_discount ? $this->sale_price : $this->price;
    }

    public function getCoverUrlAttribute()
    {
        $cover = $this->images->first();
        if ($cover) return $cover->url;
        $text = urlencode($this->sku ?? 'Product');
        return "https://placehold.co/600x600/e2e8f0/1e293b?text={$text}";
    }
    
    public function getImageUrlAttribute()
    {
        return $this->cover_url;
    }

    /**
     * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–º–æ–∫–æ–¥–æ–≤, –ø—Ä–∏–º–µ–Ω–∏–º—ã—Ö –∫ —ç—Ç–æ–º—É —Ç–æ–≤–∞—Ä—É.
     * –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ –Ω–µ —Å–∞–º—ã–π –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Å–ø–∏—Å–∫–æ–≤ –∏–∑ 1000 —Ç–æ–≤–∞—Ä–æ–≤,
     * –Ω–æ –¥–ª—è –∞–¥–º–∏–Ω–∫–∏ –∏ –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç–æ–≤–∞—Ä–∞ –ø–æ–¥–æ–π–¥–µ—Ç.
     */
    public function getApplicablePromosAttribute()
    {
        $tenantId = TenantService::getStaticCurrentTenantId();
        
        // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø—Ä–æ–º–æ–∫–æ–¥—ã
        $promos = PromoCode::where('is_active', true)
            ->where(function($q) {
                $q->whereNull('expires_at')->orWhere('expires_at', '>', now());
            })
            ->get();

        $applicable = [];

        foreach ($promos as $promo) {
            $scope = $promo->scope_type;
            $data = $promo->scope_data ?? [];

            // –ï—Å–ª–∏ –ø—Ä–æ–º–æ–∫–æ–¥ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —ç—Ç–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞ (–∏ –Ω–µ –≥–ª–æ–±–∞–ª—å–Ω—ã–π), –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
            if ($scope !== 'global' && !isset($data[$tenantId])) {
                continue;
            }

            $match = false;

            if ($scope === 'global') {
                $match = true;
            } elseif ($scope === 'specific') {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º ID —Ç–æ–≤–∞—Ä–∞
                if (in_array($this->id, $data[$tenantId] ?? [])) {
                    $match = true;
                }
            } elseif ($scope === 'category') {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                $productCatSlugs = $this->categories->pluck('slug')->toArray();
                $promoCatSlugs = $data[$tenantId] ?? [];
                if (!empty(array_intersect($productCatSlugs, $promoCatSlugs))) {
                    $match = true;
                }
            } elseif ($scope === 'line') {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–∏–Ω–µ–π–∫—É
                if ($this->clothingLine && in_array($this->clothingLine->slug, $data[$tenantId] ?? [])) {
                    $match = true;
                }
            }

            if ($match) {
                $applicable[] = $promo;
            }
        }

        return collect($applicable);
    }
}
</file>

<file path="app/Http/Controllers/Admin/ProductController.php">
<?php
// FILE: app/Http/Controllers/Admin/ProductController.php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Category;
use App\Models\Product;
use App\Models\ProductImage;
use App\Models\ProductVariant;
use App\Models\AttributeOption;
use App\Models\ClothingLine;
use App\Services\ProductService;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Str;
use Illuminate\Support\Collection;
use Illuminate\Support\Facades\DB; // –í–∞–∂–Ω–æ –¥–ª—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

class ProductController extends Controller
{
    protected TenantService $tenantService;
    protected ProductService $productService;

    public function __construct(TenantService $tenantService, ProductService $productService)
    {
        $this->tenantService = $tenantService;
        $this->productService = $productService;
    }

    // --- CONTEXT HELPERS (–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞) ---

    private function resolveContext(Request $request)
    {
        $user = auth()->user();
        
        // –ï—Å–ª–∏ –º–µ–Ω–µ–¥–∂–µ—Ä - —Ç–æ–ª—å–∫–æ –µ–≥–æ –º–∞–≥–∞–∑–∏–Ω
        if ($user->role !== 'super_admin') {
            return $this->tenantService->getCurrentTenantId();
        }

        // –ï—Å–ª–∏ —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω –ø–µ—Ä–µ–¥–∞–ª ID –º–∞–≥–∞–∑–∏–Ω–∞
        $tenantId = $request->get('tenant_id');
        if ($tenantId) {
            $this->tenantService->switchTenant($tenantId);
            return $tenantId;
        }

        // –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
        $current = $this->tenantService->getCurrentTenantId();
        if ($current) return $current;

        return null;
    }

    // --- ACTIONS (–ú–µ—Ç–æ–¥—ã –¥–µ–π—Å—Ç–≤–∏–π) ---

    public function index(Request $request)
    {
        $isSuperAdmin = auth()->user()->role === 'super_admin';
        $selectedTenant = $request->get('tenant_id');
        
        // –†–µ–∂–∏–º "ALL STORES" (–¢–æ–ª—å–∫–æ –¥–ª—è —Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∞ –±–µ–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–∞–≥–∞–∑–∏–Ω–∞)
        if ($isSuperAdmin && empty($selectedTenant)) {
            $products = $this->getAllTenantsProducts($request);
            // –ü—É—Å—Ç—ã–µ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
            $categories = new Collection(); 
            $sizes = new Collection(); 
            $types = new Collection();
            $lines = new Collection();
            $currentTenantId = null;
            return view('admin.products.index', compact('products', 'categories', 'sizes', 'types', 'lines', 'currentTenantId'));
        }

        // –†–µ–∂–∏–º "SINGLE STORE"
        $currentTenantId = $this->resolveContext($request);
        
        // –§–æ–ª–ª–±–µ–∫ –¥–ª—è –∞–¥–º–∏–Ω–∞: –µ—Å–ª–∏ –º–∞–≥–∞–∑–∏–Ω –Ω–µ –≤—ã–±—Ä–∞–Ω, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π
        if (!$currentTenantId && $isSuperAdmin) {
             $first = array_key_first(config('tenants.tenants'));
             $this->tenantService->switchTenant($first);
             $currentTenantId = $first;
        }

        // –ó–∞–ø—Ä–æ—Å —Ç–æ–≤–∞—Ä–æ–≤ —Å –∂–∞–¥–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–æ–π —Å–≤—è–∑–µ–π
        $query = Product::with(['categories', 'images', 'variants', 'clothingLine']);

        // --- –§–∏–ª—å—Ç—Ä—ã ---
        if ($request->filled('search')) {
            $query->where(fn($q) => $q->where('name', 'ilike', "%{$request->search}%")->orWhere('sku', 'ilike', "%{$request->search}%"));
        }
        if ($request->filled('category_id')) {
            $query->whereHas('categories', fn($q) => $q->where('categories.id', $request->category_id));
        }
        if ($request->filled('clothing_line_id')) {
            $query->where('clothing_line_id', $request->clothing_line_id);
        }
        if ($request->filled('size')) {
            $query->whereRaw("attributes->'size' ? ?", [$request->size]);
        }
        if ($request->filled('type')) {
            $query->whereRaw("attributes->>'type' = ?", [$request->type]);
        }

        $products = $query->latest()->paginate(20)->withQueryString();
        
        // –î–æ–±–∞–≤–ª—è–µ–º URL –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        $tenantDomain = config('tenants.tenants.' . $currentTenantId . '.domain');
        foreach ($products as $product) {
            $product->preview_url = "http://{$tenantDomain}/products/{$product->slug}?preview=true";
            $product->tenant_name = config("tenants.tenants.{$currentTenantId}.name");
            $product->tenant_id = $currentTenantId;
        }

        // –î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Å–ø–∏—Å–∫–æ–≤ —Ñ–∏–ª—å—Ç—Ä–æ–≤
        $categories = Category::orderBy('name')->get();
        $lines = ClothingLine::orderBy('name')->get(); 
        $sizes = AttributeOption::where('type', 'size')->orderBy('value')->get();
        $types = AttributeOption::where('type', 'product_type')->orderBy('value')->get();

        return view('admin.products.index', compact('products', 'categories', 'sizes', 'types', 'lines', 'currentTenantId'));
    }

    // –§–æ—Ä–º–∞ —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    public function form(Request $request, $id = null)
    {
        $currentTenantId = $this->resolveContext($request);
        if (!$currentTenantId && auth()->user()->role === 'super_admin') {
             $first = array_key_first(config('tenants.tenants'));
             $this->tenantService->switchTenant($first);
             $currentTenantId = $first;
        }

        if ($id) {
            $product = Product::with(['categories', 'images', 'variants', 'clothingLine'])->findOrFail($id);
            $action = route('admin.products.update', $product->id);
            $method = 'PUT';
            $title = "Edit: " . $product->name;
            $tenantDomain = config('tenants.tenants.' . $currentTenantId . '.domain');
            $previewUrl = "http://{$tenantDomain}/products/{$product->slug}?preview=true";
        } else {
            $product = new Product();
            $action = route('admin.products.store');
            $method = 'POST';
            $title = "Add New Product";
            $previewUrl = null;
        }

        $categories = Category::all();
        $lines = ClothingLine::all(); 
        $sizes = AttributeOption::where('type', 'size')->get();
        $types = AttributeOption::where('type', 'product_type')->get();

        return view('admin.products.form', compact(
            'product', 'action', 'method', 'title', 'categories', 'lines', 'sizes', 'types', 'currentTenantId', 'previewUrl'
        ));
    }

    public function create(Request $request) { return $this->form($request); }
    public function edit(Request $request, $id) { return $this->form($request, $id); }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞
    public function store(Request $request)
    {
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –º–∞–≥–∞–∑–∏–Ω, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if (auth()->user()->role === 'super_admin' && $request->has('target_tenant')) {
            $this->tenantService->switchTenant($request->target_tenant);
        } else {
            $this->resolveContext($request);
        }

        $validated = $this->validateProduct($request);

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é: –≤—Å—ë –∏–ª–∏ –Ω–∏—á–µ–≥–æ
        DB::transaction(function () use ($request, $validated) {
            
            // 1. –°—á–∏—Ç–∞–µ–º –æ–±—â–∏–π —Å—Ç–æ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
            $variantsInput = $request->input('variants', []);
            $totalStock = 0;
            $sizeList = [];
            
            foreach ($variantsInput as $v) {
                if (!empty($v['size'])) {
                    $totalStock += (int)($v['stock'] ?? 0);
                    $sizeList[] = $v['size'];
                }
            }

            // 2. –ù–∞—Ö–æ–¥–∏–º –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –õ–∏–Ω–µ–π–∫—É –û–¥–µ–∂–¥—ã
            $lineId = $this->resolveClothingLineId($request->clothing_line);

            // 3. –°–æ–∑–¥–∞–µ–º –ø—Ä–æ–¥—É–∫—Ç (–í–∫–ª—é—á–∞—è sale_price)
            $product = $this->productService->create([
                'name' => $validated['name'],
                'slug' => Str::slug($validated['name']) . '-' . Str::random(4),
                'price' => $validated['price'],
                'sale_price' => $validated['sale_price'] ?? null, // –°–∫–∏–¥–∫–∞
                'sku' => $validated['sku'],
                'stock_quantity' => $totalStock, // –í—ã—á–∏—Å–ª–µ–Ω–Ω—ã–π —Å—Ç–æ–∫
                'description' => $request->input('description'),
                'clothing_line_id' => $lineId,
                'attributes' => [
                    'type' => $request->attributes_type,
                    'size' => $sizeList,
                ]
            ]);

            // 4. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º —Å–≤—è–∑–∏
            $this->syncAttributesData($request->attributes_type, $sizeList);
            $this->syncCategories($product, $request->categories);
            $this->syncImages($request, $product);
            $this->syncVariants($product, $variantsInput);
        });

        return redirect()->route('admin.products.index', ['tenant_id' => $this->tenantService->getCurrentTenantId()])
                         ->with('success', 'Product created successfully.');
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞
    public function update(Request $request, $id)
    {
        $this->resolveContext($request);
        $product = Product::findOrFail($id);
        
        $validated = $this->validateProduct($request, $id);
        
        DB::transaction(function () use ($request, $product, $validated) {
            
            // 1. –ü–µ—Ä–µ—Å—á–µ—Ç —Å—Ç–æ–∫–∞
            $variantsInput = $request->input('variants', []);
            $totalStock = 0;
            $sizeList = [];
            
            foreach ($variantsInput as $v) {
                if (!empty($v['size'])) {
                    $totalStock += (int)($v['stock'] ?? 0);
                    $sizeList[] = $v['size'];
                }
            }

            // 2. –õ–∏–Ω–µ–π–∫–∞
            $lineId = $this->resolveClothingLineId($request->clothing_line);

            // 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª–µ–π (–í–∫–ª—é—á–∞—è sale_price)
            $product->update([
                'name' => $validated['name'],
                'price' => $validated['price'],
                'sale_price' => $validated['sale_price'] ?? null, // –°–∫–∏–¥–∫–∞
                'sku' => $validated['sku'],
                'stock_quantity' => $totalStock,
                'description' => $request->input('description'),
                'clothing_line_id' => $lineId,
                'attributes' => [
                    'type' => $request->attributes_type,
                    'size' => $sizeList,
                ]
            ]);

            // 4. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å–≤—è–∑–µ–π
            $this->syncAttributesData($request->attributes_type, $sizeList);
            $this->syncCategories($product, $request->categories);
            $this->syncImagesUpdate($request, $product);
            $this->syncVariants($product, $variantsInput);
        });

        return redirect()->route('admin.products.index', ['tenant_id' => $this->tenantService->getCurrentTenantId()])
                         ->with('success', 'Product updated successfully.');
    }

    public function destroy(Request $request, $id)
    {
        $this->resolveContext($request);
        $product = Product::findOrFail($id);
        $this->productService->delete($product);
        return back()->with('success', 'Product deleted.');
    }

    // --- PRIVATE HELPERS (–ü—Ä–∏–≤–∞—Ç–Ω—ã–µ –º–µ—Ç–æ–¥—ã) ---

    private function validateProduct(Request $request, $id = null)
    {
        return $request->validate([
            'name' => 'required|string|max:255',
            'price' => 'required|numeric|min:0',
            // –°–∫–∏–¥–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –º–µ–Ω—å—à–µ –æ–±—ã—á–Ω–æ–π —Ü–µ–Ω—ã
            'sale_price' => 'nullable|numeric|min:0|lt:price', 
            'sku' => 'required|string|max:50',
            'categories' => 'required|array',
            'attributes_type' => 'required|string',
            'clothing_line' => 'nullable|string|max:255',
            
            'variants.*.size' => 'required|string',
            'variants.*.stock' => 'required|integer|min:0',
            
            'images.*' => 'image|max:10240',
            'new_images.*' => 'image|max:10240',
        ]);
    }

    private function resolveClothingLineId(?string $name): ?int
    {
        if (empty($name)) return null;
        $slug = Str::slug($name);
        $line = ClothingLine::firstOrCreate(['slug' => $slug], ['name' => $name]);
        return $line->id;
    }

    private function syncAttributesData($type, $sizes)
    {
        $typeSlug = Str::slug($type);
        AttributeOption::firstOrCreate(['type' => 'product_type', 'slug' => $typeSlug], ['value' => $type]);
        foreach ($sizes as $sizeName) {
            $sizeSlug = Str::slug($sizeName);
            AttributeOption::firstOrCreate(['type' => 'size', 'slug' => $sizeSlug], ['value' => $sizeName]);
        }
    }

    private function syncCategories(Product $product, array $categoriesInput)
    {
        $categoryIds = [];
        foreach ($categoriesInput as $input) {
            if (is_numeric($input)) {
                $categoryIds[] = $input;
            } else {
                $slug = Str::slug($input);
                $newCat = Category::firstOrCreate(['slug' => $slug], ['name' => $input]);
                $categoryIds[] = $newCat->id;
            }
        }
        $product->categories()->sync($categoryIds);
    }

    private function syncImages(Request $request, Product $product)
    {
        if ($request->hasFile('images')) {
            foreach ($request->file('images') as $index => $file) {
                $path = $file->store('media', 'tenant');
                ProductImage::create(['product_id' => $product->id, 'path' => $path, 'sort_order' => $index]);
            }
        }
    }

    private function syncImagesUpdate(Request $request, Product $product)
    {
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö
        if ($request->hasFile('new_images')) {
            $maxOrder = $product->images()->max('sort_order') ?? -1;
            foreach ($request->file('new_images') as $file) {
                $path = $file->store('media', 'tenant');
                ProductImage::create(['product_id' => $product->id, 'path' => $path, 'sort_order' => ++$maxOrder]);
            }
        }
        // –£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö
        if ($request->filled('deleted_images')) {
            $images = ProductImage::whereIn('id', $request->input('deleted_images'))->where('product_id', $product->id)->get();
            foreach ($images as $img) {
                Storage::disk('tenant')->delete($img->path);
                $img->delete();
            }
        }
        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        if ($request->filled('sorted_images_ids')) {
            $sortedIds = explode(',', $request->input('sorted_images_ids'));
            foreach ($sortedIds as $index => $imgId) {
                ProductImage::where('id', $imgId)->where('product_id', $product->id)->update(['sort_order' => $index]);
            }
        }
    }

    private function syncVariants(Product $product, array $variantsInput)
    {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ
        $product->variants()->delete();
        foreach ($variantsInput as $v) {
            if (!empty($v['size'])) {
                ProductVariant::create([
                    'product_id' => $product->id, 
                    'size' => $v['size'], 
                    'stock' => (int)($v['stock'] ?? 0)
                ]);
            }
        }
    }
    
    // –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤ —Å–æ –≤—Å–µ—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤ (–¥–ª—è Super Admin)
    private function getAllTenantsProducts(Request $request) {
        $allProducts = new Collection();
        foreach (config('tenants.tenants') as $id => $config) {
            try {
                $this->tenantService->switchTenant($id);
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–º–µ—Å—Ç–µ —Å clothingLine
                $query = Product::with(['categories', 'images', 'variants', 'clothingLine'])->latest()->take(5);
                
                if ($request->filled('search')) {
                    $s = $request->search;
                    $query->where(fn($q) => $q->where('name', 'ilike', "%$s%")->orWhere('sku', 'ilike', "%$s%"));
                }
                $products = $query->get();
                $products->each(function($p) use ($config, $id) {
                    $p->tenant_name = $config['name'];
                    $p->tenant_id = $id;
                    $p->preview_url = "http://{$config['domain']}/products/{$p->slug}?preview=true";
                });
                $allProducts = $allProducts->merge($products);
            } catch (\Exception $e) { continue; }
        }
        return $allProducts;
    }
}
</file>

</files>
