This file is a merged representation of a subset of the codebase, containing specifically included files, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: app/Models/**/*, app/Http/Controllers/**/*
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
app/
  Http/
    Controllers/
      Admin/
        AttributeController.php
        AuthController.php
        CategoryController.php
        ClothingLineController.php
        ContactMessageController.php
        DashboardController.php
        InventoryController.php
        ManagerController.php
        OrderExportController.php
        OrderManagementController.php
        OrderStatusController.php
        ProductController.php
        PromoCodeController.php
        ReportController.php
        SettingsController.php
        TelegramSettingsController.php
        UserController.php
      Api/
        ProductController.php
      Client/
        AuthController.php
        ContactController.php
        ProfileController.php
      CartController.php
      Controller.php
      ShopController.php
  Models/
    AttributeOption.php
    Category.php
    ClothingLine.php
    ContactMessage.php
    Order.php
    OrderItem.php
    Product.php
    ProductImage.php
    ProductVariant.php
    PromoCode.php
    TelegramConfig.php
    TenantSetting.php
    User.php
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="app/Http/Controllers/Admin/AuthController.php">
<?php
// FILE: app/Http/Controllers/Admin/AuthController.php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;

class AuthController extends Controller
{
    public function showLoginForm()
    {
        if (Auth::check()) {
            return redirect()->route('admin.dashboard');
        }
        return view('admin.auth.login');
    }

    public function login(Request $request)
    {
        $credentials = $request->validate([
            'email' => ['required', 'email'],
            'password' => ['required'],
        ]);

        // ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð²Ñ…Ð¾Ð´Ð° Ð² Ð¢Ð•ÐšÐ£Ð©Ð•Ð™ ÑÑ…ÐµÐ¼Ðµ
        // Ð¢Ð°Ðº ÐºÐ°Ðº ÐÐ´Ð¼Ð¸Ð½ Ñ‚ÐµÐ¿ÐµÑ€ÑŒ ÐµÑÑ‚ÑŒ Ð²ÐµÐ·Ð´Ðµ, ÑÑ‚Ð¾ ÑÑ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð¸ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð°, Ð¸ Ð´Ð»Ñ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ð°
        if (Auth::attempt($credentials)) {
            $request->session()->regenerate();

            $user = Auth::user();
            
            // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ„Ð»Ð°Ð³ ÑÑƒÐ¿ÐµÑ€-Ð°Ð´Ð¼Ð¸Ð½Ð° Ð² ÑÐµÑÑÐ¸ÑŽ Ð´Ð»Ñ ÑƒÐ´Ð¾Ð±ÑÑ‚Ð²Ð° Ð² Blade
            if ($user->role === 'super_admin') {
                $request->session()->put('is_super_admin', true);
            } else {
                $request->session()->put('is_super_admin', false);
            }

            return redirect()->route('admin.dashboard');
        }

        return back()->withErrors([
            'email' => 'The provided credentials do not match our records.',
        ]);
    }

    public function logout(Request $request)
    {
        Auth::logout();
        $request->session()->invalidate();
        $request->session()->regenerateToken();
        return redirect()->route('admin.login');
    }
}
</file>

<file path="app/Http/Controllers/Admin/ClothingLineController.php">
<?php
// FILE: app/Http/Controllers/Admin/ClothingLineController.php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\ClothingLine;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Support\Str;

class ClothingLineController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    // Ð¥ÐµÐ»Ð¿ÐµÑ€ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð° (Ð°Ð½Ð°Ð»Ð¾Ð³Ð¸Ñ‡Ð½Ð¾ Ð´Ñ€ÑƒÐ³Ð¸Ð¼ ÐºÐ¾Ð½Ñ‚Ñ€Ð¾Ð»Ð»ÐµÑ€Ð°Ð¼)
    private function resolveContext(Request $request)
    {
        if (auth()->user()->role !== 'super_admin') {
            return $this->tenantService->getCurrentTenantId();
        }

        // Ð”ÐµÑ„Ð¾Ð»Ñ‚ Ð¸Ð»Ð¸ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¹ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½
        $tenantId = $request->tenant_id ?? array_key_first(config('tenants.tenants'));
        
        if ($tenantId) {
            $this->tenantService->switchTenant($tenantId);
        }
        
        return $tenantId;
    }

    public function index(Request $request)
    {
        $currentTenantId = $this->resolveContext($request);
        
        $query = ClothingLine::withCount('products');
        
        if ($request->filled('search')) {
            $query->where('name', 'ilike', "%{$request->search}%");
        }

        $lines = $query->orderBy('name')->get();

        return view('admin.clothing_lines.index', compact('lines', 'currentTenantId'));
    }

    public function store(Request $request)
    {
        $this->resolveContext($request);
        
        $validated = $request->validate(['name' => 'required|string|max:255']);
        $slug = Str::slug($validated['name']);

        ClothingLine::firstOrCreate(
            ['slug' => $slug],
            ['name' => $validated['name']]
        );

        return back()->with('success', 'Collection created/found.');
    }

    public function update(Request $request, $id)
    {
        $this->resolveContext($request);
        $line = ClothingLine::findOrFail($id);
        
        $validated = $request->validate(['name' => 'required|string|max:255']);
        
        try {
            $line->update([
                'name' => $validated['name'],
                'slug' => Str::slug($validated['name'])
            ]);
        } catch (\Exception $e) {
            return back()->with('error', 'Collection with this name already exists.');
        }
        
        return back()->with('success', 'Collection updated.');
    }

    public function destroy(Request $request, $id)
    {
        $this->resolveContext($request);
        ClothingLine::destroy($id);
        return back()->with('success', 'Collection deleted.');
    }
}
</file>

<file path="app/Http/Controllers/Admin/ContactMessageController.php">
<?php

// FILE: app/Http/Controllers/Admin/ContactMessageController.php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\ContactMessage;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Pagination\LengthAwarePaginator;

class ContactMessageController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    public function index(Request $request)
    {
        $user = auth()->user();
        $isSuperAdmin = $user->role === 'super_admin';
        
        // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚
        $currentTenantId = null;
        if ($isSuperAdmin) {
            $currentTenantId = $request->get('tenant_id');
        } else {
            $currentTenantId = $this->tenantService->getCurrentTenantId();
        }

        $messages = collect();
        $paginatedMessages = null;

        if ($currentTenantId) {
            // 1. ÐšÐžÐÐšÐ Ð•Ð¢ÐÐ«Ð™ ÐœÐÐ“ÐÐ—Ð˜Ð
            $this->tenantService->switchTenant($currentTenantId);
            $paginatedMessages = ContactMessage::latest()->paginate(20);
            // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¸Ð½Ñ„Ñƒ Ð¾ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ðµ Ð´Ð»Ñ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ
            $paginatedMessages->getCollection()->transform(function ($msg) use ($currentTenantId) {
                $msg->tenant_id = $currentTenantId;
                $msg->tenant_name = config("tenants.tenants.{$currentTenantId}.name");
                return $msg;
            });
        } else {
            // 2. Ð’Ð¡Ð• ÐœÐÐ“ÐÐ—Ð˜ÐÐ« (Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð¡ÑƒÐ¿ÐµÑ€-ÐÐ´Ð¼Ð¸Ð½)
            // ÐÐ³Ñ€ÐµÐ³Ð°Ñ†Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¸Ð· Ð²ÑÐµÑ… ÑÑ…ÐµÐ¼
            $allMessages = collect();
            
            foreach (config('tenants.tenants') as $id => $config) {
                try {
                    $this->tenantService->switchTenant($id);
                    // Ð‘ÐµÑ€ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 20 Ð¸Ð· ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð¿ÐµÑ€ÐµÐ³Ñ€ÑƒÐ¶Ð°Ñ‚ÑŒ Ð¿Ð°Ð¼ÑÑ‚ÑŒ
                    $tenantMessages = ContactMessage::latest()->limit(20)->get();
                    
                    foreach ($tenantMessages as $msg) {
                        $msg->tenant_id = $id;
                        $msg->tenant_name = $config['name'];
                        $allMessages->push($msg);
                    }
                } catch (\Exception $e) {
                    continue;
                }
            }

            // Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð²ÑÐµ ÑÐ¾Ð±Ñ€Ð°Ð½Ð½Ñ‹Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¿Ð¾ Ð´Ð°Ñ‚Ðµ
            $sorted = $allMessages->sortByDesc('created_at')->values();
            
            // Ð ÑƒÑ‡Ð½Ð°Ñ Ð¿Ð°Ð³Ð¸Ð½Ð°Ñ†Ð¸Ñ Ð´Ð»Ñ ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸
            $perPage = 20;
            $page = $request->get('page', 1);
            $paginatedMessages = new LengthAwarePaginator(
                $sorted->forPage($page, $perPage),
                $sorted->count(),
                $perPage,
                $page,
                ['path' => $request->url(), 'query' => $request->query()]
            );
        }

        return view('admin.messages.index', [
            'messages' => $paginatedMessages,
            'currentTenantId' => $currentTenantId
        ]);
    }

    // ÐŸÐ¾Ð¼ÐµÑ‚Ð¸Ñ‚ÑŒ ÐºÐ°Ðº Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ð¾Ðµ / ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ
    public function show(Request $request, $id)
    {
        // Ð”Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° Ð½ÑƒÐ¶Ð½Ð¾ Ð·Ð½Ð°Ñ‚ÑŒ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð°
        $tenantId = $request->get('tenant_id');
        if (!$tenantId) {
            // Ð•ÑÐ»Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð½Ðµ Ð¿ÐµÑ€ÐµÐ´Ð°Ð½, Ð¿Ñ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ Ð´Ð»Ñ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ð°
            if (auth()->user()->role !== 'super_admin') {
                $tenantId = $this->tenantService->getCurrentTenantId();
            } else {
                return back()->with('error', 'Tenant ID required to view message.');
            }
        }

        $this->tenantService->switchTenant($tenantId);
        $message = ContactMessage::findOrFail($id);
        
        // ÐŸÐ¾Ð¼ÐµÑ‡Ð°ÐµÐ¼ ÐºÐ°Ðº Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ð¾Ðµ
        if (!$message->is_read) {
            $message->update(['is_read' => true]);
        }

        return view('admin.messages.show', compact('message', 'tenantId'));
    }

    public function destroy(Request $request, $id)
    {
        $tenantId = $request->get('tenant_id');
        if (auth()->user()->role !== 'super_admin' && !$tenantId) {
             $tenantId = $this->tenantService->getCurrentTenantId();
        }

        $this->tenantService->switchTenant($tenantId);
        ContactMessage::destroy($id);

        return redirect()->route('admin.messages.index', ['tenant_id' => $tenantId])
            ->with('success', 'Message deleted.');
    }
}
</file>

<file path="app/Http/Controllers/Admin/InventoryController.php">
<?php
// FILE: app/Http/Controllers/Admin/InventoryController.php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Product;
use App\Models\Category;
use App\Models\ClothingLine;
use App\Models\TelegramConfig; // Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚ Ð¼Ð¾Ð´ÐµÐ»Ð¸ Telegram
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Support\Collection;
use Illuminate\Support\Facades\Http;
use Illuminate\Pagination\LengthAwarePaginator;
use Symfony\Component\HttpFoundation\StreamedResponse;

class InventoryController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    private function resolveContext(Request $request)
    {
        $user = auth()->user();
        if ($user->role !== 'super_admin') {
            return $this->tenantService->getCurrentTenantId();
        }
        $tenantId = $request->get('tenant_id');
        if ($tenantId) {
            $this->tenantService->switchTenant($tenantId);
            return $tenantId;
        }
        
        // Ð•ÑÐ»Ð¸ Ð¡ÑƒÐ¿ÐµÑ€-ÐÐ´Ð¼Ð¸Ð½ Ð½Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð» ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½, Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ null (Ð·Ð½Ð°Ñ‡Ð¸Ñ‚ "Ð’ÑÐµ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ñ‹")
        // Ð•ÑÐ»Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ ÑƒÐ¶Ðµ Ð±Ñ‹Ð» ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½ middleware, ÑÐ±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ ÐµÐ³Ð¾ Ð´Ð»Ñ Ð»Ð¾Ð³Ð¸ÐºÐ¸ "Ð’ÑÐµÑ…"
        if ($request->has('tenant_id') && empty($request->tenant_id)) {
            return null;
        }

        return $this->tenantService->getCurrentTenantId();
    }

    public function index(Request $request)
    {
        $currentTenantId = $this->resolveContext($request);
        $isSuperAdmin = auth()->user()->role === 'super_admin';
        
        // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð±Ð¾Ñ‚Ð¾Ð² Ð´Ð»Ñ Ð²Ñ‹Ð¿Ð°Ð´Ð°ÑŽÑ‰ÐµÐ³Ð¾ ÑÐ¿Ð¸ÑÐºÐ°
        $telegramBots = $isSuperAdmin 
            ? TelegramConfig::where('is_active', true)->get() 
            : TelegramConfig::where('tenant_id', $currentTenantId)->orWhereNull('tenant_id')->where('is_active', true)->get();

        // Ð›Ð¾Ð³Ð¸ÐºÐ° ÑÐ±Ð¾Ñ€Ð° Ð´Ð°Ð½Ð½Ñ‹Ñ…
        $products = new Collection();
        $isGlobalView = $isSuperAdmin && empty($currentTenantId);

        if ($isGlobalView) {
            // Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÑÐ¾ Ð²ÑÐµÑ… Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð¾Ð²
            foreach (config('tenants.tenants') as $id => $config) {
                try {
                    $this->tenantService->switchTenant($id);
                    $storeProducts = $this->getFilteredQuery($request)->latest()->take(50)->get();
                    
                    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¼ÐµÑ‚ÐºÑƒ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð°
                    $storeProducts->each(function($p) use ($config) {
                        $p->tenant_name = $config['name'];
                    });
                    
                    $products = $products->merge($storeProducts);
                } catch (\Exception $e) { continue; }
            }
            // Ð ÑƒÑ‡Ð½Ð°Ñ Ð¿Ð°Ð³Ð¸Ð½Ð°Ñ†Ð¸Ñ Ð´Ð»Ñ Ð¾Ð±ÑŠÐµÐ´Ð¸Ð½ÐµÐ½Ð½Ð¾Ð¹ ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸ (Ð´Ð»Ñ ÐºÑ€Ð°ÑÐ¾Ñ‚Ñ‹)
            $page = $request->get('page', 1);
            $perPage = 50;
            $products = new LengthAwarePaginator(
                $products->forPage($page, $perPage), 
                $products->count(), 
                $perPage, 
                $page, 
                ['path' => $request->url(), 'query' => $request->query()]
            );
        } else {
            // ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð°
            $products = $this->getFilteredQuery($request)->latest()->paginate(50)->withQueryString();
        }

        // --- EXPORT LOGIC ---
        if ($request->get('action') === 'export_csv') {
            // Ð”Ð»Ñ ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð° Ð±ÐµÑ€ÐµÐ¼ Ð¿Ð¾Ð»Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð±ÐµÐ· Ð¿Ð°Ð³Ð¸Ð½Ð°Ñ†Ð¸Ð¸
            $exportData = $isGlobalView ? $this->getAllTenantsData($request) : $this->getFilteredQuery($request)->get();
            return $this->exportCsv($exportData, $currentTenantId ?? 'All_Stores');
        }

        // Load filters (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð²Ñ‹Ð±Ñ€Ð°Ð½ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½, Ð¸Ð½Ð°Ñ‡Ðµ ÑÐ¿Ð¸ÑÐºÐ¸ Ð¿ÑƒÑÑ‚Ñ‹Ðµ)
        $categories = $currentTenantId ? Category::orderBy('name')->get() : collect();
        $lines = $currentTenantId ? ClothingLine::orderBy('name')->get() : collect();

        return view('admin.inventory.index', compact('products', 'categories', 'lines', 'currentTenantId', 'telegramBots'));
    }

    /**
     * ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° Ð² Telegram
     */
    public function sendToTelegram(Request $request)
    {
        $request->validate([
            'telegram_config_id' => 'required|exists:public.telegram_configs,id',
        ]);

        $config = TelegramConfig::findOrFail($request->telegram_config_id);
        $currentTenantId = $this->resolveContext($request);
        $isGlobalView = auth()->user()->role === 'super_admin' && empty($currentTenantId);

        // 1. Ð¡Ð¾Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ
        $data = $isGlobalView ? $this->getAllTenantsData($request) : $this->getFilteredQuery($request)->get();
        
        // 2. Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ CSV ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ (ÑÑ‚Ñ€Ð¾ÐºÐ°)
        $csvContent = $this->generateCsvString($data);
        $fileName = 'inventory_report_' . date('Y-m-d_H-i') . '.csv';

        // 3. Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
        $totalItems = $data->sum('stock_quantity');
        $totalValue = $data->sum(fn($p) => $p->stock_quantity * ($p->sale_price ?? $p->price));
        
        $message = "ðŸ“Š *Inventory Report*\n" .
                   "Store: " . ($currentTenantId ?? 'ALL STORES') . "\n" .
                   "Date: " . date('Y-m-d H:i') . "\n" .
                   "Total Items: *{$totalItems}*\n" .
                   "Total Value: *$" . number_format($totalValue, 2) . "*";

        // 4. ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· Telegram API (multipart/form-data)
        try {
            // Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ñ‚ÐµÐºÑÑ‚
            Http::post("https://api.telegram.org/bot{$config->bot_token}/sendMessage", [
                'chat_id' => $config->chat_id,
                'text' => $message,
                'parse_mode' => 'Markdown',
            ]);

            // ÐŸÐ¾Ñ‚Ð¾Ð¼ Ñ„Ð°Ð¹Ð»
            $response = Http::attach(
                'document', $csvContent, $fileName
            )->post("https://api.telegram.org/bot{$config->bot_token}/sendDocument", [
                'chat_id' => $config->chat_id,
                'caption' => 'ðŸ“‚ Full report attached (Excel compatible)',
            ]);

            if ($response->successful()) {
                return back()->with('success', 'Report sent to Telegram successfully.');
            } else {
                return back()->with('error', 'Telegram Error: ' . $response->body());
            }

        } catch (\Exception $e) {
            return back()->with('error', 'Failed to send: ' . $e->getMessage());
        }
    }

    // --- HELPERS ---

    private function getFilteredQuery(Request $request)
    {
        $query = Product::with(['categories', 'variants', 'clothingLine']);

        if ($request->filled('search')) {
            $query->where(fn($q) => $q->where('name', 'ilike', "%{$request->search}%")
                                      ->orWhere('sku', 'ilike', "%{$request->search}%"));
        }
        if ($request->filled('category_id')) {
            $query->whereHas('categories', fn($q) => $q->where('categories.id', $request->category_id));
        }
        if ($request->filled('clothing_line_id')) {
            $query->where('clothing_line_id', $request->clothing_line_id);
        }
        if ($request->filled('stock_status')) {
            if ($request->stock_status === 'out_of_stock') {
                $query->where('stock_quantity', '<=', 0);
            } elseif ($request->stock_status === 'low_stock') {
                $query->where('stock_quantity', '>', 0)->where('stock_quantity', '<', 5);
            } elseif ($request->stock_status === 'in_stock') {
                $query->where('stock_quantity', '>=', 5);
            }
        }
        return $query;
    }

    private function getAllTenantsData(Request $request)
    {
        $allData = new Collection();
        foreach (config('tenants.tenants') as $id => $config) {
            try {
                $this->tenantService->switchTenant($id);
                $products = $this->getFilteredQuery($request)->get();
                $products->each(function($p) use ($config) {
                    $p->tenant_name = $config['name'];
                });
                $allData = $allData->merge($products);
            } catch (\Exception $e) { continue; }
        }
        return $allData;
    }

    private function generateCsvString(Collection $products)
    {
        $output = fopen('php://temp', 'r+');
        fputs($output, "\xEF\xBB\xBF"); // BOM
        fputcsv($output, ['Store', 'SKU', 'Product Name', 'Category', 'Collection', 'Size Variants', 'Price', 'Stock', 'Value']);

        foreach ($products as $product) {
            $variantsStr = $product->variants->map(fn($v) => "{$v->size}: {$v->stock}")->join(' | ');
            $categoriesStr = $product->categories->pluck('name')->join(', ');
            $totalValue = $product->stock_quantity * ($product->sale_price ?? $product->price);
            
            fputcsv($output, [
                $product->tenant_name ?? 'Current',
                $product->sku,
                $product->name,
                $categoriesStr,
                $product->clothingLine->name ?? '-',
                $variantsStr ?: 'One Size',
                $product->price,
                $product->stock_quantity,
                number_format($totalValue, 2, '.', '')
            ]);
        }
        rewind($output);
        $content = stream_get_contents($output);
        fclose($output);
        return $content;
    }

    private function exportCsv(Collection $products, string $name)
    {
        $content = $this->generateCsvString($products);
        return response($content)
            ->header('Content-Type', 'text/csv')
            ->header('Content-Disposition', 'attachment; filename="inventory_' . $name . '.csv"');
    }
}
</file>

<file path="app/Http/Controllers/Admin/ManagerController.php">
<?php

//  File (app/Http/Controllers/Admin/ManagerController.php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\User;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Hash;
use Illuminate\Validation\Rule;

class ManagerController extends Controller
{
    public function index()
    {
        $managers = User::where('role', 'manager')->latest()->get();
        return view('admin.managers.index', compact('managers'));
    }

    public function create()
    {
        $tenants = config('tenants.tenants');
        // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÐµÐ´Ð¸Ð½ÑƒÑŽ Ñ„Ð¾Ñ€Ð¼Ñƒ. ÐŸÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ð°Ñ $manager Ð½Ðµ Ð¿ÐµÑ€ÐµÐ´Ð°ÐµÑ‚ÑÑ, ÑˆÐ°Ð±Ð»Ð¾Ð½ Ð¿Ð¾Ð¹Ð¼ÐµÑ‚, Ñ‡Ñ‚Ð¾ ÑÑ‚Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ.
        return view('admin.managers.form', compact('tenants'));
    }

    public function store(Request $request)
    {
        $validated = $request->validate([
            'name' => 'required|string|max:255',
            'email' => 'required|email|unique:users,email',
            'phone' => 'required|string|max:20',
            'password' => 'required|string|min:8',
            'tenant_id' => 'required|string',
        ]);

        User::create([
            'name' => $validated['name'],
            'email' => $validated['email'],
            'phone' => $validated['phone'],
            'password' => Hash::make($validated['password']),
            'role' => 'manager',
            'tenant_id' => $validated['tenant_id'],
        ]);

        return redirect()->route('admin.managers.index')->with('success', 'Manager created successfully.');
    }

    public function edit($id)
    {
        $manager = User::where('role', 'manager')->findOrFail($id);
        $tenants = config('tenants.tenants');
        // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ñ‚Ñƒ Ð¶Ðµ Ñ„Ð¾Ñ€Ð¼Ñƒ, Ð½Ð¾ Ð¿ÐµÑ€ÐµÐ´Ð°ÐµÐ¼ $manager Ð´Ð»Ñ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
        return view('admin.managers.form', compact('manager', 'tenants'));
    }

    public function update(Request $request, $id)
    {
        $manager = User::where('role', 'manager')->findOrFail($id);

        $validated = $request->validate([
            'name' => 'required|string|max:255',
            'email' => ['required', 'email', Rule::unique('users')->ignore($manager->id)],
            'phone' => 'required|string|max:20',
            'password' => 'nullable|string|min:8',
            'tenant_id' => 'required|string',
        ]);

        $data = [
            'name' => $validated['name'],
            'email' => $validated['email'],
            'phone' => $validated['phone'],
            'tenant_id' => $validated['tenant_id'],
        ];

        if ($request->filled('password')) {
            $data['password'] = Hash::make($validated['password']);
        }

        $manager->update($data);

        return redirect()->route('admin.managers.index')->with('success', 'Manager updated successfully.');
    }

    public function destroy($id)
    {
        $manager = User::where('role', 'manager')->findOrFail($id);
        $manager->delete();

        return back()->with('success', 'Manager deleted.');
    }
}
</file>

<file path="app/Http/Controllers/Admin/OrderExportController.php">
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Order;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Storage;

class OrderExportController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    /**
     * Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð·Ð°ÐºÐ°Ð·Ð¾Ð² Ð² CSV
     */
    public function exportCsv(Request $request)
    {
        $tenantId = $request->get('tenant_id') ?? $this->tenantService->getCurrentTenantId();
        
        if (!$tenantId) {
            return back()->with('error', 'Tenant context required.');
        }

        $this->tenantService->switchTenant($tenantId);

        $orders = Order::with(['items', 'user'])->get();
        
        $csvData = $this->generateCsvData($orders);
        $filename = "orders_export_" . date('Y-m-d_H-i-s') . ".csv";
        
        Storage::disk('local')->put("exports/{$filename}", $csvData);
        
        return Storage::disk('local')->download("exports/{$filename}", $filename);
    }

    /**
     * Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ CSV
     */
    protected function generateCsvData($orders): string
    {
        $headers = [
            'Order ID', 'Order Number', 'Customer Name', 'Customer Phone', 'Customer Email',
            'Status', 'Total Amount', 'Shipping Method', 'Shipping Address',
            'Created At', 'Items Count'
        ];

        $rows = [];
        foreach ($orders as $order) {
            $rows[] = [
                $order->id,
                $order->order_number,
                $order->customer_name,
                $order->customer_phone,
                $order->customer_email,
                $order->status,
                $order->total_amount,
                $order->shipping_method,
                $order->shipping_address,
                $order->created_at->format('Y-m-d H:i:s'),
                $order->items->count()
            ];
        }

        $output = fopen('php://temp', 'w');
        fputcsv($output, $headers);
        
        foreach ($rows as $row) {
            fputcsv($output, $row);
        }
        
        rewind($output);
        $csv = stream_get_contents($output);
        fclose($output);
        
        return $csv;
    }

    /**
     * Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¿Ð¾ Ð·Ð°ÐºÐ°Ð·Ñƒ
     */
    public function exportOrderDetail(Request $request, $id)
    {
        $tenantId = $request->get('tenant_id') ?? $this->tenantService->getCurrentTenantId();
        
        if (!$tenantId) {
            return back()->with('error', 'Tenant context required.');
        }

        $this->tenantService->switchTenant($tenantId);
        
        $order = Order::with(['items.product', 'user'])->findOrFail($id);
        
        $data = [
            'order' => $order->toArray(),
            'items' => $order->items->toArray(),
            'exported_at' => now()->toDateTimeString(),
        ];
        
        $filename = "order_{$order->order_number}_" . date('Y-m-d_H-i-s') . ".json";
        
        Storage::disk('local')->put("exports/{$filename}", json_encode($data, JSON_PRETTY_PRINT));
        
        return Storage::disk('local')->download("exports/{$filename}", $filename);
    }

    /**
     * Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° Ð¿Ð¾ Ð·Ð°ÐºÐ°Ð·Ð°Ð¼ Ð·Ð° Ð¿ÐµÑ€Ð¸Ð¾Ð´
     */
    public function periodReport(Request $request)
    {
        $tenantId = $request->get('tenant_id') ?? $this->tenantService->getCurrentTenantId();
        
        if (!$tenantId) {
            return back()->with('error', 'Tenant context required.');
        }

        $request->validate([
            'start_date' => 'required|date',
            'end_date' => 'required|date|after_or_equal:start_date',
        ]);

        $this->tenantService->switchTenant($tenantId);

        $orders = Order::whereBetween('created_at', [
            $request->input('start_date'),
            $request->input('end_date')
        ])->get();

        $reportData = [
            'period' => [
                'start' => $request->input('start_date'),
                'end' => $request->input('end_date'),
            ],
            'summary' => [
                'total_orders' => $orders->count(),
                'total_amount' => $orders->sum('total_amount'),
                'avg_order_value' => $orders->avg('total_amount'),
                'status_distribution' => $orders->groupBy('status')->map->count(),
            ],
            'orders' => $orders
        ];

        return response()->json($reportData);
    }
}
</file>

<file path="app/Http/Controllers/Admin/OrderManagementController.php">
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Order;
use App\Models\Product;
use App\Models\User;
use App\Services\OrderService;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Pagination\LengthAwarePaginator;

class OrderManagementController extends Controller
{
    protected OrderService $orderService;
    protected TenantService $tenantService;

    public function __construct(OrderService $orderService, TenantService $tenantService)
    {
        $this->orderService = $orderService;
        $this->tenantService = $tenantService;
    }

    /**
     * Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð·Ð°ÐºÐ°Ð·Ð¾Ð²
     */
    public function index(Request $request)
    {
        $currentTenantId = $this->resolveTenantContext($request);
        
        if ($currentTenantId) {
            $orders = $this->getTenantOrders($currentTenantId);
            return view('admin.orders.index', compact('orders', 'currentTenantId'));
        }

        // Ð”Ð»Ñ ÑÑƒÐ¿ÐµÑ€-Ð°Ð´Ð¼Ð¸Ð½Ð°: Ð°Ð³Ñ€ÐµÐ³Ð°Ñ†Ð¸Ñ Ð·Ð°ÐºÐ°Ð·Ð¾Ð² Ð¸Ð· Ð²ÑÐµÑ… Ñ‚ÐµÐ½Ð°Ð½Ñ‚Ð¾Ð²
        $orders = $this->getAllTenantsOrders($request);
        return view('admin.orders.index', ['orders' => $orders, 'currentTenantId' => null]);
    }

    /**
     * ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð·Ð°ÐºÐ°Ð·Ð°
     */
    public function show(Request $request, $id)
    {
        $tenantId = $this->resolveTenantIdForShow($request);
        
        if (!$tenantId) {
            return back()->with('error', 'Tenant context required.');
        }

        $this->tenantService->switchTenant($tenantId);
        $order = Order::with(['items', 'user'])->findOrFail($id);
        
        return view('admin.orders.show', [
            'order' => $order,
            'currentTenantId' => $tenantId
        ]);
    }

    /**
     * Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°ÐºÐ°Ð·Ð° (Ñ„Ð¾Ñ€Ð¼Ð°)
     */
    public function create(Request $request)
    {
        $currentTenantId = $this->resolveTenantIdForCreate($request);
        $isSuperAdmin = auth()->user()->role === 'super_admin';

        $data = $this->prepareOrderFormData($currentTenantId);
        
        return view('admin.orders.form', array_merge($data, [
            'order' => null,
            'isSuperAdmin' => $isSuperAdmin,
            'currentTenantId' => $currentTenantId
        ]));
    }

    /**
     * Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð°
     */
    public function store(Request $request)
    {
        $tenantId = $request->input('tenant_id');
        if ($tenantId) {
            $this->tenantService->switchTenant($tenantId);
        }

        $validated = $this->validateOrderRequest($request);

        // Ð•ÑÐ»Ð¸ Ð²Ñ‹Ð±Ñ€Ð°Ð½ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ, Ð±ÐµÑ€ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ
        if (!empty($validated['user_id'])) {
            $this->syncCustomerDataFromUser($validated);
        }

        $this->orderService->createOrder($validated);

        return redirect()->route('admin.orders.index', ['tenant_id' => $validated['tenant_id']])
            ->with('success', 'Order created successfully.');
    }

    /**
     * Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°ÐºÐ°Ð·Ð° (Ñ„Ð¾Ñ€Ð¼Ð°)
     */
    public function edit(Request $request, $id)
    {
        $tenantId = $this->resolveTenantIdForEdit($request);
        $this->tenantService->switchTenant($tenantId);

        $order = Order::with('items')->findOrFail($id);
        $data = $this->prepareOrderFormData($tenantId);
        
        return view('admin.orders.form', array_merge($data, [
            'order' => $order,
            'isSuperAdmin' => auth()->user()->role === 'super_admin',
            'currentTenantId' => $tenantId
        ]));
    }

    /**
     * ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð·Ð°ÐºÐ°Ð·Ð°
     */
    public function update(Request $request, $id)
    {
        $tenantId = $request->get('tenant_id');
        $this->tenantService->switchTenant($tenantId);
        
        $order = Order::with('items')->findOrFail($id);

        if ($request->input('update_mode') === 'status_only') {
            return $this->updateOrderStatusOnly($request, $order);
        }

        $validated = $this->validateOrderUpdateRequest($request);

        // Ð•ÑÐ»Ð¸ Ð²Ñ‹Ð±Ñ€Ð°Ð½ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ, Ð±ÐµÑ€ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ
        if (!empty($validated['user_id'])) {
            $this->syncCustomerDataFromUser($validated);
        }

        $items = $request->has('items') ? $request->input('items') : null;
        $this->orderService->updateOrder($order, $validated, $items);

        return redirect()->route('admin.orders.index', ['tenant_id' => $tenantId])
            ->with('success', 'Order updated successfully.');
    }

    /**
     * Ð’ÑÐ¿Ð¾Ð¼Ð¾Ð³Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¼ÐµÑ‚Ð¾Ð´Ñ‹
     */

    protected function resolveTenantContext(Request $request): ?string
    {
        if (auth()->user()->role === 'super_admin') {
            return $request->get('tenant_id');
        }
        return $this->tenantService->getCurrentTenantId();
    }

    protected function getTenantOrders(string $tenantId)
    {
        $this->tenantService->switchTenant($tenantId);
        $orders = Order::latest()->paginate(20);
        
        $tenantName = config("tenants.tenants.{$tenantId}.name");
        $orders->getCollection()->transform(function ($order) use ($tenantId, $tenantName) {
            $order->tenant_id = $tenantId;
            $order->tenant_name = $tenantName;
            return $order;
        });
        
        return $orders;
    }

    protected function getAllTenantsOrders(Request $request)
    {
        $allOrders = collect();
        
        foreach (config('tenants.tenants') as $tenantId => $config) {
            try {
                $this->tenantService->switchTenant($tenantId);
                $tenantOrders = Order::latest()->limit(50)->get();
                
                foreach ($tenantOrders as $order) {
                    $order->tenant_id = $tenantId;
                    $order->tenant_name = $config['name'];
                    $allOrders->push($order);
                }
            } catch (\Exception $e) {
                \Log::warning("Failed to load orders for tenant {$tenantId}: " . $e->getMessage());
                continue;
            }
        }

        $sortedOrders = $allOrders->sortByDesc('created_at')->values();
        
        return new LengthAwarePaginator(
            $sortedOrders->forPage($request->get('page', 1), 20),
            $sortedOrders->count(),
            20,
            $request->get('page', 1),
            ['path' => $request->url(), 'query' => $request->query()]
        );
    }

    protected function resolveTenantIdForShow(Request $request): ?string
    {
        return $request->get('tenant_id') ?? $this->tenantService->getCurrentTenantId();
    }

    protected function resolveTenantIdForCreate(Request $request): ?string
    {
        $user = auth()->user();
        
        if ($user->role === 'super_admin') {
            return $request->get('tenant_id');
        }
        
        return $this->tenantService->getCurrentTenantId();
    }

    protected function resolveTenantIdForEdit(Request $request): string
    {
        return $request->get('tenant_id') ?? $this->tenantService->getCurrentTenantId();
    }

    protected function prepareOrderFormData(?string $tenantId): array
    {
        $productsCatalog = [];
        $customers = [];

        if ($tenantId) {
            try {
                $this->tenantService->switchTenant($tenantId);
                
                // Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²
                $products = Product::with('variants')->where('stock_quantity', '>', 0)->get();
                foreach ($products as $prod) {
                    $prodData = $prod->toArray();
                    $prodData['tenant_id'] = $tenantId;
                    $prodData['tenant_name'] = config("tenants.tenants.{$tenantId}.name");
                    $prodData['variants'] = $prod->variants->toArray();
                    $productsCatalog[] = $prodData;
                }

                // Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð²
                $customers = User::where('role', 'client')
                    ->select('id', 'name', 'phone', 'email')
                    ->orderBy('name')
                    ->get();

            } catch (\Exception $e) {
                \Log::error("Failed to load form data for tenant {$tenantId}: " . $e->getMessage());
            }
        }

        return [
            'productsJson' => $productsCatalog,
            'customersJson' => $customers
        ];
    }

    protected function validateOrderRequest(Request $request): array
    {
        return $request->validate([
            'tenant_id' => 'required|string',
            'user_id' => 'nullable|exists:users,id',
            'customer_name' => 'required|string',
            'customer_phone' => 'required|string',
            'customer_email' => 'nullable|email',
            'shipping_method' => 'required|string',
            'shipping_address' => 'required|string',
            'is_instagram' => 'boolean',
            'items' => 'required|array|min:1',
            'items.*.product_id' => 'required',
            'items.*.quantity' => 'required|integer|min:1',
            'items.*.price' => 'required|numeric',
            'items.*.size' => 'nullable',
        ]);
    }

    protected function validateOrderUpdateRequest(Request $request): array
    {
        return $request->validate([
            'user_id' => 'nullable|exists:users,id',
            'customer_name' => 'required|string',
            'customer_phone' => 'required|string',
            'customer_email' => 'nullable|email',
            'shipping_method' => 'required|string',
            'shipping_address' => 'required|string',
            'status' => 'required|string',
            'is_instagram' => 'boolean',
            'items' => 'nullable|array',
        ]);
    }

    protected function syncCustomerDataFromUser(array &$validatedData): void
    {
        $user = User::find($validatedData['user_id']);
        if ($user) {
            $validatedData['customer_name'] = $user->name;
            $validatedData['customer_phone'] = $user->phone;
            $validatedData['customer_email'] = $user->email;
        }
    }

    protected function updateOrderStatusOnly(Request $request, Order $order)
    {
        $validated = $request->validate([
            'status' => 'required|string',
            'is_instagram' => 'boolean',
        ]);
        
        $this->orderService->updateOrderStatus(
            $order, 
            $validated['status'], 
            $request->has('is_instagram')
        );

        return back()->with('success', 'Status updated successfully.');
    }
    /**
 * ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¾ Ð·Ð°ÐºÐ°Ð·Ðµ
 */
public function sendNotification(Request $request, $id)
{
    $tenantId = $request->get('tenant_id');
    if (!$tenantId) {
        $tenantId = $this->tenantService->getCurrentTenantId();
    }
    
    if (!$tenantId) {
        return back()->with('error', 'Tenant context required.');
    }

    $this->tenantService->switchTenant($tenantId);
    $order = Order::with('items')->findOrFail($id);

    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Telegram Ð´Ð»Ñ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð°
    $telegramSettings = \App\Models\TelegramSettings::where('tenant_id', $tenantId)->first();

    if (!$telegramSettings || !$telegramSettings->bot_token || !$telegramSettings->chat_id) {
        return back()->with('error', 'Telegram settings not configured.');
    }

    // Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
    $message = "ÐÐ¾Ð²Ñ‹Ð¹ Ð·Ð°ÐºÐ°Ð· #{$order->order_number}\n";
    $message .= "ÐšÐ»Ð¸ÐµÐ½Ñ‚: {$order->customer_name}\n";
    $message .= "Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½: {$order->customer_phone}\n";
    $message .= "Ð¡ÑƒÐ¼Ð¼Ð°: {$order->total_amount} Ñ€ÑƒÐ±.\n";
    $message .= "Ð¡Ð¿Ð¾ÑÐ¾Ð± Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸: {$order->shipping_method}\n";
    $message .= "ÐÐ´Ñ€ÐµÑ: {$order->shipping_address}\n";

    // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð² Telegram
    try {
        $telegram = new \TelegramBot\Api\BotApi($telegramSettings->bot_token);
        $telegram->sendMessage($telegramSettings->chat_id, $message);
    } catch (\Exception $e) {
        return back()->with('error', 'Failed to send notification: ' . $e->getMessage());
    }

    return back()->with('success', 'Notification sent successfully.');
}
}
</file>

<file path="app/Http/Controllers/Admin/OrderStatusController.php">
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Order;
use App\Services\TenantService;
use Illuminate\Http\Request;

class OrderStatusController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    /**
     * Ð‘Ñ‹ÑÑ‚Ñ€Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Ð·Ð°ÐºÐ°Ð·Ð°
     */
    public function quickUpdate(Request $request, $id)
    {
        $request->validate([
            'tenant_id' => 'required|string',
            'status' => 'required|string',
            'is_instagram' => 'sometimes|boolean',
        ]);

        $this->tenantService->switchTenant($request->input('tenant_id'));
        
        $order = Order::findOrFail($id);
        $order->update([
            'status' => $request->input('status'),
            'is_instagram' => $request->boolean('is_instagram', false),
        ]);

        return response()->json([
            'success' => true,
            'message' => 'Status updated',
            'order' => $order
        ]);
    }

    /**
     * ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ Ð¿Ð¾ ÑÑ‚Ð°Ñ‚ÑƒÑÐ°Ð¼
     */
    public function statistics(Request $request)
    {
        $tenantId = $request->get('tenant_id') ?? $this->tenantService->getCurrentTenantId();
        
        if (!$tenantId) {
            return response()->json(['error' => 'Tenant context required'], 400);
        }

        $this->tenantService->switchTenant($tenantId);

        $statistics = [
            'new' => Order::where('status', 'new')->count(),
            'processing' => Order::where('status', 'processing')->count(),
            'shipped' => Order::where('status', 'shipped')->count(),
            'delivered' => Order::where('status', 'delivered')->count(),
            'cancelled' => Order::where('status', 'cancelled')->count(),
            'total' => Order::count(),
        ];

        return response()->json($statistics);
    }

    /**
     * ÐŸÐ°ÐºÐµÑ‚Ð½Ð¾Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ð°Ñ‚ÑƒÑÐ¾Ð²
     */
    public function bulkUpdate(Request $request)
    {
        $request->validate([
            'tenant_id' => 'required|string',
            'order_ids' => 'required|array',
            'order_ids.*' => 'integer',
            'status' => 'required|string',
        ]);

        $this->tenantService->switchTenant($request->input('tenant_id'));

        $updatedCount = Order::whereIn('id', $request->input('order_ids'))
            ->update(['status' => $request->input('status')]);

        return response()->json([
            'success' => true,
            'message' => "Updated {$updatedCount} orders",
            'updated_count' => $updatedCount
        ]);
    }
}
</file>

<file path="app/Http/Controllers/Admin/PromoCodeController.php">
<?php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\PromoCode;
use App\Models\Product;
use App\Models\Category;
use App\Models\ClothingLine;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Str; // Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ ÑÐ¾ ÑÑ‚Ñ€Ð¾ÐºÐ°Ð¼Ð¸
use Illuminate\Validation\Rule;

class PromoCodeController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    private function checkSuperAdmin()
    {
        if (auth()->user()->role !== 'super_admin') {
            abort(403, 'Access denied. Only Super Admin can manage promo codes.');
        }
    }

    public function index()
    {
        $this->checkSuperAdmin();
        $promocodes = PromoCode::latest()->get();
        return view('admin.promocodes.index', compact('promocodes'));
    }

    public function create()
    {
        $this->checkSuperAdmin();

        $catalogData = [];
        $tenants = config('tenants.tenants');

        foreach ($tenants as $id => $config) {
            try {
                $this->tenantService->switchTenant($id);
                
                $catalogData[$id] = [
                    'name' => $config['name'],
                    'products' => Product::select('id', 'name', 'sku')->orderBy('name')->get()->toArray(),
                    'categories' => Category::select('id', 'name', 'slug')->orderBy('name')->get()->toArray(),
                    'lines' => ClothingLine::select('id', 'name', 'slug')->orderBy('name')->get()->toArray(),
                ];
            } catch (\Exception $e) {
                continue;
            }
        }

        return view('admin.promocodes.create', compact('catalogData'));
    }

    /**
     * Store a newly created promo code.
     */
    public function store(Request $request)
    {
        $this->checkSuperAdmin();

        // ÐÐžÐ ÐœÐÐ›Ð˜Ð—ÐÐ¦Ð˜Ð¯: ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð¸Ð¼ ÐºÐ¾Ð´ Ð² Ð²ÐµÑ€Ñ…Ð½Ð¸Ð¹ Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€ Ð´Ð¾ Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸.
        // Ð­Ñ‚Ð¾ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ€ÑƒÐµÑ‚, Ñ‡Ñ‚Ð¾ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Rule::unique ÑÑ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾ 
        // Ð¸ Ð² Ð±Ð°Ð·Ñƒ Ð¿Ð¾Ð¿Ð°Ð´ÑƒÑ‚ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð² Ð½ÑƒÐ¶Ð½Ð¾Ð¼ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ.
        if ($request->has('code')) {
            $request->merge([
                'code' => Str::upper($request->code)
            ]);
        }

        $validated = $request->validate([
            'code' => [
                'required', 
                'string', 
                'alpha_dash', 
                Rule::unique(PromoCode::class, 'code')
            ],
            'type' => 'required|in:percent,fixed',
            'value' => 'required|numeric|min:0',
            'starts_at' => 'nullable|date',
            'expires_at' => 'nullable|date|after_or_equal:starts_at',
            'scope_type' => 'required|in:global,specific,category,line',
            'scope_data' => 'nullable|array',
        ]);

        $validated['is_active'] = $request->has('is_active');

        // ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¿ÑƒÑÑ‚Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾ Ñ‚ÐµÐ½Ð°Ð½Ñ‚Ð°Ð¼
        if (!empty($validated['scope_data'])) {
            $cleanedData = [];
            foreach ($validated['scope_data'] as $tenant => $ids) {
                if (!empty($ids)) {
                    $cleanedData[$tenant] = $ids;
                }
            }
            $validated['scope_data'] = $cleanedData;
        }

        PromoCode::create($validated);

        return redirect()->route('admin.promocodes.index')->with('success', 'Promo Code created successfully.');
    }

    public function destroy($id)
    {
        $this->checkSuperAdmin();
        PromoCode::destroy($id);
        return back()->with('success', 'Promo Code deleted.');
    }
}
</file>

<file path="app/Http/Controllers/Admin/ReportController.php">
<?php
// FILE: app/Http/Controllers/Admin/ReportController.php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Order;
use App\Services\TenantService;
use Illuminate\Support\Facades\DB;

class ReportController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    public function index()
    {
        $user = auth()->user();
        $reportData = [];
        $grandTotal = 0;

        // Ð›ÐžÐ“Ð˜ÐšÐ Ð¡Ð£ÐŸÐ•Ð -ÐÐ”ÐœÐ˜ÐÐ: ÐŸÑ€Ð¾Ð±ÐµÐ³Ð°ÐµÐ¼ Ð¿Ð¾ Ð²ÑÐµÐ¼ ÑÑ…ÐµÐ¼Ð°Ð¼
        if ($user->role === 'super_admin') {
            $tenants = config('tenants.tenants');
            
            foreach ($tenants as $id => $config) {
                // ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð‘Ð”
                // Ð’Ð°Ð¶Ð½Ð¾: try-catch, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð² Ð¾Ð´Ð½Ð¾Ð¹ ÑÑ…ÐµÐ¼Ðµ Ð½Ðµ Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ð»Ð° Ð²ÐµÑÑŒ Ð¾Ñ‚Ñ‡ÐµÑ‚
                try {
                    $this->tenantService->switchTenant($id);
                    
                    $total = Order::sum('total_amount');
                    $count = Order::count();
                    $avg = $count > 0 ? $total / $count : 0;

                    $reportData[] = [
                        'tenant' => $config['name'],
                        'orders_count' => $count,
                        'total_revenue' => $total,
                        'average_check' => $avg,
                    ];
                    $grandTotal += $total;

                } catch (\Exception $e) {
                    $reportData[] = [
                        'tenant' => $config['name'] . ' (Error)',
                        'orders_count' => 0,
                        'total_revenue' => 0,
                        'average_check' => 0,
                    ];
                }
            }
            
            // Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ÑÑ Ð² Public (Ð¸Ð»Ð¸ Ð² ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð°Ð´Ð¼Ð¸Ð½ÐºÐ¸ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ)
            DB::statement("SET search_path TO public");

        } else {
            // Ð›ÐžÐ“Ð˜ÐšÐ ÐœÐ•ÐÐ•Ð”Ð–Ð•Ð Ð: Ð”Ð°Ð½Ð½Ñ‹Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ ÑÑ…ÐµÐ¼Ñ‹
            // Middleware ÑƒÐ¶Ðµ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð¸Ð» Ð½Ð°Ñ Ð² Ð½ÑƒÐ¶Ð½ÑƒÑŽ ÑÑ…ÐµÐ¼Ñƒ Ð¿Ñ€Ð¸ Ð²Ñ…Ð¾Ð´Ðµ (ÐµÑÐ»Ð¸ Ð¼Ñ‹ Ð² Ñ€ÐµÐ¶Ð¸Ð¼Ðµ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð°)
            // ÐÐ¾ Ñ‚Ð°Ðº ÐºÐ°Ðº Ð¼Ñ‹ Ð² Ñ†ÐµÐ½Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð°Ð´Ð¼Ð¸Ð½ÐºÐµ, Ð½Ð°Ð¼ Ð½ÑƒÐ¶Ð½Ð¾ ÑƒÐ±ÐµÐ´Ð¸Ñ‚ÑŒÑÑ, Ñ‡Ñ‚Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ Ð²ÐµÑ€ÐµÐ½.
            
            if ($user->tenant_id) {
                $this->tenantService->switchTenant($user->tenant_id);
                
                $total = Order::sum('total_amount');
                $count = Order::count();
                $avg = $count > 0 ? $total / $count : 0;

                $reportData[] = [
                    'tenant' => ucfirst($user->tenant_id),
                    'orders_count' => $count,
                    'total_revenue' => $total,
                    'average_check' => $avg,
                ];
                $grandTotal = $total;
            }
        }

        return view('admin.reports.index', compact('reportData', 'grandTotal'));
    }
}
</file>

<file path="app/Http/Controllers/Admin/TelegramSettingsController.php">
<?php
    // FILE: app/Http/Controllers/Admin/TelegramSettingsController.php

    namespace App\Http\Controllers\Admin;

    use App\Http\Controllers\Controller;
    use App\Models\TelegramConfig;
    use Illuminate\Http\Request;
    use Illuminate\Validation\Rule;
    use Illuminate\Support\Facades\Http;

    class TelegramSettingsController extends Controller
    {
        private function checkSuperAdmin()
        {
            if (auth()->user()->role !== 'super_admin') {
                abort(403, 'Access denied.');
            }
        }

        // Index Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð¼Ñ‹ Ð¸Ð´ÐµÐ¼ Ð½Ð° Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½ÑƒÑŽ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ (Ð½Ð¾ ÑÐµÐ¹Ñ‡Ð°Ñ Ñƒ Ð½Ð°Ñ Ð¾Ð±Ñ‰Ð¸Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸)
        // ÐžÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð° Ð²ÑÑÐºÐ¸Ð¹ ÑÐ»ÑƒÑ‡Ð°Ð¹ Ð¸Ð»Ð¸ Ð´Ð»Ñ API Ð²Ñ‹Ð·Ð¾Ð²Ð¾Ð²
        public function index()
        {
            $this->checkSuperAdmin();
            $configs = TelegramConfig::all();
            $tenants = config('tenants.tenants');
            return view('admin.settings.telegram', compact('configs', 'tenants'));
        }

        public function store(Request $request)
        {
            $this->checkSuperAdmin();

            $validated = $request->validate([
                'name' => 'required|string|max:255',
                'bot_token' => 'required|string',
                'chat_id' => 'required|string',
                'tenant_id' => 'nullable|string|unique:public.telegram_configs,tenant_id',
            ]);

            $validated['is_active'] = $request->has('is_active');

            TelegramConfig::create($validated);

            return back()->with('success', 'Telegram Bot configuration added.');
        }

        public function update(Request $request, $id)
        {
            $this->checkSuperAdmin();
            $config = TelegramConfig::findOrFail($id);

            $validated = $request->validate([
                'name' => 'required|string|max:255',
                'bot_token' => 'required|string',
                'chat_id' => 'required|string',
                'tenant_id' => ['nullable', 'string', Rule::unique('public.telegram_configs', 'tenant_id')->ignore($config->id)],
            ]);

            $validated['is_active'] = $request->has('is_active');
            $config->update($validated);

            return back()->with('success', 'Configuration updated.');
        }

        public function destroy($id)
        {
            $this->checkSuperAdmin();
            TelegramConfig::destroy($id);
            return back()->with('success', 'Configuration deleted.');
        }

        public function test($id)
        {
            $this->checkSuperAdmin();
            $config = TelegramConfig::findOrFail($id);

            return $this->performSend($config, "âš¡ *TEST*\nConnection successful for bot: _{$config->name}_");
        }

        // ÐÐžÐ’Ð«Ð™ ÐœÐ•Ð¢ÐžÐ”: Ð ÑƒÑ‡Ð½Ð°Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ
        public function sendMessage(Request $request)
        {
            $this->checkSuperAdmin();
            
            $validated = $request->validate([
                'config_id' => 'required|exists:public.telegram_configs,id',
                'message' => 'required|string|min:2',
            ]);

            $config = TelegramConfig::findOrFail($validated['config_id']);
            
            return $this->performSend($config, $validated['message']);
        }

        // ÐŸÑ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ð¹ Ñ…ÐµÐ»Ð¿ÐµÑ€ Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð´ÑƒÐ±Ð»Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐºÐ¾Ð´
        private function performSend($config, $text)
        {
            try {
                $response = Http::post("https://api.telegram.org/bot{$config->bot_token}/sendMessage", [
                    'chat_id' => $config->chat_id,
                    'text' => $text,
                    'parse_mode' => 'Markdown',
                ]);

                if ($response->successful()) {
                    return back()->with('success', 'Message sent successfully via Telegram!');
                } else {
                    return back()->with('error', 'Telegram API Error: ' . $response->body());
                }
            } catch (\Exception $e) {
                return back()->with('error', 'Connection failed: ' . $e->getMessage());
            }
        }
    }
</file>

<file path="app/Http/Controllers/Api/ProductController.php">
<?php
// FILE: app/Http/Controllers/Api/ProductController.php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use App\Models\Product;
use App\Services\ProductService;
use Illuminate\Http\Request;

class ProductController extends Controller
{
    protected ProductService $productService;

    public function __construct(ProductService $productService)
    {
        $this->productService = $productService;
    }

    // GET /api/products
    public function index()
    {
        return response()->json(Product::latest()->paginate(12));
    }

    // GET /api/products/{id}
    public function show($id)
    {
        $product = Product::findOrFail($id);
        return response()->json($product);
    }

    // GET /api/products/search?q=hoodie
    public function search(Request $request)
    {
        $query = $request->get('q');
        
        if (!$query) {
            return $this->index();
        }

        $products = $this->productService->search($query);
        return response()->json($products);
    }
}
</file>

<file path="app/Http/Controllers/Client/ContactController.php">
<?php

// FILE: app/Http/Controllers/Client/ContactController.php

namespace App\Http\Controllers\Client;

use App\Http\Controllers\Controller;
use App\Models\ContactMessage;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;

class ContactController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    private function resolveTenant()
    {
        $host = request()->getHost();
        $map = $this->tenantService->getDomainMap();
        $tenantId = $map[$host] ?? 'default';
        $this->tenantService->switchTenant($tenantId);
        return $tenantId;
    }

    public function index()
    {
        $tenantId = $this->resolveTenant();
        $view = "tenants.{$tenantId}.contact";
        if (!view()->exists($view)) {
            $view = 'shop.contact';
        }
        return view($view);
    }

    public function store(Request $request)
    {
        $this->resolveTenant();

        $validated = $request->validate([
            'email' => 'required|email',
            'phone' => 'nullable|string|max:20',
            'message' => 'required|string|min:10|max:2000',
        ]);

        // Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½, Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ ÐµÐ³Ð¾ ID
        if (Auth::check()) {
            $validated['user_id'] = Auth::id();
            // Ð•ÑÐ»Ð¸ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½ Ð½Ðµ Ð²Ð²ÐµÐ´ÐµÐ½ Ð² Ñ„Ð¾Ñ€Ð¼Ðµ, Ð½Ð¾ ÐµÑÑ‚ÑŒ Ð² Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ðµ - Ð¼Ð¾Ð¶Ð½Ð¾ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ (Ð¾Ð¿Ñ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð¾)
            if (empty($validated['phone'])) {
                $validated['phone'] = Auth::user()->phone;
            }
        }

        ContactMessage::create($validated);

        return back()->with('success', 'Message sent successfully. Support team will contact you.');
    }
}
</file>

<file path="app/Http/Controllers/Client/ProfileController.php">
<?php
// FILE: app/Http/Controllers/Client/ProfileController.php

namespace App\Http\Controllers\Client;

use App\Http\Controllers\Controller;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use App\Models\Order;

class ProfileController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    private function resolveTenant()
    {
        $host = request()->getHost();
        $map = $this->tenantService->getDomainMap();
        $tenantId = $map[$host] ?? 'default';
        $this->tenantService->switchTenant($tenantId);
        return $tenantId;
    }

    public function index()
    {
        $tenantId = $this->resolveTenant();
        $user = Auth::user();
        
        $orders = $user->orders()->with('items')->get();

        $view = "tenants.{$tenantId}.profile.index";
        if (!view()->exists($view)) $view = 'client.profile.index';

        return view($view, compact('orders', 'user'));
    }

    public function showOrder($id)
    {
        $tenantId = $this->resolveTenant();
        
        $order = Order::with('items')->where('user_id', Auth::id())->findOrFail($id);
        
        // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð¸Ð· ÑÐµÑÑÐ¸Ð¸ (ÐµÑÐ»Ð¸ ÑÑ‚Ð¾ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ñ‡Ñ‚Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ñ‹Ð¹ Ð·Ð°ÐºÐ°Ð·)
        $generatedPassword = session('generated_password');

        $view = "tenants.{$tenantId}.profile.order";
        if (!view()->exists($view)) $view = 'client.profile.order';

        return view($view, compact('order', 'generatedPassword'));
    }
}
</file>

<file path="app/Http/Controllers/Controller.php">
<?php

namespace App\Http\Controllers;

abstract class Controller
{
    //
}
</file>

<file path="app/Models/AttributeOption.php">
<?php
// FILE: app/Models/AttributeOption.php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class AttributeOption extends Model
{
    protected $fillable = ['type', 'value', 'slug'];
}
</file>

<file path="app/Models/Category.php">
<?php
// FILE: app/Models/Category.php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Category extends Model
{
    use HasFactory;

    protected $fillable = ['name', 'slug'];

    public function products()
    {
        return $this->belongsToMany(Product::class);
    }
}
</file>

<file path="app/Models/ClothingLine.php">
<?php
// FILE: app/Models/ClothingLine.php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class ClothingLine extends Model
{
    protected $fillable = ['name', 'slug'];

    public function products()
    {
        return $this->hasMany(Product::class);
    }
}
</file>

<file path="app/Models/ContactMessage.php">
<?php

// FILE: app/Models/ContactMessage.php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class ContactMessage extends Model
{
    use HasFactory;

    protected $fillable = [
        'user_id', // <--- Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾
        'email',
        'phone',
        'message',
        'is_read',
    ];

    protected $casts = [
        'is_read' => 'boolean',
    ];

    // Ð¡Ð²ÑÐ·ÑŒ Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¼
    public function user()
    {
        return $this->belongsTo(User::class);
    }
}
</file>

<file path="app/Models/OrderItem.php">
<?php
// FILE: app/Models/OrderItem.php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class OrderItem extends Model
{
    protected $fillable = [
        'order_id', 'product_id', 'product_name', 'sku', 'size', 'quantity', 'price', 'total'
    ];

    public function product()
    {
        return $this->belongsTo(Product::class)->withTrashed(); // Ð”Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ Ñ‚Ð¾Ð²Ð°Ñ€ ÑƒÐ´Ð°Ð»ÐµÐ½, ÑÐ²ÑÐ·ÑŒ Ð½ÑƒÐ¶Ð½Ð°
    }
}
</file>

<file path="app/Models/ProductImage.php">
<?php
// FILE: app/Models/ProductImage.php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Str;

class ProductImage extends Model
{
    protected $fillable = ['product_id', 'path', 'sort_order'];

    // ÐÐºÑÐµÑÑÐ¾Ñ€ Ð´Ð»Ñ URL
    public function getUrlAttribute()
    {
        // Ð•ÑÐ»Ð¸ ÑÑ‚Ð¾ Ð²Ð½ÐµÑˆÐ½ÑÑ ÑÑÑ‹Ð»ÐºÐ° (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° Ð·Ð°Ð³Ð»ÑƒÑˆÐµÐº), Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ ÐºÐ°Ðº ÐµÑÑ‚ÑŒ
        if (Str::startsWith($this->path, ['http://', 'https://'])) {
            return $this->path;
        }

        // Ð˜Ð½Ð°Ñ‡Ðµ Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ ÑÑÑ‹Ð»ÐºÑƒ Ñ‡ÐµÑ€ÐµÐ· Ð´Ð¸ÑÐº Ñ‚ÐµÐ½Ð°Ð½Ñ‚Ð°
        return Storage::disk('tenant')->url($this->path);
    }
}
</file>

<file path="app/Models/ProductVariant.php">
<?php
// FILE: app/Models/ProductVariant.php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class ProductVariant extends Model
{
    protected $fillable = ['product_id', 'size', 'stock'];

    public function product()
    {
        return $this->belongsTo(Product::class);
    }
}
</file>

<file path="app/Models/PromoCode.php">
<?php
// FILE: app/Models/PromoCode.php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class PromoCode extends Model
{
    // Ð’Ð°Ð¶Ð½Ð¾: Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° Ð²ÑÐµÐ³Ð´Ð° Ð² public ÑÑ…ÐµÐ¼Ðµ
    protected $table = 'public.promo_codes';

    protected $fillable = [
        'code', 
        'type', 
        'value', 
        'is_active', 
        'starts_at',
        'expires_at',
        'scope_type',
        'scope_data'
    ];

    protected $casts = [
        'is_active' => 'boolean',
        'starts_at' => 'datetime',
        'expires_at' => 'datetime',
        'scope_data' => 'array', // ÐÐ²Ñ‚Ð¾-ÐºÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð°Ñ†Ð¸Ñ JSON
    ];

    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²Ð°Ð»Ð¸Ð´Ð½Ð¾ÑÑ‚Ð¸ Ð¿Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸
    public function isValid()
    {
        if (!$this->is_active) return false;
        $now = now();
        if ($this->starts_at && $now->lt($this->starts_at)) return false;
        if ($this->expires_at && $now->gt($this->expires_at)) return false;
        
        return true;
    }
}
</file>

<file path="app/Models/TelegramConfig.php">
<?php
// FILE: app/Models/TelegramConfig.php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class TelegramConfig extends Model
{
    protected $fillable = [
        'name',
        'bot_token',
        'chat_id',
        'tenant_id',
        'is_active',
    ];

    // Ð¯Ð²Ð½Ð¾ ÑƒÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼, Ñ‡Ñ‚Ð¾ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð° Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÑÑ Ð² ÑÑ…ÐµÐ¼Ðµ public (ÐµÑÐ»Ð¸ Ð²Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚Ðµ PostgreSQL ÑÑ…ÐµÐ¼Ñ‹)
    // Ð­Ñ‚Ð¾ Ð³Ð°Ñ€Ð°Ð½Ñ‚Ð¸Ñ€ÑƒÐµÑ‚, Ñ‡Ñ‚Ð¾ Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ð²ÑÐµÐ³Ð´Ð° Ð¾Ð±Ñ€Ð°Ñ‰Ð°ÐµÑ‚ÑÑ Ðº Ñ†ÐµÐ½Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ñ‹Ð¼ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ°Ð¼, 
    // Ð´Ð°Ð¶Ðµ ÐµÑÐ»Ð¸ Ð¼Ñ‹ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð¸Ð»Ð¸ search_path Ð½Ð° ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ñ‹Ð¹ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½.
    protected $table = 'public.telegram_configs';
}
</file>

<file path="app/Models/TenantSetting.php">
<?php
// FILE: app/Models/TenantSetting.php

namespace App\Models;

use Illuminate\Database\Eloquent\Model;

class TenantSetting extends Model
{
    protected $fillable = ['key', 'value', 'group'];

    // Ð¥ÐµÐ»Ð¿ÐµÑ€ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸
    public static function get(string $key, $default = null)
    {
        return self::where('key', $key)->value('value') ?? $default;
    }

    // Ð¥ÐµÐ»Ð¿ÐµÑ€ Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ
    public static function set(string $key, $value, string $group = 'general')
    {
        return self::updateOrCreate(
            ['key' => $key],
            ['value' => $value, 'group' => $group]
        );
    }
}
</file>

<file path="app/Http/Controllers/Admin/AttributeController.php">
<?php
// FILE: app/Http/Controllers/Admin/AttributeController.php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\AttributeOption;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Support\Str;

class AttributeController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    private function resolveContext(Request $request)
    {
        if (auth()->user()->role !== 'super_admin') {
            return $this->tenantService->getCurrentTenantId();
        }
        // Ð”ÐµÑ„Ð¾Ð»Ñ‚ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð°
        $tenantId = $request->tenant_id ?? array_key_first(config('tenants.tenants'));
        if ($tenantId) $this->tenantService->switchTenant($tenantId);
        return $tenantId;
    }

    public function index(Request $request)
    {
        $currentTenantId = $this->resolveContext($request);
        
        $query = AttributeOption::query();
        if ($request->filled('search')) {
            $query->where('value', 'ilike', "%{$request->search}%");
        }

        $attributes = $query->get()->groupBy('type');
        
        return view('admin.attributes.index', compact('attributes', 'currentTenantId'));
    }

    public function store(Request $request)
    {
        $this->resolveContext($request);
        
        $validated = $request->validate([
            'type' => 'required|string|in:size,product_type,material',
            'value' => 'required|string|max:255',
        ]);

        AttributeOption::firstOrCreate(
            ['type' => $validated['type'], 'value' => $validated['value']],
            ['slug' => Str::slug($validated['value'])]
        );

        return back()->with('success', 'Attribute added.');
    }

    // Ð’ÐÐ–ÐÐž: ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€ Ð½Ð°Ð·Ñ‹Ð²Ð°ÐµÑ‚ÑÑ $id, Ð¸ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð¶Ð´Ð°Ñ‚ÑŒ {id}
    public function destroy(Request $request, $id)
    {
        $this->resolveContext($request);
        AttributeOption::destroy($id);
        return back()->with('success', 'Attribute deleted.');
    }
}
</file>

<file path="app/Http/Controllers/Admin/DashboardController.php">
<?php
// FILE: app/Http/Controllers/Admin/DashboardController.php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Order;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Support\Collection;

class DashboardController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    public function index(Request $request)
    {
        $user = auth()->user();
        $isSuperAdmin = $user->role === 'super_admin';
        
        $currentTenantId = null;

        if ($isSuperAdmin) {
            if ($request->has('tenant_id')) {
                $currentTenantId = $request->tenant_id;
            } elseif (session()->has('admin_current_tenant_id')) {
                $currentTenantId = session('admin_current_tenant_id');
            }
            if ($currentTenantId === 'root') $currentTenantId = null;
        } else {
            $currentTenantId = $this->tenantService->getCurrentTenantId();
        }

        $stats = [
            'total_orders' => 0,
            'total_revenue' => 0,
            'recent_orders' => new Collection(),
            'tenant_name' => $currentTenantId ? config("tenants.tenants.$currentTenantId.name") : 'All Shops (Global Overview)'
        ];

        if ($currentTenantId) {
            // --- Ð Ð•Ð–Ð˜Ðœ ÐžÐ”ÐÐžÐ“Ðž ÐœÐÐ“ÐÐ—Ð˜ÐÐ ---
            $this->tenantService->switchTenant($currentTenantId);
            
            $stats['total_orders'] = Order::count();
            $stats['total_revenue'] = Order::sum('total_amount');
            
            $recent = Order::latest()->take(5)->get();
            $storeName = config("tenants.tenants.$currentTenantId.name");
            $recent->each(fn($o) => $o->store_name = $storeName);
            
            $stats['recent_orders'] = $recent;

        } elseif ($isSuperAdmin) {
            // --- Ð“Ð›ÐžÐ‘ÐÐ›Ð¬ÐÐ«Ð™ Ð Ð•Ð–Ð˜Ðœ ---
            $allOrders = []; // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ Ð¼Ð°ÑÑÐ¸Ð², Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð±ÐµÐ¶Ð°Ñ‚ÑŒ ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚Ð° ID

            foreach (config('tenants.tenants') as $id => $config) {
                try {
                    $this->tenantService->switchTenant($id);
                    
                    $stats['total_orders'] += Order::count();
                    $stats['total_revenue'] += Order::sum('total_amount');
                    
                    // Ð‘ÐµÑ€ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ 5 Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð°
                    $orders = Order::latest()->take(5)->get();
                    
                    foreach ($orders as $order) {
                        $order->store_name = $config['name'];
                        $order->tenant_id = $id;
                        $allOrders[] = $order; // ÐŸÑ€Ð¾ÑÑ‚Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð² Ð¼Ð°ÑÑÐ¸Ð²
                    }
                } catch (\Exception $e) {
                    continue;
                }
            }
            
            // ÐŸÑ€ÐµÐ²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð² ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸ÑŽ, ÑÐ¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾ Ð´Ð°Ñ‚Ðµ Ð¸ Ð±ÐµÑ€ÐµÐ¼ Ñ‚Ð¾Ð¿-5
            $stats['recent_orders'] = collect($allOrders)->sortByDesc('created_at')->take(5);
        }

        return view('admin.dashboard', compact('stats', 'currentTenantId'));
    }
}
</file>

<file path="app/Http/Controllers/Admin/SettingsController.php">
<?php
// FILE: app/Http/Controllers/Admin/SettingsController.php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use Illuminate\Http\Request;
use App\Models\TelegramConfig; // Ð˜Ð¼Ð¿Ð¾Ñ€Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð¼Ð¾Ð´ÐµÐ»ÑŒ Ñ‚ÐµÐ»ÐµÐ³Ñ€Ð°Ð¼Ð°

class SettingsController extends Controller
{
    private function checkSuperAdmin()
    {
        if (auth()->user()->role !== 'super_admin') {
            abort(403, 'Access denied.');
        }
    }

    public function index()
    {
        $this->checkSuperAdmin();

        // Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Telegram Ð²ÐºÐ»Ð°Ð´ÐºÐ¸
        $telegramConfigs = TelegramConfig::all();
        $tenants = config('tenants.tenants');

        return view('admin.settings.index', compact('telegramConfigs', 'tenants'));
    }

    // ÐœÐµÑ‚Ð¾Ð´ Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ ÐžÐ‘Ð©Ð˜Ð¥ Ð½Ð°ÑÑ‚Ñ€Ð¾ÐµÐº (Ð·Ð°Ð³Ð»ÑƒÑˆÐºÐ° Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð¼ÐµÑ€Ð°)
    public function update(Request $request)
    {
        $this->checkSuperAdmin();
        // Ð—Ð´ÐµÑÑŒ Ð»Ð¾Ð³Ð¸ÐºÐ° ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ ÑÐ°Ð¹Ñ‚Ð°, Ð»Ð¾Ð³Ð¾Ñ‚Ð¸Ð¿Ð° Ð¸ Ñ‚.Ð´.
        // ...
        return back()->with('success', 'General settings updated.');
    }
}
</file>

<file path="app/Http/Controllers/Client/AuthController.php">
<?php
// FILE: app/Http/Controllers/Client/AuthController.php

namespace App\Http\Controllers\Client;

use App\Http\Controllers\Controller;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Hash;
use App\Models\User;

class AuthController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    private function resolveTenant()
    {
        $host = request()->getHost();
        $map = $this->tenantService->getDomainMap();
        $tenantId = $map[$host] ?? 'default';
        $this->tenantService->switchTenant($tenantId);
        return $tenantId;
    }

    public function showLogin()
    {
        $tenantId = $this->resolveTenant();
        // Ð£Ð½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑˆÐ°Ð±Ð»Ð¾Ð½ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð° Ð¸Ð»Ð¸ Ð¾Ð±Ñ‰Ð¸Ð¹
        $view = "tenants.{$tenantId}.auth.login";
        if (!view()->exists($view)) {
            $view = 'client.auth.login'; // Ð¤Ð¾Ð»Ð±ÑÐº Ð½Ð° Ð¾Ð±Ñ‰Ð¸Ð¹
        }
        
        return view($view);
    }

    public function login(Request $request)
    {
        $this->resolveTenant();

        $credentials = $request->validate([
            'phone' => 'required|string',
            'password' => 'required|string',
        ]);

        // 1. Ð¡Ñ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ð°Ñ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð²Ñ…Ð¾Ð´Ð° (ÐŸÐ°Ñ€Ð¾Ð»ÑŒ)
        if (Auth::attempt(['phone' => $credentials['phone'], 'password' => $credentials['password']])) {
            $request->session()->regenerate();
            return redirect()->route('client.profile');
        }

        // 2. ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð²Ñ…Ð¾Ð´Ð° Ñ‡ÐµÑ€ÐµÐ· Access Key (Ð ÐµÐ·ÐµÑ€Ð²Ð½Ñ‹Ð¹ Ð²Ñ…Ð¾Ð´)
        $user = User::where('phone', $credentials['phone'])->first();
        
        if ($user && $user->access_key) {
            // Ð¡Ñ€Ð°Ð²Ð½Ð¸Ð²Ð°ÐµÐ¼ Ð²Ð²ÐµÐ´ÐµÐ½Ð½Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ñ Ñ€Ð°ÑÑˆÐ¸Ñ„Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¼ ÐºÐ»ÑŽÑ‡Ð¾Ð¼
            if ($credentials['password'] === $user->access_key) {
                Auth::login($user);
                $request->session()->regenerate();
                return redirect()->route('client.profile')->with('success', 'Logged in via Access Key');
            }
        }

        return back()->withErrors([
            'phone' => 'The provided credentials do not match our records.',
        ]);
    }

    public function logout(Request $request)
    {
        Auth::logout();
        $request->session()->invalidate();
        $request->session()->regenerateToken();
        return redirect()->route('home');
    }

    public function updatePassword(Request $request)
    {
        $this->resolveTenant();

        $request->validate([
            'current_password' => 'required',
            'new_password' => 'required|min:6|confirmed',
        ]);

        $user = Auth::user();

        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ (Ð¸Ð»Ð¸ access_key)
        $isPasswordCorrect = Hash::check($request->current_password, $user->password);
        $isAccessKeyCorrect = ($user->access_key && $request->current_password === $user->access_key);

        if (!$isPasswordCorrect && !$isAccessKeyCorrect) {
            return back()->withErrors(['current_password' => 'Current password is incorrect']);
        }

        /** @var \App\Models\User $user */
        $user->update([
            'password' => Hash::make($request->new_password),
            // Ð’ÐÐ–ÐÐž: ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Access Key Ñ‚Ð¾Ð¶Ðµ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ð° Ñ‡ÐµÐºÐµ Ð²ÑÐµÐ³Ð´Ð° Ð±Ñ‹Ð» ÐÐšÐ¢Ð£ÐÐ›Ð¬ÐÐ«Ð™ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ
            // Laravel Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð·Ð°ÑˆÐ¸Ñ„Ñ€ÑƒÐµÑ‚ ÑÑ‚Ð¾ Ð¿Ð¾Ð»Ðµ Ð±Ð»Ð°Ð³Ð¾Ð´Ð°Ñ€Ñ $casts Ð² Ð¼Ð¾Ð´ÐµÐ»Ð¸
            'access_key' => $request->new_password 
        ]);

        return back()->with('success', 'Password updated successfully! Your receipt credentials are also updated.');
    }
}
</file>

<file path="app/Http/Controllers/Admin/CategoryController.php">
<?php
// FILE: app/Http/Controllers/Admin/CategoryController.php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Category;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Support\Str;

class CategoryController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    private function resolveContext(Request $request)
    {
        if (auth()->user()->role !== 'super_admin') {
            return $this->tenantService->getCurrentTenantId();
        }
        $tenantId = $request->tenant_id ?? array_key_first(config('tenants.tenants'));
        if ($tenantId) {
            $this->tenantService->switchTenant($tenantId);
        }
        return $tenantId;
    }

    public function index(Request $request)
    {
        $currentTenantId = $this->resolveContext($request);
        $query = Category::withCount('products');
        if ($request->filled('search')) {
            $query->where('name', 'ilike', "%{$request->search}%");
        }
        $categories = $query->orderBy('name')->get();
        return view('admin.categories.index', compact('categories', 'currentTenantId'));
    }

    public function store(Request $request)
    {
        $this->resolveContext($request);
        
        $validated = $request->validate(['name' => 'required|string|max:255']);

        // Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð•: ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾ ÑÐ»Ð°Ð³Ñƒ
        $slug = Str::slug($validated['name']);
        
        Category::firstOrCreate(
            ['slug' => $slug],
            ['name' => $validated['name']]
        );

        return back()->with('success', 'Category created/found.');
    }

    public function update(Request $request, $id)
    {
        $this->resolveContext($request);
        $category = Category::findOrFail($id);
        
        $validated = $request->validate(['name' => 'required|string|max:255']);
        // ÐŸÑ€Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¼ÐµÐ½ÑÐµÐ¼ Ð¸Ð¼Ñ Ð¸ ÑÐ»Ð°Ð³, Ñ‚ÑƒÑ‚ firstOrCreate Ð½Ðµ Ð½ÑƒÐ¶ÐµÐ½, Ð½Ð¾ Ð½ÑƒÐ¶Ð½Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ unique exception
        try {
            $category->update([
                'name' => $validated['name'],
                'slug' => Str::slug($validated['name'])
            ]);
        } catch (\Exception $e) {
            return back()->with('error', 'Category with this name already exists.');
        }
        
        return back()->with('success', 'Category updated.');
    }

    public function destroy(Request $request, $id)
    {
        $this->resolveContext($request);
        Category::destroy($id);
        return back()->with('success', 'Category deleted.');
    }
}
</file>

<file path="app/Models/User.php">
<?php
// FILE: app/Models/User.php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Foundation\Auth\User as Authenticatable;
use Illuminate\Notifications\Notifiable;

class User extends Authenticatable
{
    use HasFactory, Notifiable;

    protected $fillable = [
        'name',
        'email',
        'password',
        'phone',      
        'role',       
        'tenant_id',
        'access_key', // <--- Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾
    ];

    protected $hidden = [
        'password',
        'remember_token',
        'access_key', // Ð¡ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¸ ÐºÐ¾Ð½Ð²ÐµÑ€Ñ‚Ð°Ñ†Ð¸Ð¸ Ð² Ð¼Ð°ÑÑÐ¸Ð² (Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚ÑŒ)
    ];

    protected $casts = [
        'email_verified_at' => 'datetime',
        'password' => 'hashed',
        'access_key' => 'encrypted', // <--- ÐÐ’Ð¢ÐžÐœÐÐ¢Ð˜Ð§Ð•Ð¡ÐšÐžÐ• Ð¨Ð˜Ð¤Ð ÐžÐ’ÐÐÐ˜Ð•/Ð”Ð•Ð¨Ð˜Ð¤Ð ÐžÐ’ÐšÐ
    ];

    public function orders()
    {
        return $this->hasMany(Order::class)->latest();
    }
}
</file>

<file path="app/Http/Controllers/CartController.php">
<?php

namespace App\Http\Controllers;

use App\Models\Product;
use App\Models\Order;
use App\Models\OrderItem;
use App\Models\PromoCode;
use App\Models\TelegramConfig;
use App\Models\User;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Hash;

class CartController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    // --- HELPER: ÐÐ¾Ñ€Ð¼Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð° ---
    // ÐŸÑ€Ð¸Ð²Ð¾Ð´Ð¸Ñ‚ Ð½Ð¾Ð¼ÐµÑ€Ð° (097..., 38097...) Ðº ÐµÐ´Ð¸Ð½Ð¾Ð¼Ñƒ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ñƒ +380...
    private function normalizePhone($phone)
    {
        // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²ÑÐµ Ð»Ð¸ÑˆÐ½Ð¸Ðµ ÑÐ¸Ð¼Ð²Ð¾Ð»Ñ‹
        $clean = preg_replace('/[^0-9+]/', '', $phone);
        
        // Ð•ÑÐ»Ð¸ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ Ñ 0 (097...), Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ +38
        if (str_starts_with($clean, '0')) {
            return '+38' . $clean;
        }
        
        // Ð•ÑÐ»Ð¸ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ Ñ 380 (Ð±ÐµÐ· Ð¿Ð»ÑŽÑÐ°), Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð¿Ð»ÑŽÑ
        if (str_starts_with($clean, '380')) {
            return '+' . $clean;
        }

        return $clean;
    }

    // --- HELPER: Ð˜Ð·Ð¾Ð»ÑÑ†Ð¸Ñ Ð¡ÐµÑÑÐ¸Ð¸ ---
    private function getCartKey()
    {
        return 'cart_' . $this->tenantService->getCurrentTenantId();
    }

    private function getPromoKey()
    {
        return 'promo_code_' . $this->tenantService->getCurrentTenantId();
    }

    // --- HELPER: Ð˜Ð·Ð¾Ð»ÑÑ†Ð¸Ñ Ð‘Ð” ---
    // ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°ÐµÑ‚ ÑÑ…ÐµÐ¼Ñƒ Ð‘Ð” Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ð´Ð¾Ð¼ÐµÐ½Ð°
    private function resolveTenant()
    {
        $host = request()->getHost();
        $map = $this->tenantService->getDomainMap();
        $tenantId = $map[$host] ?? 'default';
        $this->tenantService->switchTenant($tenantId);
        return $tenantId;
    }

    // --- ÐŸÐ ÐžÐ¡ÐœÐžÐ¢Ð  ÐšÐžÐ Ð—Ð˜ÐÐ« ---
    public function index()
    {
        $tenantId = $this->resolveTenant();
        $cartKey = $this->getCartKey();
        $promoKey = $this->getPromoKey();
        
        // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñƒ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð°
        $cart = session()->get($cartKey, []);
        $promoCode = session()->get($promoKey, null);
        
        $cartItems = [];
        $subtotal = 0;
        $discount = 0;

        foreach ($cart as $key => $item) {
            // Ð˜Ñ‰ÐµÐ¼ Ñ‚Ð¾Ð²Ð°Ñ€ Ð² Ð‘Ð” Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð°
            $product = Product::find($item['product_id']);
            
            // Ð•ÑÐ»Ð¸ Ñ‚Ð¾Ð²Ð°Ñ€ ÑƒÐ´Ð°Ð»ÐµÐ½ - ÑƒÐ±Ð¸Ñ€Ð°ÐµÐ¼ Ð¸Ð· ÑÐµÑÑÐ¸Ð¸
            if (!$product) {
                unset($cart[$key]);
                continue;
            }
            
            $price = $product->current_price;
            $lineTotal = $price * $item['quantity'];
            $subtotal += $lineTotal;

            $cartItems[] = [
                'product' => $product,
                'size' => $item['size'],
                'quantity' => $item['quantity'],
                'price' => $price,
                'total' => $lineTotal,
                'row_id' => $key
            ];
        }
        
        // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐµÑÑÐ¸ÑŽ (ÐµÑÐ»Ð¸ ÑƒÐ´Ð°Ð»ÑÐ»Ð¸ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹)
        session()->put($cartKey, $cart);

        // Ð›Ð¾Ð³Ð¸ÐºÐ° Ð¿Ñ€Ð¾Ð¼Ð¾ÐºÐ¾Ð´Ð°
        if ($promoCode) {
            $promo = PromoCode::where('code', $promoCode)->first();
            
            if ($promo && $promo->isValid()) {
                $scopeData = $promo->scope_data ?? [];
                
                // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÐ¸ Ð¿Ñ€Ð¾Ð¼Ð¾ÐºÐ¾Ð´Ð° Ðº Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ñƒ
                if ($promo->scope_type === 'global' || isset($scopeData[$tenantId])) {
                    if ($promo->type === 'fixed') {
                        $discount = $promo->value;
                    } else {
                        $discount = ($subtotal * $promo->value) / 100;
                    }
                } else {
                    session()->forget($promoKey);
                }
            } else {
                session()->forget($promoKey);
            }
        }

        $total = max(0, $subtotal - $discount);

        // Ð˜Ñ‰ÐµÐ¼ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑˆÐ°Ð±Ð»Ð¾Ð½ ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñ‹, ÐµÑÐ»Ð¸ Ð½ÐµÑ‚ â€” Ð±ÐµÑ€ÐµÐ¼ Ð¾Ð±Ñ‰Ð¸Ð¹
        $view = "tenants.{$tenantId}.cart";
        if (!view()->exists($view)) {
            $view = 'cart.index';
        }

        return view($view, compact('cartItems', 'subtotal', 'discount', 'total', 'promoCode'));
    }

    // --- Ð”ÐžÐ‘ÐÐ’Ð›Ð•ÐÐ˜Ð• Ð¢ÐžÐ’ÐÐ Ð ---
    public function addToCart(Request $request)
    {
        $this->resolveTenant();
        
        $product = Product::findOrFail($request->product_id);
        
        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÐµÑÑ‚ÑŒ Ð»Ð¸ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð¾Ð² Ñƒ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
        $hasVariants = $product->variants()->count() > 0;

        $request->validate([
            'product_id' => 'required|exists:products,id',
            // Ð•ÑÐ»Ð¸ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ ÐµÑÑ‚ÑŒ, Ñ€Ð°Ð·Ð¼ÐµÑ€ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÐµÐ½
            'size' => $hasVariants ? 'required|string' : 'nullable|string',
        ]);

        $size = $request->size ?? 'One Size';
        
        // Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð°
        if ($hasVariants) {
            $variant = $product->variants()->where('size', $size)->first();
            if (!$variant) {
                return back()->with('error', 'Selected size is invalid.');
            }
            if ($variant->stock <= 0) {
                return back()->with('error', 'Selected size is out of stock.');
            }
        } else {
             if ($product->stock_quantity <= 0) {
                 return back()->with('error', 'Product is out of stock.');
             }
        }
        
        $rowId = $product->id . '_' . $size;
        $cartKey = $this->getCartKey();

        $cart = session()->get($cartKey, []);

        if (isset($cart[$rowId])) {
            $cart[$rowId]['quantity']++;
        } else {
            $cart[$rowId] = [
                'product_id' => $product->id,
                'size' => $size,
                'quantity' => 1
            ];
        }

        session()->put($cartKey, $cart);

        return redirect()->route('cart.index')->with('success', 'Product added to cart!');
    }

    // --- Ð£Ð”ÐÐ›Ð•ÐÐ˜Ð• Ð˜Ð— ÐšÐžÐ Ð—Ð˜ÐÐ« ---
    public function removeFromCart($rowId)
    {
        $this->resolveTenant();
        $cartKey = $this->getCartKey();
        
        $cart = session()->get($cartKey, []);
        if (isset($cart[$rowId])) {
            unset($cart[$rowId]);
            session()->put($cartKey, $cart);
        }
        return back()->with('success', 'Item removed.');
    }

    // --- ÐŸÐ ÐžÐœÐžÐšÐžÐ” ---
    public function applyPromo(Request $request)
    {
        $this->resolveTenant();
        
        $request->validate(['code' => 'required|string']);
        $code = Str::upper($request->code);

        $promo = PromoCode::where('code', $code)->first();

        if (!$promo || !$promo->isValid()) {
            return back()->with('error', 'Invalid or expired promo code.');
        }

        session()->put($this->getPromoKey(), $code);

        return back()->with('success', 'Promo code applied!');
    }

    // --- ÐžÐ¤ÐžÐ ÐœÐ›Ð•ÐÐ˜Ð• Ð—ÐÐšÐÐ—Ð (CHECKOUT) ---
    public function checkout(Request $request)
    {
        $this->resolveTenant();
        
        // 1. Ð’Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ñ
        $validated = $request->validate([
            'customer_name' => 'required|string|max:255',
            'customer_email' => 'required|email',
            // Regex Ð´Ð»Ñ ÑƒÐºÑ€Ð°Ð¸Ð½ÑÐºÐ¸Ñ… Ð½Ð¾Ð¼ÐµÑ€Ð¾Ð² (+380... Ð¸Ð»Ð¸ 0...)
            'customer_phone' => ['required', 'string', 'regex:/^(\+380|0)[0-9]{9}$/'],
            'shipping_method' => 'required|in:nova_poshta,courier,pickup',
            'shipping_address' => 'required|string|min:5',
        ], [
            'customer_phone.regex' => 'Please enter a valid Ukrainian phone number (e.g., 0971234567 or +380...)'
        ]);

        // ÐÐ¾Ñ€Ð¼Ð°Ð»Ð¸Ð·ÑƒÐµÐ¼ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½ Ð¿ÐµÑ€ÐµÐ´ Ð¿Ð¾Ð¸ÑÐºÐ¾Ð¼/ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸ÐµÐ¼
        $normalizedPhone = $this->normalizePhone($validated['customer_phone']);

        $cartKey = $this->getCartKey();
        $promoKey = $this->getPromoKey();
        $cart = session()->get($cartKey, []);

        if (empty($cart)) {
            return back()->with('error', 'Your cart is empty.');
        }

        // 2. Ð Ð°ÑÑ‡ÐµÑ‚ Ð¸ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð¾ÐºÐ¾Ð²
        $subtotal = 0;
        $orderItemsData = [];
        
        foreach ($cart as $item) {
            $product = Product::find($item['product_id']);
            if (!$product) continue;

            // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÑ‚Ð¾ÐºÐ°
            $variant = $product->variants()->where('size', $item['size'])->first();
            
            if ($variant && $variant->stock < $item['quantity']) {
                return back()->with('error', "Sorry, size {$item['size']} for {$product->name} is out of stock.");
            }
            if (!$variant && $product->stock_quantity < $item['quantity']) {
                return back()->with('error', "Sorry, {$product->name} is out of stock.");
            }

            $price = $product->current_price;
            $lineTotal = $price * $item['quantity'];
            $subtotal += $lineTotal;

            $orderItemsData[] = [
                'product' => $product,
                'size' => $item['size'],
                'quantity' => $item['quantity'],
                'price' => $price,
                'total' => $lineTotal,
            ];
        }

        $discount = 0;
        $promoCode = session()->get($promoKey);
        
        if ($promoCode) {
            $promo = PromoCode::where('code', $promoCode)->first();
            if ($promo && $promo->isValid()) {
                 $discount = ($promo->type === 'fixed') ? $promo->value : ($subtotal * $promo->value / 100);
            }
        }
        $total = max(0, $subtotal - $discount);

        // 3. Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°ÐºÐ°Ð·Ð° (Ð¢Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ð¸Ñ)
        try {
            $generatedPassword = null;
            $user = null;

            DB::transaction(function () use ($validated, $normalizedPhone, $subtotal, $discount, $total, $promoCode, $orderItemsData, &$generatedPassword, &$user) {
                
                $user = User::where('phone', $normalizedPhone)->first();

                if (!$user) {
                    $generatedPassword = Str::random(8); 
                    
                    $user = User::create([
                        'name' => $validated['customer_name'],
                        'email' => $validated['customer_email'],
                        'phone' => $normalizedPhone,
                        'password' => Hash::make($generatedPassword),
                        'role' => 'client',
                        // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ñ‚Ð¾Ñ‚ Ð¶Ðµ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ ÐºÐ°Ðº "Ð’ÐµÑ‡Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°"
                        // Laravel Ð·Ð°ÑˆÐ¸Ñ„Ñ€ÑƒÐµÑ‚ ÐµÐ³Ð¾ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð±Ð»Ð°Ð³Ð¾Ð´Ð°Ñ€Ñ $casts
                        'access_key' => $generatedPassword, 
                    ]);
                } else {
                    // Ð•ÑÐ»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÐ¶Ðµ ÐµÑÑ‚ÑŒ, Ð½Ð¾ Ñƒ Ð½ÐµÐ³Ð¾ Ð½ÐµÑ‚ ÐºÐ»ÑŽÑ‡Ð° (ÑÑ‚Ð°Ñ€Ñ‹Ð¹ ÑŽÐ·ÐµÑ€),
                    // Ð¼Ð¾Ð¶ÐµÐ¼ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÐµÐ¼Ñƒ ÐºÐ»ÑŽÑ‡ ÑÐµÐ¹Ñ‡Ð°Ñ.
                    if (!$user->access_key) {
                         // Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡, Ð½Ð¾ ÐÐ• Ð¼ÐµÐ½ÑÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ
                         $newKey = Str::random(8);
                         $user->update(['access_key' => $newKey]);
                         // ÐŸÐµÑ€ÐµÐ´Ð°Ð´Ð¸Ð¼ ÐµÐ³Ð¾ Ð´Ð»Ñ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð¸Ñ, Ð½Ð¾ Ð¿Ð¾Ð¼ÐµÑ‚Ð¸Ð¼ ÐºÐ°Ðº Key, Ð° Ð½Ðµ Password
                         $generatedPassword = $newKey; 
                    }
                }

                // Ð‘) Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°ÐºÐ°Ð·Ð° Ñ Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÐ¾Ð¹ (user_id)
                $order = Order::create([
                    'order_number' => 'ORD-' . date('Ymd') . '-' . strtoupper(Str::random(5)),
                    'user_id' => $user->id,
                    'customer_name' => $validated['customer_name'],
                    'customer_email' => $validated['customer_email'],
                    'customer_phone' => $normalizedPhone,
                    'shipping_method' => $validated['shipping_method'],
                    'shipping_address' => $validated['shipping_address'],
                    'subtotal' => $subtotal,
                    'discount_amount' => $discount,
                    'total_amount' => $total,
                    'promo_code' => $promoCode,
                    'status' => 'new',
                    'payment_method' => 'cod',
                ]);

                // Ð’) Ð¢Ð¾Ð²Ð°Ñ€Ñ‹ Ð¸ ÑÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ ÑÑ‚Ð¾ÐºÐ°
                foreach ($orderItemsData as $data) {
                    OrderItem::create([
                        'order_id' => $order->id,
                        'product_id' => $data['product']->id,
                        'product_name' => $data['product']->name,
                        'sku' => $data['product']->sku,
                        'size' => $data['size'],
                        'quantity' => $data['quantity'],
                        'price' => $data['price'],
                        'total' => $data['total'],
                    ]);

                    $variant = $data['product']->variants()->where('size', $data['size'])->first();
                    if ($variant) {
                        $variant->decrement('stock', $data['quantity']);
                    }
                    $data['product']->decrement('stock_quantity', $data['quantity']);
                }

                // Ð“) Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð² Telegram
                $this->sendTelegramNotification($order);
                
                // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ID Ð·Ð°ÐºÐ°Ð·Ð° (Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿Ð¾Ð½Ð°Ð´Ð¾Ð±Ð¸Ñ‚ÑŒÑÑ)
                session()->flash('last_order_id', $order->id);
            });

            // 4. ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° ÐºÐ¾Ñ€Ð·Ð¸Ð½Ñ‹ Ð­Ð¢ÐžÐ“Ðž Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð°
            session()->forget([$cartKey, $promoKey]);

            // 5. Ð›Ð¾Ð³Ð¸ÐºÐ° Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸
            
            // Ð•ÑÐ»Ð¸ Ð¼Ñ‹ ÐÐ´Ð¼Ð¸Ð½ Ð¸Ð»Ð¸ ÐœÐµÐ½ÐµÐ´Ð¶ÐµÑ€ â€” ÐÐ• Ð»Ð¾Ð³Ð¸Ð½Ð¸Ð¼ÑÑ ÐºÐ°Ðº ÐºÐ»Ð¸ÐµÐ½Ñ‚, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð¿Ð¾Ñ‚ÐµÑ€ÑÑ‚ÑŒ Ð°Ð´Ð¼Ð¸Ð½ÐºÑƒ
            if (Auth::check() && in_array(Auth::user()->role, ['super_admin', 'manager'])) {
                return redirect()->route('home')->with('success', "Order placed successfully. Admin session preserved. Order linked to User ID: {$user->id}");
            }

            // Ð•ÑÐ»Ð¸ Ð¼Ñ‹ Ð³Ð¾ÑÑ‚ÑŒ â€” Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·ÑƒÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
            Auth::login($user);

            // ÐŸÐµÑ€ÐµÐ´Ð°ÐµÐ¼ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ Ð²Ð¾ flash, ÐµÑÐ»Ð¸ Ð¾Ð½ Ð±Ñ‹Ð» ÑÐ¾Ð·Ð´Ð°Ð½
            if ($generatedPassword) {
                session()->flash('generated_password', $generatedPassword);
                session()->flash('new_account_created', true);
            }

            // 6. Ð ÐµÐ´Ð¸Ñ€ÐµÐºÑ‚ Ð² ÐºÐ°Ð±Ð¸Ð½ÐµÑ‚
            return redirect()->route('client.profile')->with('success', 'Order placed successfully! Welcome to your profile.');

        } catch (\Exception $e) {
            Log::error("Checkout Error: " . $e->getMessage());
            return back()->with('error', 'Checkout failed: ' . $e->getMessage());
        }
    }

    // --- TELEGRAM ---
    private function sendTelegramNotification($order)
    {
        $tenantId = $this->tenantService->getCurrentTenantId();
        
        $config = TelegramConfig::where('tenant_id', $tenantId)->where('is_active', true)->first();
        if (!$config) {
            $config = TelegramConfig::whereNull('tenant_id')->where('is_active', true)->first();
        }

        if ($config) {
            $itemsList = "";
            foreach ($order->items as $item) {
                $itemsList .= "- {$item->product_name} ({$item->size}) x{$item->quantity}\n";
            }

            $message = "ðŸ†• *New Order #{$order->order_number}*\n" .
                       "Store: " . strtoupper($tenantId) . "\n" .
                       "Customer: {$order->customer_name}\n" .
                       "Phone: {$order->customer_phone}\n" .
                       "Total: *$" . $order->total_amount . "*\n" .
                       "----------------\n" .
                       $itemsList . 
                       "\nDelivery: {$order->shipping_method}\n" .
                       "Address: {$order->shipping_address}";

            try {
                Http::post("https://api.telegram.org/bot{$config->bot_token}/sendMessage", [
                    'chat_id' => $config->chat_id,
                    'text' => $message,
                    'parse_mode' => 'Markdown',
                ]);
            } catch (\Exception $e) {
                Log::error("Telegram Send Error: " . $e->getMessage());
            }
        }
    }
}
</file>

<file path="app/Models/Order.php">
<?php
// FILE: app/Models/Order.php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;

class Order extends Model
{
    use HasFactory;

    protected $fillable = [
        'order_number',
        'user_id',
        'customer_name',
        'customer_email',
        'customer_phone',
        'shipping_method',
        'shipping_address',
        'payment_method',
        'payment_status',
        'subtotal',
        'discount_amount',
        'total_amount',
        'promo_code',
        'status',
        'is_instagram',
    ];

    protected $casts = [
        'is_instagram' => 'boolean',
        'subtotal' => 'decimal:2',
        'total_amount' => 'decimal:2',
        'discount_amount' => 'decimal:2',
    ];

    // Ð¥Ð•Ð›ÐŸÐ•Ð  Ð”Ð›Ð¯ Ð¦Ð’Ð•Ð¢ÐžÐ’ Ð¡Ð¢ÐÐ¢Ð£Ð¡Ð (Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰ÐµÐ½ Ð¿Ð¾ Ð·Ð°Ð¿Ñ€Ð¾ÑÑƒ)
    // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð² Blade: {{ $order->status_color }}
    public function getStatusColorAttribute()
    {
        return match ($this->status) {
            'new' => 'bg-blue-100 text-blue-800',
            'processing' => 'bg-yellow-100 text-yellow-800',
            'shipped' => 'bg-purple-100 text-purple-800',
            'completed' => 'bg-green-100 text-green-800',
            'cancelled' => 'bg-red-100 text-red-800',
            default => 'bg-gray-100 text-gray-800',
        };
    }

    public function items()
    {
        return $this->hasMany(OrderItem::class);
    }

    public function user()
    {
        return $this->belongsTo(User::class);
    }
}
</file>

<file path="app/Http/Controllers/ShopController.php">
<?php
// FILE: app/Http/Controllers/ShopController.php

namespace App\Http\Controllers;

use App\Models\Product;
use App\Models\Category;
use App\Services\TenantService;
use Illuminate\Http\Request;

class ShopController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    private function resolveTenant()
    {
        $host = request()->getHost();
        $map = $this->tenantService->getDomainMap();
        $tenantId = $map[$host] ?? 'default';
        $this->tenantService->switchTenant($tenantId);
        return $tenantId;
    }

    public function index()
    {
        $tenantId = $this->resolveTenant();

        // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚Ð¾Ð²Ð°Ñ€Ñ‹ Ð¸ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð°
        $products = Product::with('clothingLine')
            ->where('stock_quantity', '>', 0)
            ->latest()
            ->paginate(12);
            
        $categories = Category::all();

        // Ð›ÐžÐ“Ð˜ÐšÐ Ð’Ð«Ð‘ÐžÐ Ð Ð¨ÐÐ‘Ð›ÐžÐÐ
        // 1. Ð˜Ñ‰ÐµÐ¼ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ð¹ ÑˆÐ°Ð±Ð»Ð¾Ð½: resources/views/tenants/{id}/home.blade.php
        $view = "tenants.{$tenantId}.home";
        
        // 2. Ð•ÑÐ»Ð¸ ÐµÐ³Ð¾ Ð½ÐµÑ‚ (Ð¼Ñ‹ Ð¸Ñ… ÑƒÐ´Ð°Ð»Ð¸Ð»Ð¸ Ð´Ð»Ñ ÑƒÐ½Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸), Ð±ÐµÑ€ÐµÐ¼ ÐžÐ‘Ð©Ð˜Ð™: resources/views/shop/home.blade.php
        if (!view()->exists($view)) {
            $view = 'shop.home'; // Ð‘Ð«Ð›Ðž: shop.fallback_home (ÐžÐ¨Ð˜Ð‘ÐšÐ) -> Ð¡Ð¢ÐÐ›Ðž: shop.home
        }

        return view($view, compact('products', 'categories'));
    }

    public function show($slug)
    {
        $tenantId = $this->resolveTenant();

        $product = Product::where('slug', $slug)
            ->with(['variants', 'clothingLine', 'images'])
            ->firstOrFail();

        // Ð›ÐžÐ“Ð˜ÐšÐ Ð’Ð«Ð‘ÐžÐ Ð Ð¨ÐÐ‘Ð›ÐžÐÐ Ð¢ÐžÐ’ÐÐ Ð
        $view = "tenants.{$tenantId}.product";
        
        if (!view()->exists($view)) {
            $view = 'shop.product'; // Ð£Ð½Ð¸Ð²ÐµÑ€ÑÐ°Ð»ÑŒÐ½Ð°Ñ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° Ñ‚Ð¾Ð²Ð°Ñ€Ð°
        }

        return view($view, compact('product'));
    }
}
</file>

<file path="app/Http/Controllers/Admin/UserController.php">
<?php
// FILE: app/Http/Controllers/Admin/UserController.php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\User;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Hash;
use Illuminate\Validation\Rule;
use Illuminate\Support\Str;
use Illuminate\Support\Facades\DB;

class UserController extends Controller
{
    protected TenantService $tenantService;

    public function __construct(TenantService $tenantService)
    {
        $this->tenantService = $tenantService;
    }

    // Ð¥ÐµÐ»Ð¿ÐµÑ€ Ð´Ð»Ñ Ð½Ð¾Ñ€Ð¼Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð° (Ð£ÐºÑ€Ð°Ð¸Ð½Ð°)
    private function normalizePhone($phone)
    {
        // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²ÑÐµ ÐºÑ€Ð¾Ð¼Ðµ Ñ†Ð¸Ñ„Ñ€
        $phone = preg_replace('/[^0-9]/', '', $phone);
        
        // Ð•ÑÐ»Ð¸ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ Ñ 380... -> +380...
        if (str_starts_with($phone, '380')) {
            return '+' . $phone;
        }
        // Ð•ÑÐ»Ð¸ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ÑÑ Ñ 0... (097...) -> +380...
        if (str_starts_with($phone, '0')) {
            return '+38' . $phone;
        }
        
        // Ð’ Ð¾ÑÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ñ… ÑÐ»ÑƒÑ‡Ð°ÑÑ… Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ ÐºÐ°Ðº ÐµÑÑ‚ÑŒ (Ð¸Ð»Ð¸ Ð´Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ +)
        return '+' . $phone;
    }

    private function switchToPublic()
    {
        DB::statement('SET search_path TO public');
    }

    public function index(Request $request)
    {
        // 1. ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð¸Ñ‰ÐµÐ¼ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð² PUBLIC ÑÑ…ÐµÐ¼Ðµ
        $this->switchToPublic();

        $query = User::where('role', 'client')->latest();

        // 2. Ð›Ð¾Ð³Ð¸ÐºÐ° Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ñ†Ð¸Ð¸
        if (auth()->user()->role !== 'super_admin') {
            // ÐœÐµÐ½ÐµÐ´Ð¶ÐµÑ€ Ð²Ð¸Ð´Ð¸Ñ‚ ÑÐ²Ð¾Ð¸Ñ… + Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ñ‹Ñ…
            $currentTenant = $this->tenantService->getCurrentTenantId();
            $query->where(function($q) use ($currentTenant) {
                $q->where('tenant_id', $currentTenant)
                  ->orWhereNull('tenant_id');
            });
        } elseif ($request->has('tenant_id') && $request->tenant_id) {
            // Ð¡ÑƒÐ¿ÐµÑ€-Ð°Ð´Ð¼Ð¸Ð½ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€ÑƒÐµÑ‚ Ð¿Ð¾ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ñƒ
            $query->where('tenant_id', $request->tenant_id);
        }

        if ($request->has('search') && $request->search) {
            $search = $request->search;
            $query->where(function($q) use ($search) {
                $q->where('name', 'like', "%{$search}%")
                  ->orWhere('email', 'like', "%{$search}%")
                  ->orWhere('phone', 'like', "%{$search}%");
            });
        }

        $users = $query->paginate(20);
        
        // ÐŸÐµÑ€ÐµÐ´Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ tenant_id Ð´Ð»Ñ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚Ð° Ð² ÑÑÑ‹Ð»ÐºÐ°Ñ… (Ñ…Ð¾Ñ‚Ñ Ð´Ð»Ñ users ÑÑ‚Ð¾ Ð¼ÐµÐ½ÐµÐµ ÐºÑ€Ð¸Ñ‚Ð¸Ñ‡Ð½Ð¾)
        $currentTenantId = auth()->user()->role === 'super_admin' ? $request->get('tenant_id') : $this->tenantService->getCurrentTenantId();

        return view('admin.users.index', compact('users', 'currentTenantId'));
    }

    public function create()
    {
        $user = new User();
        $tenants = config('tenants.tenants');
        return view('admin.users.form', compact('user', 'tenants'));
    }

    public function store(Request $request)
    {
        $this->switchToPublic(); // ÐŸÐ¸ÑˆÐµÐ¼ Ð² public

        $isSuperAdmin = auth()->user()->role === 'super_admin';

        $validated = $request->validate([
            'name' => 'required|string|max:255',
            'email' => 'nullable|email|unique:users,email',
            'phone' => 'required|string|unique:users,phone',
            'password' => 'required|string|min:6',
            'tenant_id' => $isSuperAdmin ? 'nullable|string' : 'nullable',
        ]);

        // ÐÐ¾Ñ€Ð¼Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°
        $phone = $this->normalizePhone($validated['phone']);
        
        // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð° ÐŸÐžÐ¡Ð›Ð• Ð½Ð¾Ñ€Ð¼Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸
        if (User::where('phone', $phone)->exists()) {
             return back()->withErrors(['phone' => 'This phone number is already registered.'])->withInput();
        }

        // ÐžÐŸÐ Ð•Ð”Ð•Ð›Ð•ÐÐ˜Ð• ÐœÐÐ“ÐÐ—Ð˜ÐÐ
        $tenantId = null;
        if ($isSuperAdmin) {
            $tenantId = $request->input('tenant_id');
        } else {
            // Ð•ÑÐ»Ð¸ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€ ÑÐ¾Ð·Ð´Ð°ÐµÑ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ - Ð¾Ð½ ÐŸÐ Ð˜Ð’Ð¯Ð—Ð«Ð’ÐÐ•Ð¢Ð¡Ð¯ Ðº Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ñƒ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€Ð°
            $tenantId = $this->tenantService->getCurrentTenantId();
        }

        $accessKey = $validated['password']; 

        User::create([
            'name' => $validated['name'],
            'email' => $validated['email'],
            'phone' => $phone,
            'password' => Hash::make($validated['password']),
            'role' => 'client',
            'tenant_id' => $tenantId, // Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€ Ð·Ð°Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÑ‚ ÑÐ²Ð¾Ð¹ ID
            'access_key' => $accessKey,
        ]);

        return redirect()->route('admin.users.index')->with('success', 'Customer created successfully.');
    }

    // Ð˜Ð¡ÐŸÐžÐ›Ð¬Ð—Ð£Ð•Ðœ $id Ð’ÐœÐ•Ð¡Ð¢Ðž Model Binding, Ð§Ð¢ÐžÐ‘Ð« Ð˜Ð—Ð‘Ð•Ð–ÐÐ¢Ð¬ 404 Ð’ Ð§Ð£Ð–ÐžÐ™ Ð¡Ð¥Ð•ÐœÐ•
    public function show($id)
    {
        $this->switchToPublic();
        $user = User::findOrFail($id);
        return view('admin.users.show', compact('user'));
    }

    public function edit($id)
    {
        $this->switchToPublic();
        $user = User::findOrFail($id);
        $tenants = config('tenants.tenants');
        return view('admin.users.form', compact('user', 'tenants'));
    }

    public function update(Request $request, $id)
    {
        $this->switchToPublic();
        $user = User::findOrFail($id);

        // Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð¿Ð°Ñ€Ð¾Ð»Ñ (ÐºÐ½Ð¾Ð¿ÐºÐ° Reset)
        if ($request->has('generate_password')) {
            $newPassword = Str::random(8);
            $user->update([
                'password' => Hash::make($newPassword),
                'access_key' => $newPassword
            ]);
            return back()->with('success', "New Key Generated: $newPassword");
        }

        $validated = $request->validate([
            'name' => 'required|string|max:255',
            'email' => ['nullable', 'email', Rule::unique('users')->ignore($user->id)],
            'phone' => ['required', 'string'], // Ð£Ð±Ñ€Ð°Ð»Ð¸ ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚ÑŒ Ð·Ð´ÐµÑÑŒ, Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ð¼ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
            'password' => 'nullable|string|min:6',
        ]);

        $phone = $this->normalizePhone($validated['phone']);

        // Ð ÑƒÑ‡Ð½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ð¾ÑÑ‚Ð¸ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð° Ð¿Ñ€Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸
        if (User::where('phone', $phone)->where('id', '!=', $user->id)->exists()) {
            return back()->withErrors(['phone' => 'This phone number is taken by another user.'])->withInput();
        }

        $data = [
            'name' => $validated['name'],
            'email' => $validated['email'],
            'phone' => $phone,
        ];

        if ($request->filled('password')) {
            $data['password'] = Hash::make($validated['password']);
            $data['access_key'] = $validated['password'];
        }

        $user->update($data);

        return redirect()->route('admin.users.index')->with('success', 'Customer profile updated.');
    }
    
    public function destroy($id)
    {
        if (auth()->user()->role !== 'super_admin') {
            abort(403);
        }
        $this->switchToPublic();
        User::destroy($id);
        return back()->with('success', 'User deleted.');
    }
}
</file>

<file path="app/Models/Product.php">
<?php
// FILE: app/Models/Product.php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;
use App\Models\PromoCode;
use App\Services\TenantService;

class Product extends Model
{
    use HasFactory, SoftDeletes;

    protected $fillable = [
        'name', 'slug', 'description', 'price', 'sale_price',
        'sku', 'stock_quantity', 'attributes', 'clothing_line_id',
    ];

    protected $casts = [
        'attributes' => 'array',
        'price' => 'decimal:2',
        'sale_price' => 'decimal:2',
    ];

    public function categories()
    {
        return $this->belongsToMany(Category::class);
    }

    public function images()
    {
        return $this->hasMany(ProductImage::class)->orderBy('sort_order', 'asc');
    }

    public function variants()
    {
        return $this->hasMany(ProductVariant::class);
    }
    
    public function clothingLine()
    {
        return $this->belongsTo(ClothingLine::class);
    }

    // Ð¡ÐºÐ¸Ð´ÐºÐ¸
    public function getHasDiscountAttribute()
    {
        return $this->sale_price && $this->sale_price < $this->price;
    }

    public function getDiscountPercentageAttribute()
    {
        if (!$this->has_discount) return 0;
        return round((($this->price - $this->sale_price) / $this->price) * 100);
    }

    public function getCurrentPriceAttribute()
    {
        return $this->has_discount ? $this->sale_price : $this->price;
    }

    public function getCoverUrlAttribute()
    {
        $cover = $this->images->first();
        if ($cover) return $cover->url;
        $text = urlencode($this->sku ?? 'Product');
        return "https://placehold.co/600x600/e2e8f0/1e293b?text={$text}";
    }
    
    public function getImageUrlAttribute()
    {
        return $this->cover_url;
    }

    /**
     * Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÑ‚ ÑÐ¿Ð¸ÑÐ¾Ðº Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð¿Ñ€Ð¾Ð¼Ð¾ÐºÐ¾Ð´Ð¾Ð², Ð¿Ñ€Ð¸Ð¼ÐµÐ½Ð¸Ð¼Ñ‹Ñ… Ðº ÑÑ‚Ð¾Ð¼Ñƒ Ñ‚Ð¾Ð²Ð°Ñ€Ñƒ.
     * Ð’ÐÐ˜ÐœÐÐÐ˜Ð•: Ð­Ñ‚Ð¾ Ð½Ðµ ÑÐ°Ð¼Ñ‹Ð¹ Ð¾Ð¿Ñ‚Ð¸Ð¼Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð¼ÐµÑ‚Ð¾Ð´ Ð´Ð»Ñ ÑÐ¿Ð¸ÑÐºÐ¾Ð² Ð¸Ð· 1000 Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð²,
     * Ð½Ð¾ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½ÐºÐ¸ Ð¸ ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐ¸ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð¿Ð¾Ð´Ð¾Ð¹Ð´ÐµÑ‚.
     */
    public function getApplicablePromosAttribute()
    {
        $tenantId = TenantService::getStaticCurrentTenantId();
        
        // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð²ÑÐµ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð¿Ñ€Ð¾Ð¼Ð¾ÐºÐ¾Ð´Ñ‹
        $promos = PromoCode::where('is_active', true)
            ->where(function($q) {
                $q->whereNull('expires_at')->orWhere('expires_at', '>', now());
            })
            ->get();

        $applicable = [];

        foreach ($promos as $promo) {
            $scope = $promo->scope_type;
            $data = $promo->scope_data ?? [];

            // Ð•ÑÐ»Ð¸ Ð¿Ñ€Ð¾Ð¼Ð¾ÐºÐ¾Ð´ Ð½Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ñ‚ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ ÑÑ‚Ð¾Ð³Ð¾ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð° (Ð¸ Ð½Ðµ Ð³Ð»Ð¾Ð±Ð°Ð»ÑŒÐ½Ñ‹Ð¹), Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼
            if ($scope !== 'global' && !isset($data[$tenantId])) {
                continue;
            }

            $match = false;

            if ($scope === 'global') {
                $match = true;
            } elseif ($scope === 'specific') {
                // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ID Ñ‚Ð¾Ð²Ð°Ñ€Ð°
                if (in_array($this->id, $data[$tenantId] ?? [])) {
                    $match = true;
                }
            } elseif ($scope === 'category') {
                // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸Ð¸
                $productCatSlugs = $this->categories->pluck('slug')->toArray();
                $promoCatSlugs = $data[$tenantId] ?? [];
                if (!empty(array_intersect($productCatSlugs, $promoCatSlugs))) {
                    $match = true;
                }
            } elseif ($scope === 'line') {
                // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð»Ð¸Ð½ÐµÐ¹ÐºÑƒ
                if ($this->clothingLine && in_array($this->clothingLine->slug, $data[$tenantId] ?? [])) {
                    $match = true;
                }
            }

            if ($match) {
                $applicable[] = $promo;
            }
        }

        return collect($applicable);
    }
}
</file>

<file path="app/Http/Controllers/Admin/ProductController.php">
<?php
// FILE: app/Http/Controllers/Admin/ProductController.php

namespace App\Http\Controllers\Admin;

use App\Http\Controllers\Controller;
use App\Models\Category;
use App\Models\Product;
use App\Models\ProductImage;
use App\Models\ProductVariant;
use App\Models\AttributeOption;
use App\Models\ClothingLine;
use App\Services\ProductService;
use App\Services\TenantService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Str;
use Illuminate\Support\Collection;
use Illuminate\Support\Facades\DB; // Ð’Ð°Ð¶Ð½Ð¾ Ð´Ð»Ñ Ñ‚Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ð¸Ð¹

class ProductController extends Controller
{
    protected TenantService $tenantService;
    protected ProductService $productService;

    public function __construct(TenantService $tenantService, ProductService $productService)
    {
        $this->tenantService = $tenantService;
        $this->productService = $productService;
    }

    // --- CONTEXT HELPERS (ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð°) ---

    private function resolveContext(Request $request)
    {
        $user = auth()->user();
        
        // Ð•ÑÐ»Ð¸ Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€ - Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÐ³Ð¾ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½
        if ($user->role !== 'super_admin') {
            return $this->tenantService->getCurrentTenantId();
        }

        // Ð•ÑÐ»Ð¸ ÑÑƒÐ¿ÐµÑ€-Ð°Ð´Ð¼Ð¸Ð½ Ð¿ÐµÑ€ÐµÐ´Ð°Ð» ID Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð°
        $tenantId = $request->get('tenant_id');
        if ($tenantId) {
            $this->tenantService->switchTenant($tenantId);
            return $tenantId;
        }

        // Ð•ÑÐ»Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐºÑÑ‚ ÑƒÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½
        $current = $this->tenantService->getCurrentTenantId();
        if ($current) return $current;

        return null;
    }

    // --- ACTIONS (ÐœÐµÑ‚Ð¾Ð´Ñ‹ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹) ---

    public function index(Request $request)
    {
        $isSuperAdmin = auth()->user()->role === 'super_admin';
        $selectedTenant = $request->get('tenant_id');
        
        // Ð ÐµÐ¶Ð¸Ð¼ "ALL STORES" (Ð¢Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ ÑÑƒÐ¿ÐµÑ€-Ð°Ð´Ð¼Ð¸Ð½Ð° Ð±ÐµÐ· Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð°)
        if ($isSuperAdmin && empty($selectedTenant)) {
            $products = $this->getAllTenantsProducts($request);
            // ÐŸÑƒÑÑ‚Ñ‹Ðµ ÐºÐ¾Ð»Ð»ÐµÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð¾Ð²
            $categories = new Collection(); 
            $sizes = new Collection(); 
            $types = new Collection();
            $lines = new Collection();
            $currentTenantId = null;
            return view('admin.products.index', compact('products', 'categories', 'sizes', 'types', 'lines', 'currentTenantId'));
        }

        // Ð ÐµÐ¶Ð¸Ð¼ "SINGLE STORE"
        $currentTenantId = $this->resolveContext($request);
        
        // Ð¤Ð¾Ð»Ð»Ð±ÐµÐº Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð°: ÐµÑÐ»Ð¸ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½ Ð½Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð½, Ð±ÐµÑ€ÐµÐ¼ Ð¿ÐµÑ€Ð²Ñ‹Ð¹
        if (!$currentTenantId && $isSuperAdmin) {
             $first = array_key_first(config('tenants.tenants'));
             $this->tenantService->switchTenant($first);
             $currentTenantId = $first;
        }

        // Ð—Ð°Ð¿Ñ€Ð¾Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ñ Ð¶Ð°Ð´Ð½Ð¾Ð¹ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¾Ð¹ ÑÐ²ÑÐ·ÐµÐ¹
        $query = Product::with(['categories', 'images', 'variants', 'clothingLine']);

        // --- Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹ ---
        if ($request->filled('search')) {
            $query->where(fn($q) => $q->where('name', 'ilike', "%{$request->search}%")->orWhere('sku', 'ilike', "%{$request->search}%"));
        }
        if ($request->filled('category_id')) {
            $query->whereHas('categories', fn($q) => $q->where('categories.id', $request->category_id));
        }
        if ($request->filled('clothing_line_id')) {
            $query->where('clothing_line_id', $request->clothing_line_id);
        }
        if ($request->filled('size')) {
            $query->whereRaw("attributes->'size' ? ?", [$request->size]);
        }
        if ($request->filled('type')) {
            $query->whereRaw("attributes->>'type' = ?", [$request->type]);
        }

        $products = $query->latest()->paginate(20)->withQueryString();
        
        // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ URL Ð¿Ñ€ÐµÐ´Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð°
        $tenantDomain = config('tenants.tenants.' . $currentTenantId . '.domain');
        foreach ($products as $product) {
            $product->preview_url = "http://{$tenantDomain}/products/{$product->slug}?preview=true";
            $product->tenant_name = config("tenants.tenants.{$currentTenantId}.name");
            $product->tenant_id = $currentTenantId;
        }

        // Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ð²Ñ‹Ð¿Ð°Ð´Ð°ÑŽÑ‰Ð¸Ñ… ÑÐ¿Ð¸ÑÐºÐ¾Ð² Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð¾Ð²
        $categories = Category::orderBy('name')->get();
        $lines = ClothingLine::orderBy('name')->get(); 
        $sizes = AttributeOption::where('type', 'size')->orderBy('value')->get();
        $types = AttributeOption::where('type', 'product_type')->orderBy('value')->get();

        return view('admin.products.index', compact('products', 'categories', 'sizes', 'types', 'lines', 'currentTenantId'));
    }

    // Ð¤Ð¾Ñ€Ð¼Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ/Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
    public function form(Request $request, $id = null)
    {
        $currentTenantId = $this->resolveContext($request);
        if (!$currentTenantId && auth()->user()->role === 'super_admin') {
             $first = array_key_first(config('tenants.tenants'));
             $this->tenantService->switchTenant($first);
             $currentTenantId = $first;
        }

        if ($id) {
            $product = Product::with(['categories', 'images', 'variants', 'clothingLine'])->findOrFail($id);
            $action = route('admin.products.update', $product->id);
            $method = 'PUT';
            $title = "Edit: " . $product->name;
            $tenantDomain = config('tenants.tenants.' . $currentTenantId . '.domain');
            $previewUrl = "http://{$tenantDomain}/products/{$product->slug}?preview=true";
        } else {
            $product = new Product();
            $action = route('admin.products.store');
            $method = 'POST';
            $title = "Add New Product";
            $previewUrl = null;
        }

        $categories = Category::all();
        $lines = ClothingLine::all(); 
        $sizes = AttributeOption::where('type', 'size')->get();
        $types = AttributeOption::where('type', 'product_type')->get();

        return view('admin.products.form', compact(
            'product', 'action', 'method', 'title', 'categories', 'lines', 'sizes', 'types', 'currentTenantId', 'previewUrl'
        ));
    }

    public function create(Request $request) { return $this->form($request); }
    public function edit(Request $request, $id) { return $this->form($request, $id); }

    // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
    public function store(Request $request)
    {
        // ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½, ÐµÑÐ»Ð¸ Ð½ÑƒÐ¶Ð½Ð¾
        if (auth()->user()->role === 'super_admin' && $request->has('target_tenant')) {
            $this->tenantService->switchTenant($request->target_tenant);
        } else {
            $this->resolveContext($request);
        }

        $validated = $this->validateProduct($request);

        // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ñ‚Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ð¸ÑŽ: Ð²ÑÑ‘ Ð¸Ð»Ð¸ Ð½Ð¸Ñ‡ÐµÐ³Ð¾
        DB::transaction(function () use ($request, $validated) {
            
            // 1. Ð¡Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼ Ð¾Ð±Ñ‰Ð¸Ð¹ ÑÑ‚Ð¾Ðº Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ð¾Ð²
            $variantsInput = $request->input('variants', []);
            $totalStock = 0;
            $sizeList = [];
            
            foreach ($variantsInput as $v) {
                if (!empty($v['size'])) {
                    $totalStock += (int)($v['stock'] ?? 0);
                    $sizeList[] = $v['size'];
                }
            }

            // 2. ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð¸Ð»Ð¸ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð›Ð¸Ð½ÐµÐ¹ÐºÑƒ ÐžÐ´ÐµÐ¶Ð´Ñ‹
            $lineId = $this->resolveClothingLineId($request->clothing_line);

            // 3. Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¿Ñ€Ð¾Ð´ÑƒÐºÑ‚ (Ð’ÐºÐ»ÑŽÑ‡Ð°Ñ sale_price)
            $product = $this->productService->create([
                'name' => $validated['name'],
                'slug' => Str::slug($validated['name']) . '-' . Str::random(4),
                'price' => $validated['price'],
                'sale_price' => $validated['sale_price'] ?? null, // Ð¡ÐºÐ¸Ð´ÐºÐ°
                'sku' => $validated['sku'],
                'stock_quantity' => $totalStock, // Ð’Ñ‹Ñ‡Ð¸ÑÐ»ÐµÐ½Ð½Ñ‹Ð¹ ÑÑ‚Ð¾Ðº
                'description' => $request->input('description'),
                'clothing_line_id' => $lineId,
                'attributes' => [
                    'type' => $request->attributes_type,
                    'size' => $sizeList,
                ]
            ]);

            // 4. Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ²ÑÐ·Ð¸
            $this->syncAttributesData($request->attributes_type, $sizeList);
            $this->syncCategories($product, $request->categories);
            $this->syncImages($request, $product);
            $this->syncVariants($product, $variantsInput);
        });

        return redirect()->route('admin.products.index', ['tenant_id' => $this->tenantService->getCurrentTenantId()])
                         ->with('success', 'Product created successfully.');
    }

    // ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
    public function update(Request $request, $id)
    {
        $this->resolveContext($request);
        $product = Product::findOrFail($id);
        
        $validated = $this->validateProduct($request, $id);
        
        DB::transaction(function () use ($request, $product, $validated) {
            
            // 1. ÐŸÐµÑ€ÐµÑÑ‡ÐµÑ‚ ÑÑ‚Ð¾ÐºÐ°
            $variantsInput = $request->input('variants', []);
            $totalStock = 0;
            $sizeList = [];
            
            foreach ($variantsInput as $v) {
                if (!empty($v['size'])) {
                    $totalStock += (int)($v['stock'] ?? 0);
                    $sizeList[] = $v['size'];
                }
            }

            // 2. Ð›Ð¸Ð½ÐµÐ¹ÐºÐ°
            $lineId = $this->resolveClothingLineId($request->clothing_line);

            // 3. ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÐµÐ¹ (Ð’ÐºÐ»ÑŽÑ‡Ð°Ñ sale_price)
            $product->update([
                'name' => $validated['name'],
                'price' => $validated['price'],
                'sale_price' => $validated['sale_price'] ?? null, // Ð¡ÐºÐ¸Ð´ÐºÐ°
                'sku' => $validated['sku'],
                'stock_quantity' => $totalStock,
                'description' => $request->input('description'),
                'clothing_line_id' => $lineId,
                'attributes' => [
                    'type' => $request->attributes_type,
                    'size' => $sizeList,
                ]
            ]);

            // 4. Ð¡Ð¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑÐ²ÑÐ·ÐµÐ¹
            $this->syncAttributesData($request->attributes_type, $sizeList);
            $this->syncCategories($product, $request->categories);
            $this->syncImagesUpdate($request, $product);
            $this->syncVariants($product, $variantsInput);
        });

        return redirect()->route('admin.products.index', ['tenant_id' => $this->tenantService->getCurrentTenantId()])
                         ->with('success', 'Product updated successfully.');
    }

    public function destroy(Request $request, $id)
    {
        $this->resolveContext($request);
        $product = Product::findOrFail($id);
        $this->productService->delete($product);
        return back()->with('success', 'Product deleted.');
    }

    // --- PRIVATE HELPERS (ÐŸÑ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ðµ Ð¼ÐµÑ‚Ð¾Ð´Ñ‹) ---

    private function validateProduct(Request $request, $id = null)
    {
        return $request->validate([
            'name' => 'required|string|max:255',
            'price' => 'required|numeric|min:0',
            // Ð¡ÐºÐ¸Ð´ÐºÐ° Ð´Ð¾Ð»Ð¶Ð½Ð° Ð±Ñ‹Ñ‚ÑŒ Ð¼ÐµÐ½ÑŒÑˆÐµ Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾Ð¹ Ñ†ÐµÐ½Ñ‹
            'sale_price' => 'nullable|numeric|min:0|lt:price', 
            'sku' => 'required|string|max:50',
            'categories' => 'required|array',
            'attributes_type' => 'required|string',
            'clothing_line' => 'nullable|string|max:255',
            
            'variants.*.size' => 'required|string',
            'variants.*.stock' => 'required|integer|min:0',
            
            'images.*' => 'image|max:10240',
            'new_images.*' => 'image|max:10240',
        ]);
    }

    private function resolveClothingLineId(?string $name): ?int
    {
        if (empty($name)) return null;
        $slug = Str::slug($name);
        $line = ClothingLine::firstOrCreate(['slug' => $slug], ['name' => $name]);
        return $line->id;
    }

    private function syncAttributesData($type, $sizes)
    {
        $typeSlug = Str::slug($type);
        AttributeOption::firstOrCreate(['type' => 'product_type', 'slug' => $typeSlug], ['value' => $type]);
        foreach ($sizes as $sizeName) {
            $sizeSlug = Str::slug($sizeName);
            AttributeOption::firstOrCreate(['type' => 'size', 'slug' => $sizeSlug], ['value' => $sizeName]);
        }
    }

    private function syncCategories(Product $product, array $categoriesInput)
    {
        $categoryIds = [];
        foreach ($categoriesInput as $input) {
            if (is_numeric($input)) {
                $categoryIds[] = $input;
            } else {
                $slug = Str::slug($input);
                $newCat = Category::firstOrCreate(['slug' => $slug], ['name' => $input]);
                $categoryIds[] = $newCat->id;
            }
        }
        $product->categories()->sync($categoryIds);
    }

    private function syncImages(Request $request, Product $product)
    {
        if ($request->hasFile('images')) {
            foreach ($request->file('images') as $index => $file) {
                $path = $file->store('media', 'tenant');
                ProductImage::create(['product_id' => $product->id, 'path' => $path, 'sort_order' => $index]);
            }
        }
    }

    private function syncImagesUpdate(Request $request, Product $product)
    {
        // Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð½Ð¾Ð²Ñ‹Ñ…
        if ($request->hasFile('new_images')) {
            $maxOrder = $product->images()->max('sort_order') ?? -1;
            foreach ($request->file('new_images') as $file) {
                $path = $file->store('media', 'tenant');
                ProductImage::create(['product_id' => $product->id, 'path' => $path, 'sort_order' => ++$maxOrder]);
            }
        }
        // Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ñ…
        if ($request->filled('deleted_images')) {
            $images = ProductImage::whereIn('id', $request->input('deleted_images'))->where('product_id', $product->id)->get();
            foreach ($images as $img) {
                Storage::disk('tenant')->delete($img->path);
                $img->delete();
            }
        }
        // Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ°
        if ($request->filled('sorted_images_ids')) {
            $sortedIds = explode(',', $request->input('sorted_images_ids'));
            foreach ($sortedIds as $index => $imgId) {
                ProductImage::where('id', $imgId)->where('product_id', $product->id)->update(['sort_order' => $index]);
            }
        }
    }

    private function syncVariants(Product $product, array $variantsInput)
    {
        // Ð£Ð´Ð°Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ€Ñ‹Ðµ Ð²Ð°Ñ€Ð¸Ð°Ð½Ñ‚Ñ‹ Ð¸ ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ðµ
        $product->variants()->delete();
        foreach ($variantsInput as $v) {
            if (!empty($v['size'])) {
                ProductVariant::create([
                    'product_id' => $product->id, 
                    'size' => $v['size'], 
                    'stock' => (int)($v['stock'] ?? 0)
                ]);
            }
        }
    }
    
    // ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² ÑÐ¾ Ð²ÑÐµÑ… Ð¼Ð°Ð³Ð°Ð·Ð¸Ð½Ð¾Ð² (Ð´Ð»Ñ Super Admin)
    private function getAllTenantsProducts(Request $request) {
        $allProducts = new Collection();
        foreach (config('tenants.tenants') as $id => $config) {
            try {
                $this->tenantService->switchTenant($id);
                // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð²Ð¼ÐµÑÑ‚Ðµ Ñ clothingLine
                $query = Product::with(['categories', 'images', 'variants', 'clothingLine'])->latest()->take(5);
                
                if ($request->filled('search')) {
                    $s = $request->search;
                    $query->where(fn($q) => $q->where('name', 'ilike', "%$s%")->orWhere('sku', 'ilike', "%$s%"));
                }
                $products = $query->get();
                $products->each(function($p) use ($config, $id) {
                    $p->tenant_name = $config['name'];
                    $p->tenant_id = $id;
                    $p->preview_url = "http://{$config['domain']}/products/{$p->slug}?preview=true";
                });
                $allProducts = $allProducts->merge($products);
            } catch (\Exception $e) { continue; }
        }
        return $allProducts;
    }
}
</file>

</files>
